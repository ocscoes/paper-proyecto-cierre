# Resultados {data-background-color="#1b241f"}

```{r}
library(pacman)
p_load(dplyr,
       kableExtra,
       knitr,
       tidyr,
       ggplot2,
       lme4,
       janitor,
       texreg,
       sjPlot,
       summarytools,
       lavaan,
       semPlot,
       PerformanceAnalytics,
       stargazer,
       performance,
       ggeffects,
       ggrepel,
       scales,
       plotly)

load("input/proc/micro-macro-merge.rdata")

datos_merge_b <- datos_merge_b |>
  mutate(across(where(haven::is.labelled), ~ vctrs::vec_data(.)),
         pais= as.factor(pais))

datos_merge_b$country_wave = do.call(paste, c(datos_merge_b[c("pais", "ola")], sep = "_"))
```

---

```{r}
#| label: fig-cs
#| fig-cap: Evolución dimensiones Cohesión Social (2004-2023)

olas <- datos_merge_b |>
  group_by(ola) |>
  summarise(horizontal_prom = mean(`cohesion_horizontal_ind`, na.rm=T),
            vertical_prom = mean(`cohesion_vertical_ind`, na.rm=T),
            cohesion_prom = mean(`cohesion_general_ind`, na.rm=T)) |>
  pivot_longer(
    cols = c(horizontal_prom, vertical_prom, cohesion_prom),
    names_to = "indicador",
    values_to = "promedio"
  ) |>
  mutate(indicador = recode(indicador,
                            horizontal_prom = "Cohesión Horizontal",
                            vertical_prom = "Cohesión Vertical",
                            cohesion_prom = "Cohesión Social"))

olas <- olas |> mutate(ola = as.numeric(ola))


plot_ly(
  data = olas,
  x = ~ola,
  y = ~promedio,
  color = ~indicador,
  type = 'scatter',
  mode = 'lines+markers',
  line = list(width = 2)
) |>
  layout(
    xaxis = list(title = "Ola"),
    yaxis = list(title = "Promedio", range = c(0, 10)),
    legend = list(orientation = "h", x = 0.3, y = -0.2),
    margin = list(b = 60, t = 20),
    template = "plotly_white"
  )




```

---

```{r}
#| label: fig-cs-chile
#| fig-cap: Evolución dimensiones Cohesión Social en Chile y América Latina (2004-2023)

# --- 1) Tablas (como ya las venías construyendo) ---
olas_total <- datos_merge_b |>
  group_by(ola) |>
  summarise(
    horizontal_prom = mean(cohesion_horizontal_ind, na.rm = TRUE),
    vertical_prom   = mean(cohesion_vertical_ind,   na.rm = TRUE),
    cohesion_prom   = mean(cohesion_general_ind,    na.rm = TRUE)
  ) |>
  pivot_longer(
    cols = c(horizontal_prom, vertical_prom, cohesion_prom),
    names_to = "indicador",
    values_to = "promedio"
  ) |>
  mutate(indicador = recode(
    indicador,
    horizontal_prom = "Cohesión Horizontal",
    vertical_prom   = "Cohesión Vertical",
    cohesion_prom   = "Cohesión Social"
  ))

pais_destacado <- "Chile"

olas_pais_dest <- datos_merge_b |>
  filter(pais == pais_destacado) |>
  group_by(ola) |>
  summarise(
    horizontal_prom = mean(cohesion_horizontal_ind, na.rm = TRUE),
    vertical_prom   = mean(cohesion_vertical_ind,   na.rm = TRUE),
    cohesion_prom   = mean(cohesion_general_ind,    na.rm = TRUE)
  ) |>
  pivot_longer(
    cols = c(horizontal_prom, vertical_prom, cohesion_prom),
    names_to = "indicador",
    values_to = "promedio"
  ) |>
  mutate(indicador = recode(
    indicador,
    horizontal_prom = "Cohesión Horizontal",
    vertical_prom   = "Cohesión Vertical",
    cohesion_prom   = "Cohesión Social"
  ))

# --- 2) Paleta manual para mantener mismo color por indicador ---
cols <- c(
  "Cohesión Social"     = "#1f77b4",
  "Cohesión Horizontal" = "#2ca02c",
  "Cohesión Vertical"   = "#ff7f0e"
)

# --- 3) Plotly: 3 líneas Total (sólidas) + 3 líneas Chile (punteadas) ---
fig <- plot_ly() |>
  # Total
  add_trace(
    data = filter(olas_total, indicador == "Cohesión Social"),
    x = ~ola, y = ~promedio,
    type = "scatter", mode = "lines+markers",
    line = list(width = 2, color = cols["Cohesión Social"]),
    marker = list(size = 6, color = cols["Cohesión Social"]),
    name = "Cohesión Social — Total",
    hovertemplate = "Indicador: Cohesión Social<br>Ola: %{x}<br>Promedio: %{y:.2f}<extra></extra>"
  ) |>
  add_trace(
    data = filter(olas_total, indicador == "Cohesión Horizontal"),
    x = ~ola, y = ~promedio,
    type = "scatter", mode = "lines+markers",
    line = list(width = 2, color = cols["Cohesión Horizontal"]),
    marker = list(size = 6, color = cols["Cohesión Horizontal"]),
    name = "Cohesión Horizontal — Total",
    hovertemplate = "Indicador: Cohesión Horizontal<br>Ola: %{x}<br>Promedio: %{y:.2f}<extra></extra>"
  ) |>
  add_trace(
    data = filter(olas_total, indicador == "Cohesión Vertical"),
    x = ~ola, y = ~promedio,
    type = "scatter", mode = "lines+markers",
    line = list(width = 2, color = cols["Cohesión Vertical"]),
    marker = list(size = 6, color = cols["Cohesión Vertical"]),
    name = "Cohesión Vertical — Total",
    hovertemplate = "Indicador: Cohesión Vertical<br>Ola: %{x}<br>Promedio: %{y:.2f}<extra></extra>"
  ) |>
  # Chile (punteadas)
  add_trace(
    data = filter(olas_pais_dest, indicador == "Cohesión Social"),
    x = ~ola, y = ~promedio,
    type = "scatter", mode = "lines+markers",
    line = list(width = 3, dash = "dot", color = cols["Cohesión Social"]),
    marker = list(size = 8, symbol = "circle-open", color = cols["Cohesión Social"]),
    name = paste0("Cohesión Social — ", pais_destacado),
    hovertemplate = paste0("Indicador: Cohesión Social — ", pais_destacado,
                           "<br>Ola: %{x}<br>Promedio: %{y:.2f}<extra></extra>")
  ) |>
  add_trace(
    data = filter(olas_pais_dest, indicador == "Cohesión Horizontal"),
    x = ~ola, y = ~promedio,
    type = "scatter", mode = "lines+markers",
    line = list(width = 3, dash = "dot", color = cols["Cohesión Horizontal"]),
    marker = list(size = 8, symbol = "circle-open", color = cols["Cohesión Horizontal"]),
    name = paste0("Cohesión Horizontal — ", pais_destacado),
    hovertemplate = paste0("Indicador: Cohesión Horizontal — ", pais_destacado,
                           "<br>Ola: %{x}<br>Promedio: %{y:.2f}<extra></extra>")
  ) |>
  add_trace(
    data = filter(olas_pais_dest, indicador == "Cohesión Vertical"),
    x = ~ola, y = ~promedio,
    type = "scatter", mode = "lines+markers",
    line = list(width = 3, dash = "dot", color = cols["Cohesión Vertical"]),
    marker = list(size = 8, symbol = "circle-open", color = cols["Cohesión Vertical"]),
    name = paste0("Cohesión Vertical — ", pais_destacado),
    hovertemplate = paste0("Indicador: Cohesión Vertical — ", pais_destacado,
                           "<br>Ola: %{x}<br>Promedio: %{y:.2f}<extra></extra>")
  ) |>
  layout(
    xaxis = list(title = "Ola"),
    yaxis = list(title = "Promedio", range = c(0, 10)),
    legend = list(orientation = "h", x = 0.2, y = -0.2),
    margin = list(b = 70, t = 20),
    template = "plotly_white")

fig

```

## Cohesión Horizontal

```{r}
#| label: fig-ch
#| fig-cap: Evolución dimensiones Cohesión Horizontal (2004-2023)

olas <- datos_merge_b |>
  group_by(ola) |>
  summarise(seguridad_prom = mean(seguridad_ind, na.rm=T),
            confianza_prom = mean(confianza_it_ind, na.rm=T)) |>
  pivot_longer(
    cols = c(confianza_prom, seguridad_prom),
    names_to = "indicador",
    values_to = "promedio"
  ) |>
  mutate(indicador = recode(indicador,
                            "confianza_prom" = "Confianza Interpersonal",
                            "seguridad_prom" = "Seguridad Pública"))

cols <- c(
  "Confianza Interpersonal"     = "#1f77b4",
  "Seguridad Pública"   = "#ff7f0e"
)

plot_ly(
  data = olas,
  x = ~ola,
  y = ~promedio,
  color = ~indicador,
  colors = cols,
  type = 'scatter',
  mode = 'lines+markers',
  line = list(width = 2)
) |>
  layout(
    xaxis = list(title = "Ola"),
    yaxis = list(title = "Promedio", range = c(0, 10)),
    legend = list(orientation = "h", x = 0.3, y = -0.2),
    margin = list(b = 60, t = 20),
    template = "plotly_white"
  )




```

------------------------------------------------------------------------

```{r}
#| label: fig-ch-chile
#| fig-cap: Evolución dimensiones Cohesión Horizontal en Chile y América Latina (2004-2023)

olas_chile <- datos_merge_b |>
  filter(pais=="Chile") |>
  group_by(ola) |>
  summarise(seguridad_prom = mean(seguridad_ind, na.rm=T),
            confianza_prom = mean(confianza_it_ind, na.rm=T)) |>
  pivot_longer(
    cols = c(confianza_prom, seguridad_prom),
    names_to = "indicador",
    values_to = "promedio"
  ) |>
  mutate(indicador = recode(indicador,
                            "confianza_prom" = "Confianza Interpersonal",
                            "seguridad_prom" = "Seguridad Pública"))

fig <- plot_ly() |>
  # Total
  add_trace(
    data = filter(olas, indicador == "Confianza Interpersonal"),
    x = ~ola, y = ~promedio,
    type = "scatter", mode = "lines+markers",
    line = list(width = 2, color = cols["Confianza Interpersonal"]),
    marker = list(size = 6, color = cols["Confianza Interpersonal"]),
    name = "Confianza Interpersonal — Total",
    hovertemplate = "Indicador: Confianza Interpersonal<br>Ola: %{x}<br>Promedio: %{y:.2f}<extra></extra>"
  ) |>
  add_trace(
    data = filter(olas, indicador == "Seguridad Pública"),
    x = ~ola, y = ~promedio,
    type = "scatter", mode = "lines+markers",
    line = list(width = 2, color = cols["Seguridad Pública"]),
    marker = list(size = 6, color = cols["Seguridad Pública"]),
    name = "Seguridad Pública — Total",
    hovertemplate = "Indicador: Seguridad Pública<br>Ola: %{x}<br>Promedio: %{y:.2f}<extra></extra>"
  ) |>
  # Chile (punteadas)
  add_trace(
    data = filter(olas_chile, indicador == "Confianza Interpersonal"),
    x = ~ola, y = ~promedio,
    type = "scatter", mode = "lines+markers",
    line = list(width = 3, dash = "dot", color = cols["Confianza Interpersonal"]),
    marker = list(size = 8, symbol = "circle-open", color = cols["Confianza Interpersonal"]),
    name = paste0("Confianza Interpersonal — ", pais_destacado),
    hovertemplate = paste0("Indicador: Confianza Interpersonal — ", pais_destacado,
                           "<br>Ola: %{x}<br>Promedio: %{y:.2f}<extra></extra>")
  ) |>
  add_trace(
    data = filter(olas_chile, indicador == "Seguridad Pública"),
    x = ~ola, y = ~promedio,
    type = "scatter", mode = "lines+markers",
    line = list(width = 3, dash = "dot", color = cols["Seguridad Pública"]),
    marker = list(size = 8, symbol = "circle-open", color = cols["Seguridad Pública"]),
    name = paste0("Seguridad Pública — ", pais_destacado),
    hovertemplate = paste0("Indicador: Seguridad Pública — ", pais_destacado,
                           "<br>Ola: %{x}<br>Promedio: %{y:.2f}<extra></extra>")
  )  |>
  layout(
    xaxis = list(title = "Ola"),
    yaxis = list(title = "Promedio", range = c(0, 10)),
    legend = list(orientation = "h", x = 0.2, y = -0.2),
    margin = list(b = 70, t = 20),
    template = "plotly_white")

fig
```

------------------------------------------------------------------------


```{r}
#| label: fig-cv
#| fig-cap: Evolución dimensiones Cohesión Vertical en América Latina (2004-2023)

olas <- datos_merge_b |>
  group_by(ola) |>
  summarise(confianza_prom = mean(confianza_inst_ind, na.rm=T),
            democracia_prom = mean(democracia_ind, na.rm=T)) |>
  pivot_longer(
    cols = c(confianza_prom, democracia_prom),
    names_to = "indicador",
    values_to = "promedio"
  ) |>
  mutate(indicador = recode(indicador,
                            "confianza_prom" = "Confianza en las Instituciones",
                            "democracia_prom" = "Actitudes hacia la democracia"))

cols <- c(
  "Confianza en las Instituciones" = "#1f77b4",
  "Actitudes hacia la democracia"   = "#ff7f0e"
)

plot_ly(
  data = olas,
  x = ~ola,
  y = ~promedio,
  color = ~indicador,
  colors = cols,
  type = 'scatter',
  mode = 'lines+markers',
  line = list(width = 2)
) |>
  layout(
    xaxis = list(title = "Ola"),
    yaxis = list(title = "Promedio", range = c(0, 10)),
    legend = list(orientation = "h", x = 0.3, y = -0.2),
    margin = list(b = 60, t = 20),
    template = "plotly_white"
  )
```

------------------------------------------------------------------------

```{r}
#| label: fig-cv-chile
#| fig-cap: Evolución dimensiones Cohesión Vertical en Chile y América Latina (2004-2023)

olas_chile <- datos_merge_b |>
  filter(pais=="Chile") |>
  group_by(ola) |>
  summarise(confianza_prom = mean(confianza_inst_ind, na.rm=T),
            democracia_prom = mean(democracia_ind, na.rm=T)) |>
  pivot_longer(
    cols = c(confianza_prom, democracia_prom),
    names_to = "indicador",
    values_to = "promedio"
  ) |>
  mutate(indicador = recode(indicador,
                            "confianza_prom" = "Confianza en las Instituciones",
                            "democracia_prom" = "Actitudes hacia la democracia"))

fig <- plot_ly() |>
  # Total
  add_trace(
    data = filter(olas, indicador == "Confianza en las Instituciones"),
    x = ~ola, y = ~promedio,
    type = "scatter", mode = "lines+markers",
    line = list(width = 2, color = cols["Confianza en las Instituciones"]),
    marker = list(size = 6, color = cols["Confianza en las Instituciones"]),
    name = "Confianza en las Instituciones — Total",
    hovertemplate = "Indicador: Confianza en las Instituciones<br>Ola: %{x}<br>Promedio: %{y:.2f}<extra></extra>"
  ) |>
  add_trace(
    data = filter(olas, indicador == "Actitudes hacia la democracia"),
    x = ~ola, y = ~promedio,
    type = "scatter", mode = "lines+markers",
    line = list(width = 2, color = cols["Actitudes hacia la democracia"]),
    marker = list(size = 6, color = cols["Actitudes hacia la democracia"]),
    name = "Actitudes hacia la democracia — Total",
    hovertemplate = "Indicador: Actitudes hacia la democracia<br>Ola: %{x}<br>Promedio: %{y:.2f}<extra></extra>"
  ) |>
  # Chile (punteadas)
  add_trace(
    data = filter(olas_chile, indicador == "Confianza en las Instituciones"),
    x = ~ola, y = ~promedio,
    type = "scatter", mode = "lines+markers",
    line = list(width = 3, dash = "dot", color = cols["Confianza en las Instituciones"]),
    marker = list(size = 8, symbol = "circle-open", color = cols["Confianza en las Instituciones"]),
    name = paste0("Confianza en las Instituciones — ", pais_destacado),
    hovertemplate = paste0("Indicador: Confianza en las Instituciones — ", pais_destacado,
                           "<br>Ola: %{x}<br>Promedio: %{y:.2f}<extra></extra>")
  ) |>
  add_trace(
    data = filter(olas_chile, indicador == "Actitudes hacia la democracia"),
    x = ~ola, y = ~promedio,
    type = "scatter", mode = "lines+markers",
    line = list(width = 3, dash = "dot", color = cols["Actitudes hacia la democracia"]),
    marker = list(size = 8, symbol = "circle-open", color = cols["Actitudes hacia la democracia"]),
    name = paste0("Actitudes hacia la democracia — ", pais_destacado),
    hovertemplate = paste0("Indicador: Actitudes hacia la democracia — ", pais_destacado,
                           "<br>Ola: %{x}<br>Promedio: %{y:.2f}<extra></extra>")
  )  |>
  layout(
    xaxis = list(title = "Ola"),
    yaxis = list(title = "Promedio", range = c(0, 10)),
    legend = list(orientation = "h", x = 0.2, y = -0.2),
    margin = list(b = 70, t = 20),
    template = "plotly_white")

fig
```
# Modelo Multinivel

```{r}
#| label: preparacion-datos

## Estandarizar continuos tras separar W/B (recomendado)
z <- function(x) as.numeric(scale(x))

datos_fit <- datos_merge_b %>%
  mutate(
    pib_we  = z(pib_we),   gini_we = z(gini_we), wgi_we = z(wgi_we), dem_we = z(dem_we),
    mig_we  = z(mig_we),   edu_we = z(edu_we),
    pib_be  = z(pib_be),   gini_be = z(gini_be), wgi_be = z(wgi_be), dem_be = z(dem_be),
    mig_be  = z(mig_be),   edu_be = z(edu_be),
    edad_c = scale(edad) %>% as.numeric(),
    ola_s = as.numeric(scale(ola, center = TRUE, scale = TRUE)),
    nivel_educ   = forcats::fct_drop(factor(nivel_educ)),
    sexo         = forcats::fct_drop(factor(sexo)),
    pos_politica = forcats::fct_drop(factor(pos_politica)),
    pais         = forcats::fct_drop(factor(pais)),
    country_wave = forcats::fct_drop(factor(country_wave))
  ) |>
  select(cohesion_general_ind, cohesion_vertical_ind, cohesion_horizontal_ind,
         nivel_educ, sexo, edad_c, ola_s, pos_politica,
         pib_we, gini_we, dem_we, wgi_we, mig_we, edu_we,
         pib_be, gini_be, dem_be, wgi_be, mig_be, edu_be,
         country_wave, pais, wt) |> na.omit()
```

---

```{r}


mh <- lmer(cohesion_horizontal_ind ~ 1 + factor(nivel_educ) + factor(sexo) + edad_c + I(edad_c^2) + factor(pos_politica) + ola_s + 
pib_we + gini_we + dem_we + wgi_we + mig_we + edu_we +
pib_be + gini_be + dem_be + wgi_be + mig_be + edu_be +
mig_we:wgi_be +
edu_be:gini_be +
  edu_be:gini_we +
(1 + pib_we | country_wave) + (1 | pais), data= datos_fit, weights= wt)

mv <- lmer(cohesion_vertical_ind ~ 1 + factor(nivel_educ) + factor(sexo) + edad_c + I(edad_c^2) + factor(pos_politica) + ola_s + 
pib_we + gini_we + dem_we + wgi_we + mig_we + edu_we +
pib_be + gini_be + dem_be + wgi_be + mig_be + edu_be +
mig_we:wgi_be +
edu_be:gini_be +
  edu_be:gini_we +
(1 | country_wave) + (1 | pais), data= datos_fit, weights= wt)

mc <- lmer(cohesion_general_ind ~ 1 + factor(nivel_educ) + factor(sexo) + edad_c + I(edad_c^2) + factor(pos_politica) + ola_s + 
pib_we + gini_we + dem_we + wgi_we + mig_we + edu_we +
pib_be + gini_be + dem_be + wgi_be + mig_be + edu_be +
mig_we:wgi_be +
edu_be:gini_be +
  edu_be:gini_we +
(1 | country_wave) + (1 | pais), data= datos_fit, weights= wt)

save(mh, file="output/modelo_horizontal.rdata")
save(mv, file="output/modelo_vertical.rdata")
save(mc, file= "output/modelo_completo.rdata")

```

```{r}
#| label: fig-coef
#| fig-cap: Coeficientes Modelos de Cohesión Social

# load("output/modelo_horizontal.rdata")
# load("output/modelo_vertical.rdata")
# load("output/modelo_completo.rdata")

# sjPlot::tab_model(mh, mv, mc,
#                   show.ci = FALSE)

p <- sjPlot::plot_models(mh, mv, mc,
                    grid  = T,
                    rm.terms = c("pib_we",
                                 "I(edad_c^2)",
                                 "gini_we",
                                 "edu_we",
                                 "pib_be",
                                 "dem_be",
                                 "mig_be",
                                 "gini_be:edu_be",
                                 "gini_we:edu_be",
                                 "ola_s:mig_be",
                                 "ola_s:wgi_we",
                                 "wgi_we",
                                 "mig_we:wgi_be"),
                    m.labels= c("Cohesión Horizontal",
                                "Cohesión Vertical",
                                "Cohesión Social"),
                    axis.labels =
                      c("Pob. Educ. Terciaria (between)",
                            "Gobernanza (between)",
                            "Gini (between)",
                            "Pob. Migrante (within)",
                            "Democracia (within)",
                          "Ola",
                        "Sin posicion (ref=Izq.)",
                        "Derecha (ref=Izq.)",
                        "Centro (ref=Izq.)",
                        "Edad",
                        "Hombre (ref=Mujer)",
                        "Educ. Terciaria (ref=Primaria)",
                        "Educ. Secundaria (ref=Primaria)"),
                    show.p = T,
                    show.legend = F,
                    show.values = T
                    )


p +
  labs(
    caption = "Nota: Se muestran solo los efectos estadísticamente significativos. \n* p < 0.05; ** p < 0.01; *** p < 0.001"
  ) +
  theme_minimal(base_size = 11) +
  theme(
    plot.caption = element_text(hjust = 0, face = "italic", size = 9),
    axis.text = element_text(size = 10))

```

## Discusión

- El análisis evidencia un descenso significativo en los niveles de cohesión social en América Latina durante las últimas dos décadas, tanto en su dimensión horizontal como en la vertical.

- Chile ilustra claramente esta tendencia: en la última década se observan caídas pronunciadas en indicadores como la Seguridad Pública, la Confianza Interpersonal y la Confianza en las Instituciones.

----

- Los modelos multinivel muestran que factores individuales como el nivel educativo, la edad y la posición política inciden de manera significativa sobre la cohesión social.

- No se observa un efecto significativo del desarrollo económico (PIB per cápita) sobre la cohesión social; sin embargo, la evidencia sí apunta a que los países más desiguales presentan menores niveles de cohesión social.

---

- De manera contraintuitiva, los países con una mayor proporción de población con educación terciaria tienden a exhibir niveles más bajos de cohesión social.

- Las caídas en la calidad democrática se asocian significativamente con menores niveles de cohesión social, mientras que mejores niveles de gobernanza se vinculan a mayor cohesión.

- Finalmente, el aumento de la población migrante se relaciona con menor cohesión horizontal, aunque muestra un efecto neutro en la cohesión vertical.

## Lo que sigue

- Profundizar en el análisis de los determinantes macroestructurales de la cohesión social en América Latina:
   - Probar interacciones que no hayan sido incluidas en el modelo
   - Explorar las pendientes aleatorias de algunas variables de interés
   
- Explorar hipótesis para los resultados no esperados del análisis. ¿Porqué mayores niveles de educación y de democracia pueden estar asociados a menores niveles de cohesión social?


