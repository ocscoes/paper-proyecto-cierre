---
output: html_document
editor_options: 
  chunk_output_type: console
execute:
  echo: FALSE 
  warning: false
---

<!-- Please run the following chunks before running the models  -->

```{r}
#| echo: false
## cargar base
library(tidyverse)
load("input/proc/micro-macro-merge.rdata")

datos_merge <- datos_merge |>
  mutate(across(where(haven::is.labelled), ~ vctrs::vec_data(.)),
         pais= as.factor(pais))

datos_merge$country_wave = do.call(paste, c(datos_merge[c("pais", "ola")], sep = "_"))
```

```{r data-fig-macro}
set1 <-  RColorBrewer::brewer.pal(n = 8, name = "Set1")
options(ggplot2.discrete.fill = set1)
options(ggplot2.discrete.colour = set1)
ggplot2::theme_set(ggplot2::theme_bw())
ggplot2::theme_update(text=ggplot2::element_text(size=15,  family="serif"))    
options(scipen=999)
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,ggplot2,haven,ggrepel,gridExtra,grid)  
rm(list=ls())

load("input/proc/micro-macro-merge.rdata")

datos_merge <- datos_merge |>
  mutate(across(where(haven::is.labelled), ~ vctrs::vec_data(.)),
         pais= as.factor(pais))

datos_merge$country_wave = do.call(paste, c(datos_merge[c("pais", "ola")], sep = "_"))

wid_data <- haven::read_dta(file = "input/proc/wid_data.dta")
wid_data <- wid_data %>% mutate(yr2=substr(year, 3, 4)) %>% rename(iso2c=country)
datos_merge$iso2c<- countrycode::countrycode(sourcevar = datos_merge$pais,origin = "country.name",destination = "iso2c")
wid_data$iso2c <- as.character(wid_data$iso2c)
datos_merge$yr2<- substr(datos_merge$ola, 3, 4)

frhouse <- read.csv("input/orig/freedom-score-fh.csv")
frhouse<- 
frhouse %>% select(country=Entity,iso3c=Code,year=Year,frhouse=Total.democracy.score) %>% 
  mutate(iso2c =countrycode::countrycode(sourcevar = iso3c,origin = "iso3c",destination = "iso2c")) %>% 
  mutate(yr2 = substr(year, 3, 4)) %>% 
  filter(iso2c %in% datos_merge$iso2c)
  
datos_merge<- 
left_join(x = datos_merge,y = wid_data[,c("iso2c","yr2","wid_gini_disp")],
          by =c("iso2c","yr2"))

datos_merge<- 
left_join(x = datos_merge,y = frhouse[,c("iso2c","yr2","frhouse")],
          by =c("iso2c","yr2"))

datos_macro <- datos_merge %>%
  mutate(
   cohesion_horizontal,
      cohesion_vertical,
      cohesion_general,
      gini_index,
      wid_gini_disp,  
      pib_per_capita_ppa,
      log_pib_per_capita_ppa,
      percent_pob_migrante,
      indice_v_dem,
      regulatory_quality,
      voice_and_accountability,
      wgi,
     frhouse, 
    edad_c = scale(edad) %>% as.numeric(),
    ola_s = as.numeric(scale(ola, center = TRUE, scale = TRUE)),
   income_decile,
    ola,
    nivel_educ   = forcats::fct_drop(factor(nivel_educ)),
    pos_politica = forcats::fct_drop(factor(pos_politica)),
    sexo         = forcats::fct_drop(factor(sexo)),
    pais         = forcats::fct_drop(factor(pais)),
    country_wave = forcats::fct_drop(factor(country_wave))
  ) %>% 
    select(cohesion_horizontal,
      cohesion_vertical,
      cohesion_general,
      gini_index,wid_gini_disp,
      pib_per_capita_ppa,
      log_pib_per_capita_ppa,
      percent_pob_migrante,
      indice_v_dem,
      regulatory_quality,
      voice_and_accountability,wgi,frhouse,
      income_decile,escolaridad,
         nivel_educ, sexo, edad_c, ola_s,ola, pos_politica,iso2c,
         country_wave, pais, wt)

# dim(datos_macro);dim(na.omit(datos_macro))
datos_macro$yr2<- substr(datos_macro$ola, 3, 4)

df_sum <- datos_macro %>%
  group_by(iso2c, yr2) %>%
  summarise(across(
    c(cohesion_horizontal,
      cohesion_vertical,
      cohesion_general,
      gini_index,wid_gini_disp,
      pib_per_capita_ppa,
      log_pib_per_capita_ppa,
      percent_pob_migrante,
      indice_v_dem,frhouse,
      wgi),
    mean,
    na.rm = TRUE
  )) %>%
  ungroup() 
df_sum <- 
 df_sum %>% 
  group_by(iso2c) %>%
  mutate(across(
    c(cohesion_horizontal,
      cohesion_vertical,
      cohesion_general,
      gini_index,wid_gini_disp,
      pib_per_capita_ppa,
      log_pib_per_capita_ppa,
      percent_pob_migrante,
      indice_v_dem,frhouse,
      wgi),
    mean,
    na.rm = TRUE,
    .names = "mid_{.col}"
  )) %>%
  ungroup()

df_sum$ctyear <- paste0(df_sum$iso2c,df_sum$yr2)
```

# Results

## Confirmatory Factor Analysis

```{r fit-cfa-prep}
library(lavaan)
library(texreg)

# confianza_it_ind     = row_mean_if_complete(cur_data(), c("it1"), 1L),
# seguridad_ind        = row_mean_if_complete(cur_data(), c("aoj11","vic1ext"), 2L),
# confianza_inst_ind   = row_mean_if_complete(cur_data(), c("b13","b21","b31"), 2L),  
# democracia_ind       = row_mean_if_complete(cur_data(), c("ing4","pn4"), 2L)        
load("input/proc/micro-macro-merge.rdata")
load("input/proc/datos-fit.rdata")

datos_fit <- datos_fit |>
  select(-escolaridad) |> na.omit()


vars <- datos_merge |> 
  ungroup() |>
  select("aoj11","vic1ext","it1","b13","b21","b31","ing4","pn4", "id_row",
         "seguridad_ind", "confianza_it_ind", "confianza_inst_ind", "democracia_ind")


datos_cfa <- datos_fit |> left_join(vars, by="id_row") 

# m1 <- '
# seguridad_ind =~ aoj11+vic1ext
# # confianza_it_ind =~ it1
# confianza_inst_ind =~ b13+b21+b31
# democracia_ind =~ ing4+pn4
# 
# ch =~ seguridad_ind + it1
# cv =~ confianza_inst_ind + democracia_ind
# cg =~ ch+ cv
# '
# m1_cfa <- cfa(m1, data = datos_cfa[,c("aoj11","vic1ext","it1","b13","b21","b31","ing4","pn4","pais")],cluster = "pais")
# screenreg(m1_cfa)
# semPlot::semPaths(m1_cfa,what = "std")
# fitmeasures(m1_cfa, fit.measures = c("rmsea", "cfi", "chisq", "pvalue", "df"))
# save(m1_cfa, file="output/cfa.rdata")
```

```{r}
#| label: fig-afc
#| fig-width: 10
#| fig-height: 5
#| fig-cap: Confirmatory Factor Analysis for Social Cohesion Measurement Model
set1 <-  RColorBrewer::brewer.pal(n = 8, name = "Set1")
options(ggplot2.discrete.fill = set1)
options(ggplot2.discrete.colour = set1)
ggplot2::theme_set(ggplot2::theme_bw())
ggplot2::theme_update(text=ggplot2::element_text(size=15,  family="serif"))  

library(semPlot)
library(tidySEM)
library(lavaan)
library(ggplot2)

m1 <- '
  ch =~ seguridad_ind + confianza_it_ind
  cv =~ confianza_inst_ind + democracia_ind
'

datos_cfa <- datos_cfa %>% filter(!pais %in% c("Canada","United States","Trinidad & Tobago"))
m1_cfa <- cfa(m1, data = datos_cfa)
# summary(m1_cfa, standardized = TRUE, fit.measures = TRUE)

fit <- fitmeasures(m1_cfa, fit.measures = c("rmsea", "cfi", "chisq", "pvalue", "df"))

# ?graph_sem(m1_cfa)

fit_edges<- get_edges(m1_cfa)
fit_edges$label <- fit_edges$est_sig_std

fit_nodes<- get_nodes(m1_cfa)
fit_nodes$label <- c("Horizontal","Vertical",
                     "Public \nSecurity","Interpersonal\nTrust",
                     "Institutional\nTrust","Democratic \nAttitudes")

fit_layout<- get_layout("","ch","",  "","cv"," ",
                  "confianza_it_ind","","seguridad_ind",
                  "democracia_ind","","confianza_inst_ind", rows = 2)


fit_layout<- get_layout("confianza_it_ind","","", "democracia_ind",
                        "","ch","cv","",
                        "seguridad_ind" ,"","", "confianza_inst_ind", rows = 3)

fit_nodes$label_size = 4
fit_nodes$label_family = "serif"
graph_sem(m1_cfa,edges = fit_edges,layout=fit_layout,nodes=fit_nodes) + 
  labs(caption = paste0(
  "Note: RMSEA = ", round(fit["rmsea"], 3),
  ", CFI = ", round(fit["cfi"], 3),
  ", χ² = ", round(fit["chisq"], 2),
  ", df = ", fit["df"],
  ", p-value = ", format(round(fit["pvalue"], 4), nsmall = 3),
  ", N = ",format(nobs(m1_cfa), big.mark = ",", scientific = FALSE)
))

```


@fig-afc reports the confirmatory factor analysis for the proposed two-factor measurement model. At first, overall fit appears strong (RMSEA = 0.03; CFI=0.0996). However, these indices should be interpreted with caution, given that including only two indicators per factor results in the model being just overidentified (df=1), which limits the diagnostic value of global fit measures. 

Standardized factor loading are moderate. For Horizontal Cohesion, loadings range from 0.44 to 0.49, and for Vertical Cohesion from 0.56 to 0.58. The latent correlation between both factors is also moderate (r = 0.51), implying related but empirically distinguishable dimensions. Following Dickes and Valentova [-@dickes_construction_2013], this pattern supports interpretation of social cohesion as a multidimensional construct. However, the statement that a single composite indicator is "not possible" [-@dickes_construction_2013, p. 836] might be discussed. Empirically, the moderate latent correlation observed here suggest a shared component that could justify, on pragmatic grounds, a composite summary for descriptive purposes. Nevertheless, such composite cannot be treated as evidence of unidimensionality nor a higher-order general factor. Accordingly, subsequent analyses will primarily treat Vertical and Horizontal dimensions as separate construct, with any exceptions explicitly noted. 



## Descriptives


```{r}
#| label: fig-cs
#| fig-cap: Evolution of vertical and horizontal cohesion (2004-2023)

library(ggbreak)

olas <- datos_fit |>
  filter(!pais %in% c("Canada", "United States")) |>
   group_by(ola) |>
  summarise(horizontal_prom = mean(`cohesion_horizontal_ind`, na.rm=T),
            vertical_prom = mean(`cohesion_vertical_ind`, na.rm=T)) |>
  pivot_longer(
    cols = c(horizontal_prom, vertical_prom),
    names_to = "indicador",
    values_to = "promedio"
  ) |>
  mutate(indicador = dplyr::recode(indicador,
                            horizontal_prom = "Horizontal Cohesion",
                            vertical_prom = "Vertical Cohesion"))

 # dif <- datos_fit |>
 #  filter(!pais %in% c("Canada", "United States")) |>
 #  group_by(ola) |>
 #  summarise(
 #    horizontal_prom = mean(cohesion_horizontal_ind, na.rm = TRUE),
 #    vertical_prom   = mean(cohesion_vertical_ind,   na.rm = TRUE),
 #    diferencia_h_v  = horizontal_prom - vertical_prom,
 #    .groups = "drop"
 #  ) |>
 #   summarise(mean(diferencia_h_v))
 # 
 # dif

olas$ola <- factor(olas$ola)
p<- olas |>
  ggplot(aes(x = ola, y = promedio, color = indicador,group = indicador)) +
  geom_line(linewidth = 1) +
  geom_point() +
  scale_y_continuous(limits = c(0,8))+
  labs(x = "Wave", y = "Social cohesion (1-10)", color = NULL) +
  theme_minimal() +
  theme(legend.position = "bottom")

plot_cs <- p + scale_y_cut(breaks=c(3.5), which= c(1,2), scales=c(3, 0.5))


plot_cs
```

@fig-cs shows the averages for each year for the different types of cohesion. First, we observed that horizontal cohesion maintained an upward trend between until 2012, reaching 6.54 (out of 10) that year. After that, horizontal cohesion faced a sustained decline until 2018, with a regional mean of 5.93, before rebounding to somewhat similar levels as 2004 (6.17).

Meanwhile, vertical cohesion show a similar trends, with a persistente trends overt time until 2010, when it suffered a sharp decline. Between 2010 and 2016, the regional mean went from 5.24 to 4.44. After that, the index showed a slight increase, reaching 4.63 in 2023. 

Across the entire period under study, horizontal cohesion remains consistently higher than vertical cohesion, with an average gap of 1.38 points. This persistent difference may reflect the structural and enduring institutional weaknesses present in many Latin American states, which might tend to reinforce the role of interpersonal relationships, family ties, and informal networks as key resources for facing social life [@araujo_institutional_2014;@brinks_political_2020].

At first glance, these trends appear closely aligned with the broader political, economic, and social context of Latin America over the period analyzed. The upward trajectories observed until 2010–2012 coincide with the commodities boom, during which rising prices of commodities such as oil, copper, and agricultural products—driven largely by demand from emerging economies—supported sustained economic growth in the region. This favorable context was leveraged by progressive and populist governments to implement redistributive policies, contributing to notable reductions in poverty and income inequality across several countries [@sanchez-ancochea_surprising_2021].

Following the slowdown of the Chinese economy around 2012 and the subsequent end of the commodities boom, many Latin American countries entered a period of economic, political and social struggles, which might be reflected in the decline of both dimensions of cohesion. Meanwhile, the slight rebound observed in 2023 may be interpreted as a process of social and political recomposition in the aftermath of the COVID-19 pandemic, during which the expansion of state support and the reinforcement of solidarity mechanisms may have partially mitigated previous erosions of social cohesion.

<!-- [^3]: It should be noted that social cohesion (green line) is the average of vertical and horizontal cohesion, which is why its interpretation is not detailed. -->


## Relationship between and within country level factors with social cohesión

```{r fig-macro}
#| fig-width: 12
#| fig-height: 22
#| fig-cap: "Country-level association of macro-level factors and social cohesion. Red line represents the association including Canada and United States."
#| cache: true
library(ggrepel)

df_sum_la <-  df_sum %>% filter(!iso2c %in% c("US","CA"))
df_sum <- df_sum %>% filter(!iso2c=="TT")

fig_gini_h <-
  ggplot() +
  geom_smooth(data = df_sum, method = lm, se = FALSE,
              aes(mid_wid_gini_disp, y = mid_cohesion_horizontal),
              color = "red",size=0.5) +
  geom_smooth(data = df_sum_la, method = lm, se = FALSE,
              aes(mid_wid_gini_disp, y = mid_cohesion_horizontal,fullrange=T),
              color = "black",fullrange=T) +
  geom_smooth(data = df_sum,
              aes(x = wid_gini_disp, y = cohesion_horizontal, color = iso2c, shape = iso2c),
              method = "lm", se = FALSE, color = "black",size=0.1) +
  geom_label(data = df_sum, aes(x = mid_wid_gini_disp, y = mid_cohesion_horizontal, label = iso2c),size=2.5) +
  scale_y_continuous(limits = c(2,8))+  
  labs(x = "Economic Inequality", y = " ", title = "Horizontal Cohesion") +
  annotate("label",
           x = Inf, y = -Inf,               
           hjust = 1.08, vjust = -1,      
           label = paste0("r = ", round(cor(df_sum$mid_wid_gini_disp,df_sum$mid_cohesion_horizontal,use = "complete.obs"), 2)),
           fill = "white",                 
           color = "red",                
           label.size = 0.25,family = "serif",
           size = 3.5)+
  annotate("label",
           x = Inf, y = -Inf,               
           hjust = 1.08, vjust = -3,      
           label = paste0("r = ", round(cor(df_sum_la$mid_wid_gini_disp,df_sum_la$mid_cohesion_horizontal,use = "complete.obs"), 2)),
           fill = "white",                 
           color = "black",                
           label.size = 0.25,family = "serif",
           size = 3.5) 

fig_gdp_h <-
  ggplot() +
  geom_smooth(data = df_sum, method = lm, se = FALSE,
              aes(mid_pib_per_capita_ppa, y = mid_cohesion_horizontal),
              color = "red", size = 0.5,fullrange = TRUE) +
  geom_smooth(data = df_sum_la, method = lm, se = FALSE, fullrange = TRUE,
              aes(mid_pib_per_capita_ppa, y = mid_cohesion_horizontal),
              color = "black") +
  geom_smooth(data = df_sum,
              aes(x = pib_per_capita_ppa,
                  y = cohesion_horizontal,
                  color = iso2c,
                  shape = iso2c),
              method = "lm", se = FALSE,
              color = "black", size = 0.1) +
  geom_label(data = df_sum,
             aes(x = mid_pib_per_capita_ppa,
                 y = mid_cohesion_horizontal,
                 label = iso2c),
             size = 2.5) +
  scale_y_continuous(limits = c(2, 8)) +
  labs(x = "GDP per Capita (PPP)", y = " ", title = "") +
  annotate("label",
           x = Inf, y = -Inf,
           hjust = 1.08, vjust = -1,
           label = paste0("r = ",
                          round(cor(df_sum$mid_pib_per_capita_ppa,
                                    df_sum$mid_cohesion_horizontal,
                                    use = "complete.obs"), 2)),
           fill = "white", color = "red",
           label.size = 0.25, family = "serif", size = 3.5) +
  annotate("label",
           x = Inf, y = -Inf,
           hjust = 1.08, vjust = -3,
           label = paste0("r = ",
                          round(cor(df_sum_la$mid_pib_per_capita_ppa,
                                    df_sum_la$mid_cohesion_horizontal,
                                    use = "complete.obs"), 2)),
           fill = "white", color = "black",
           label.size = 0.25, family = "serif", size = 3.5)


fig_mig_h <-
  ggplot() +
  geom_smooth(data = df_sum, method = lm, se = FALSE, fullrange = TRUE,
              aes(mid_percent_pob_migrante, y = mid_cohesion_horizontal),
              color = "red", size = 0.5) +
  geom_smooth(data = df_sum_la, method = lm, se = FALSE, fullrange = TRUE,
              aes(mid_percent_pob_migrante, y = mid_cohesion_horizontal),
              color = "black") +
  geom_smooth(data = df_sum, method = "lm", se = FALSE,
              aes(x = percent_pob_migrante, y = cohesion_horizontal,
                  color = iso2c, shape = iso2c),
              color = "black", size = 0.1) +
  geom_label(data = df_sum,
             aes(x = mid_percent_pob_migrante,
                 y = mid_cohesion_horizontal,
                 label = iso2c),
             size = 2.5) +
  scale_y_continuous(limits = c(2, 8)) +
  labs(x = "Migrant Population (%)", y = " ", title = "") +
  annotate("label", x = Inf, y = -Inf, hjust = 1.08, vjust = -1,
           label = paste0("r = ",
                          round(cor(df_sum$mid_percent_pob_migrante,
                                    df_sum$mid_cohesion_horizontal,
                                    use = "complete.obs"), 2)),
           fill = "white", color = "red",
           label.size = 0.25, family = "serif", size = 3.5) +
  annotate("label", x = Inf, y = -Inf, hjust = 1.08, vjust = -3,
           label = paste0("r = ",
                          round(cor(df_sum_la$mid_percent_pob_migrante,
                                    df_sum_la$mid_cohesion_horizontal,
                                    use = "complete.obs"), 2)),
           fill = "white", color = "black",
           label.size = 0.25, family = "serif", size = 3.5)


fig_vdem_h <-
  ggplot() +
  geom_smooth(data = df_sum, method = lm, se = FALSE, fullrange = TRUE,
              aes(mid_indice_v_dem, y = mid_cohesion_horizontal),
              color = "red", size = 0.5) +
  geom_smooth(data = df_sum_la, method = lm, se = FALSE, fullrange = TRUE,
              aes(mid_indice_v_dem, y = mid_cohesion_horizontal),
              color = "black") +
  geom_smooth(data = df_sum, method = "lm", se = FALSE,
              aes(x = indice_v_dem, y = cohesion_horizontal,
                  color = iso2c, shape = iso2c),
              color = "black", size = 0.1) +
  geom_label(data = df_sum,
             aes(x = mid_indice_v_dem,
                 y = mid_cohesion_horizontal,
                 label = iso2c),
             size = 2.5) +
  scale_y_continuous(limits = c(2, 8)) +
  labs(x = "Democracy", y = " ", title = "") +
  annotate("label", x = Inf, y = -Inf, hjust = 1.08, vjust = -1,
           label = paste0("r = ",
                          round(cor(df_sum$mid_indice_v_dem,
                                    df_sum$mid_cohesion_horizontal,
                                    use = "complete.obs"), 2)),
           fill = "white", color = "red",
           label.size = 0.25, family = "serif", size = 3.5) +
  annotate("label", x = Inf, y = -Inf, hjust = 1.08, vjust = -3,
           label = paste0("r = ",
                          round(cor(df_sum_la$mid_indice_v_dem,
                                    df_sum_la$mid_cohesion_horizontal,
                                    use = "complete.obs"), 2)),
           fill = "white", color = "black",
           label.size = 0.25, family = "serif", size = 3.5)


fig_wdi_h <-
  ggplot() +
  geom_smooth(data = df_sum, method = lm, se = FALSE, fullrange = TRUE,
              aes(mid_wgi, y = mid_cohesion_horizontal),
              color = "red", size = 0.5) +
  geom_smooth(data = df_sum_la, method = lm, se = FALSE, fullrange = TRUE,
              aes(mid_wgi, y = mid_cohesion_horizontal),
              color = "black") +
  geom_smooth(data = df_sum, method = "lm", se = FALSE,
              aes(x = wgi, y = cohesion_horizontal,
                  color = iso2c, shape = iso2c),
              color = "black", size = 0.1) +
  geom_label(data = df_sum,
             aes(x = mid_wgi,
                 y = mid_cohesion_horizontal,
                 label = iso2c),
             size = 2.5) +
  scale_y_continuous(limits = c(2, 8)) +
  labs(x = "Governance", y = " ", title = "") +
  annotate("label", x = Inf, y = -Inf, hjust = 1.08, vjust = -1,
           label = paste0("r = ",
                          round(cor(df_sum$mid_wgi,
                                    df_sum$mid_cohesion_horizontal,
                                    use = "complete.obs"), 2)),
           fill = "white", color = "red",
           label.size = 0.25, family = "serif", size = 3.5) +
  annotate("label", x = Inf, y = -Inf, hjust = 1.08, vjust = -3,
           label = paste0("r = ",
                          round(cor(df_sum_la$mid_wgi,
                                    df_sum_la$mid_cohesion_horizontal,
                                    use = "complete.obs"), 2)),
           fill = "white", color = "black",
           label.size = 0.25, family = "serif", size = 3.5)

fig_gini_v <-
  ggplot() +
  geom_smooth(data = df_sum, method = lm, se = FALSE, fullrange = TRUE,
              aes(mid_wid_gini_disp, y = mid_cohesion_vertical),
              color = "red", size = 0.5) +
  geom_smooth(data = df_sum_la, method = lm, se = FALSE, fullrange = TRUE,
              aes(mid_wid_gini_disp, y = mid_cohesion_vertical),
              color = "black") +
  geom_smooth(data = df_sum, method = "lm", se = FALSE,
              aes(x = wid_gini_disp, y = cohesion_vertical,
                  color = iso2c, shape = iso2c),
              color = "black", size = 0.1) +
  geom_label(data = df_sum,
             aes(x = mid_wid_gini_disp,
                 y = mid_cohesion_vertical,
                 label = iso2c),
             size = 2.5) +
  scale_y_continuous(limits = c(2, 8)) +
  labs(x = "Economic Inequality", y = " ", title = "Vertical cohesion") +
  annotate("label", x = Inf, y = -Inf, hjust = 1.08, vjust = -1,
           label = paste0("r = ",
                          round(cor(df_sum$mid_wid_gini_disp,
                                    df_sum$mid_cohesion_vertical,
                                    use = "complete.obs"), 2)),
           fill = "white", color = "red",
           label.size = 0.25, family = "serif", size = 3.5) +
  annotate("label", x = Inf, y = -Inf, hjust = 1.08, vjust = -3,
           label = paste0("r = ",
                          round(cor(df_sum_la$mid_wid_gini_disp,
                                    df_sum_la$mid_cohesion_vertical,
                                    use = "complete.obs"), 2)),
           fill = "white", color = "black",
           label.size = 0.25, family = "serif", size = 3.5)


fig_gdp_v <-
  ggplot() +
  geom_smooth(data = df_sum, method = lm, se = FALSE, fullrange = TRUE,
              aes(mid_pib_per_capita_ppa, y = mid_cohesion_vertical),
              color = "red", size = 0.5) +
  geom_smooth(data = df_sum_la, method = lm, se = FALSE, fullrange = TRUE,
              aes(mid_pib_per_capita_ppa, y = mid_cohesion_vertical),
              color = "black") +
  geom_smooth(data = df_sum, method = "lm", se = FALSE,
              aes(x = pib_per_capita_ppa, y = cohesion_vertical,
                  color = iso2c, shape = iso2c),
              color = "black", size = 0.1) +
  geom_label(data = df_sum,
             aes(x = mid_pib_per_capita_ppa,
                 y = mid_cohesion_vertical,
                 label = iso2c),
             size = 2.5) +
  scale_y_continuous(limits = c(2, 8)) +
  labs(x = "GDP per Capita (PPP)", y = " ", title = "") +
  annotate("label", x = Inf, y = -Inf, hjust = 1.08, vjust = -1,
           label = paste0("r = ",
                          round(cor(df_sum$mid_pib_per_capita_ppa,
                                    df_sum$mid_cohesion_vertical,
                                    use = "complete.obs"), 2)),
           fill = "white", color = "red",
           label.size = 0.25, family = "serif", size = 3.5) +
  annotate("label", x = Inf, y = -Inf, hjust = 1.08, vjust = -3,
           label = paste0("r = ",
                          round(cor(df_sum_la$mid_pib_per_capita_ppa,
                                    df_sum_la$mid_cohesion_vertical,
                                    use = "complete.obs"), 2)),
           fill = "white", color = "black",
           label.size = 0.25, family = "serif", size = 3.5)



fig_mig_v <-
  ggplot() +
  geom_smooth(data = df_sum, method = lm, se = FALSE, fullrange = TRUE,
              aes(mid_percent_pob_migrante, y = mid_cohesion_vertical),
              color = "red", size = 0.5) +
  geom_smooth(data = df_sum_la, method = lm, se = FALSE, fullrange = TRUE,
              aes(mid_percent_pob_migrante, y = mid_cohesion_vertical),
              color = "black") +
  geom_smooth(data = df_sum, method = "lm", se = FALSE,
              aes(x = percent_pob_migrante, y = cohesion_vertical,
                  color = iso2c, shape = iso2c),
              color = "black", size = 0.1) +
  geom_label(data = df_sum,
             aes(x = mid_percent_pob_migrante,
                 y = mid_cohesion_vertical,
                 label = iso2c),
             size = 2.5) +
  scale_y_continuous(limits = c(2, 8)) +
  labs(x = "Migrant Population (%)", y = " ", title = "") +
  annotate("label", x = Inf, y = -Inf, hjust = 1.08, vjust = -1,
           label = paste0("r = ",
                          round(cor(df_sum$mid_percent_pob_migrante,
                                    df_sum$mid_cohesion_vertical,
                                    use = "complete.obs"), 2)),
           fill = "white", color = "red",
           label.size = 0.25, family = "serif", size = 3.5) +
  annotate("label", x = Inf, y = -Inf, hjust = 1.08, vjust = -3,
           label = paste0("r = ",
                          round(cor(df_sum_la$mid_percent_pob_migrante,
                                    df_sum_la$mid_cohesion_vertical,
                                    use = "complete.obs"), 2)),
           fill = "white", color = "black",
           label.size = 0.25, family = "serif", size = 3.5)
  

fig_vdem_v <-
  ggplot() +
  geom_smooth(data = df_sum, method = lm, se = FALSE, fullrange = TRUE,
              aes(mid_indice_v_dem, y = mid_cohesion_vertical),
              color = "red", size = 0.5) +
  geom_smooth(data = df_sum_la, method = lm, se = FALSE, fullrange = TRUE,
              aes(mid_indice_v_dem, y = mid_cohesion_vertical),
              color = "black") +
  geom_smooth(data = df_sum, method = "lm", se = FALSE,
              aes(x = indice_v_dem, y = cohesion_vertical,
                  color = iso2c, shape = iso2c),
              color = "black", size = 0.1) +
  geom_label(data = df_sum,
             aes(x = mid_indice_v_dem,
                 y = mid_cohesion_vertical,
                 label = iso2c),
             size = 2.5) +
  scale_y_continuous(limits = c(2, 8)) +
  labs(x = "Democracy", y = " ", title = "") +
  annotate("label", x = Inf, y = -Inf, hjust = 1.08, vjust = -1,
           label = paste0("r = ",
                          round(cor(df_sum$mid_indice_v_dem,
                                    df_sum$mid_cohesion_vertical,
                                    use = "complete.obs"), 2)),
           fill = "white", color = "red",
           label.size = 0.25, family = "serif", size = 3.5) +
  annotate("label", x = Inf, y = -Inf, hjust = 1.08, vjust = -3,
           label = paste0("r = ",
                          round(cor(df_sum_la$mid_indice_v_dem,
                                    df_sum_la$mid_cohesion_vertical,
                                    use = "complete.obs"), 2)),
           fill = "white", color = "black",
           label.size = 0.25, family = "serif", size = 3.5)


fig_wdi_v <-
  ggplot() +
  geom_smooth(data = df_sum, method = lm, se = FALSE, fullrange = TRUE,
              aes(mid_wgi, y = mid_cohesion_vertical),
              color = "red", size = 0.5) +
  geom_smooth(data = df_sum_la, method = lm, se = FALSE, fullrange = TRUE,
              aes(mid_wgi, y = mid_cohesion_vertical),
              color = "black") +
  geom_smooth(data = df_sum, method = "lm", se = FALSE,
              aes(x = wgi, y = cohesion_vertical,
                  color = iso2c, shape = iso2c),
              color = "black", size = 0.1) +
  geom_label(data = df_sum,
             aes(x = mid_wgi,
                 y = mid_cohesion_vertical,
                 label = iso2c),
             size = 2.5) +
  scale_y_continuous(limits = c(2, 8)) +
  labs(x = "Governance", y = " ", title = "") +
  annotate("label", x = Inf, y = -Inf, hjust = 1.08, vjust = -1,
           label = paste0("r = ",
                          round(cor(df_sum$mid_wgi,
                                    df_sum$mid_cohesion_vertical,
                                    use = "complete.obs"), 2)),
           fill = "white", color = "red",
           label.size = 0.25, family = "serif", size = 3.5) +
  annotate("label", x = Inf, y = -Inf, hjust = 1.08, vjust = -3,
           label = paste0("r = ",
                          round(cor(df_sum_la$mid_wgi,
                                    df_sum_la$mid_cohesion_vertical,
                                    use = "complete.obs"), 2)),
           fill = "white", color = "black",
           label.size = 0.25, family = "serif", size = 3.5)


set.seed(1234)

grid.arrange(fig_gini_h,fig_gini_v,
             fig_gdp_h,fig_gdp_v,
             fig_vdem_h,fig_vdem_v,
             # fig_fho_v,fig_fho_h,
             fig_wdi_h,fig_wdi_v,
             fig_mig_h,fig_mig_v,
             nrow = 5, ncol=2,
 bottom =textGrob("Source: LAPOP (2004-2023); descriptive statistics; figure report country level pearson correlation; the line is the fitted values; CI at 95%",
 gp = gpar(fontface = 1, fontsize = 9),hjust = 1,x = 1
  ))
```
