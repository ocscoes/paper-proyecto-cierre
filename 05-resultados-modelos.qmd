---
output: html_document
editor_options: 
  chunk_output_type: console
---

<!-- Please run the following chunks before running the models  -->

```{r}
#| echo: false
## cargar base
library(tidyverse)
load("input/proc/micro-macro-merge.rdata")

datos_merge <- datos_merge |>
  mutate(across(where(haven::is.labelled), ~ vctrs::vec_data(.)),
         pais= as.factor(pais))

datos_merge$country_wave = do.call(paste, c(datos_merge[c("pais", "ola")], sep = "_"))
```

```{r data-model-fit}
#| label: preparacion-datos
#| eval: false
set1 <-  RColorBrewer::brewer.pal(n = 8, name = "Set1")
options(ggplot2.discrete.fill = set1)
options(ggplot2.discrete.colour = set1)
ggplot2::theme_set(ggplot2::theme_bw())
ggplot2::theme_update(text=ggplot2::element_text(size=15,  family="serif"))    
options(scipen=999)
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,ggplot2,haven,ggrepel,gridExtra,grid)  
rm(list=ls())

load("input/proc/micro-macro-merge.rdata")

datos_merge <- datos_merge |>
  mutate(across(where(haven::is.labelled), ~ vctrs::vec_data(.)),
         pais= as.factor(pais))

datos_merge$country_wave = do.call(paste, c(datos_merge[c("pais", "ola")], sep = "_"))

wid_data <- haven::read_dta(file = "input/proc/wid_data.dta")
wid_data <- wid_data %>% mutate(yr2=substr(year, 3, 4)) %>% rename(iso2c=country)
datos_merge$iso2c<- countrycode::countrycode(sourcevar = datos_merge$pais,origin = "country.name",destination = "iso2c")
wid_data$iso2c <- as.character(wid_data$iso2c)
datos_merge$yr2<- substr(datos_merge$ola, 3, 4)

frhouse <- read.csv("input/orig/freedom-score-fh.csv")
frhouse<- 
frhouse %>% select(country=Entity,iso3c=Code,year=Year,frhouse=Total.democracy.score) %>% 
  mutate(iso2c =countrycode::countrycode(sourcevar = iso3c,origin = "iso3c",destination = "iso2c")) %>% 
  mutate(yr2 = substr(year, 3, 4)) %>% 
  filter(iso2c %in% datos_merge$iso2c)
  
datos_merge<- 
left_join(x = datos_merge,y = wid_data[,c("iso2c","yr2","wid_gini_disp")],
          by =c("iso2c","yr2"))

datos_merge<- 
left_join(x = datos_merge,y = frhouse[,c("iso2c","yr2","frhouse")],
          by =c("iso2c","yr2"))


# Separar los efectos
datos_merge <- datos_merge |>
  group_by(pais) |>
 mutate(pib_be = mean(log_pib_per_capita_ppa, na.rm=T),
         # gini_be = mean(gini_index, na.rm=T),
         gini_be = mean(wid_gini_disp, na.rm=T),
         mig_be = mean(percent_pob_migrante, na.rm=T),
         dem_be = mean(indice_v_dem, na.rm=T),
         wgi_be = mean(wgi, na.rm=T),
         fho_be = mean(frhouse, na.rm=T),
         # edu_be = mean(edu_terciaria, na.rm=T)
        ) |>
  ungroup() |>
  mutate(pib_we = log_pib_per_capita_ppa - pib_be,
          # gini_we = gini_index - gini_be,
          gini_we = wid_gini_disp - gini_be,
          mig_we = percent_pob_migrante - mig_be,
          dem_we = indice_v_dem - dem_be,
          wgi_we = wgi- wgi_be,
          fho_we = frhouse- fho_be,
          # edu_we = edu_terciaria-edu_be
         )

# Centrado y limpieza

z <- function(x) as.numeric(scale(x))

datos_fit <- datos_merge %>%
  filter(!pais %in% c("Canada","United States")) %>% 
  mutate(
    # pib_we  = z(pib_we),   gini_we = z(gini_we), wgi_we = z(wgi_we), dem_we = z(dem_we),
    # mig_we  = z(mig_we),   edu_we = z(edu_we),
    # pib_be  = z(pib_be),   gini_be = z(gini_be), wgi_be = z(wgi_be), dem_be = z(dem_be),
    # mig_be  = z(mig_be),   edu_be = z(edu_be),
    edad_c = scale(edad) %>% as.numeric(),
    ola_s = as.numeric(scale(ola, center = TRUE, scale = TRUE)),
    ola,
    nivel_educ   = forcats::fct_drop(factor(nivel_educ)),
    pos_politica = forcats::fct_drop(factor(pos_politica)),
    sexo         = forcats::fct_drop(factor(sexo)),
    pais         = forcats::fct_drop(factor(pais)),
    country_wave = forcats::fct_drop(factor(country_wave)),

    # --- cambiar categoría de referencia ---
    nivel_educ   = forcats::fct_relevel(nivel_educ, "Primary"),   # ejemplo
    pos_politica = forcats::fct_relevel(pos_politica, "Not declared")         # ejemplo
  ) |>
  select(cohesion_general_ind, cohesion_vertical_ind, cohesion_horizontal_ind,
         nivel_educ, sexo, edad_c, ola_s, pos_politica,ola,
         income_decile,escolaridad,
         pib_we, gini_we, dem_we, wgi_we, mig_we,fho_we,
         pib_be, gini_be, dem_be, wgi_be, mig_be,fho_be, 
         country_wave, pais, wt) 
library(haven)
save(datos_fit, file="input/proc/datos-fit.rdata")
```

## Differences and changes in country level factors and social cohesion

```{r}
#| eval: false
load("input/proc/datos-fit.rdata")
m0_ch = lmer(cohesion_horizontal_ind ~ 1 + (1 | country_wave) + (1 |pais), data=datos_fit, weights=wt)
icc(m0_ch, by_group=TRUE) # 2.3% y 5.6%
m0_cv = lmer(cohesion_vertical_ind ~ 1 + (1 | country_wave) + (1 |pais), data=datos_fit, weights=wt)
icc(m0_cv, by_group=TRUE) # 6.3% y 6.3%
m0_cs = lmer(cohesion_general_ind ~ 1 + (1 | country_wave) + (1 |pais), data=datos_fit, weights=wt)
icc(m0_cs, by_group=TRUE) # 4.9% y 7.5%
save(m0_ch, file="output/modelo_nulo_horizontal.rdata")
save(m0_cv, file="output/modelo_nulo_vertical.rdata")
save(m0_cs, file= "output/modelo_nulo_completo.rdata")
```

```{r tbl-modelos-cohesion-micro}
#| label: tbl-modelos-cohesion-micro
#| results: asis
#| cache: true
#| tbl-cap: Multilevel regression for individual level factors and social cohesion
#| 
load("input/proc/datos-fit.rdata")
library(lme4)
library(texreg)
library(dplyr)
library(haven)

isced_labels <- c(
  "Early education/none",
  "Primary",
  "Lower secondary",
  "Upper secondary",
  "Postsecondary non-terciary",
  "Terciary (short-cycle)",
  "Universitary"
)

datos_fit$isced11 <- car::recode(datos_fit$escolaridad, 
"0 = 0;1:6 = 1;7:9 = 2;10:12 = 3;13:14 = 4;15:16 = 5;17:18 = 6")

datos_fit$isced11 <- factor(
  datos_fit$isced11,
  levels = 0:6,
  labels = isced_labels
)
datos_fit$ola <- as.numeric(haven::as_factor(datos_fit$ola))
datos_fit$nivel_educ <- relevel(datos_fit$nivel_educ,ref = "Secondary")

datos_fit <- 
datos_fit %>% 
  select(cohesion_general_ind, cohesion_vertical_ind, cohesion_horizontal_ind,
         nivel_educ, sexo, edad_c, ola_s, pos_politica,ola,
         income_decile,nivel_educ,
         pib_we, gini_we, dem_we, wgi_we, mig_we,fho_we,
         pib_be, gini_be, dem_be, wgi_be, mig_be,fho_be, 
         country_wave, pais, wt) %>% na.omit() %>% 
  filter(!pais %in% c("Canada","United States")) %>% as.data.frame()

micro_h2 <- lmer(cohesion_horizontal_ind ~ 1 + income_decile + nivel_educ + sexo + edad_c + I(edad_c^2) +  ola +  (1 | country_wave) + (1 | pais), data= datos_fit, weights= wt)
micro_h <- lmer(cohesion_horizontal_ind ~ 1 + income_decile + nivel_educ + sexo + edad_c + I(edad_c^2) + pos_politica + ola +  (1 | country_wave) + (1 | pais), data= datos_fit, weights= wt)

micro_v2 <- lmer(cohesion_vertical_ind ~ 1 + income_decile + nivel_educ + sexo + edad_c + I(edad_c^2) +  ola +  (1 | country_wave) + (1 | pais), data= datos_fit, weights= wt)
micro_v <- lmer(cohesion_vertical_ind ~ 1 + income_decile + nivel_educ + sexo + edad_c + I(edad_c^2) + pos_politica + ola +  (1 | country_wave) + (1 | pais), data= datos_fit, weights= wt)

coef_names<- list("(Intercept)"="(Intercept)",
"income_decile" ="Income decile",                  
"nivel_educPrimary" = "Primary",
"nivel_educTertiary" = "Tertiary",
"pos_politicaLeft"="Left",    
"pos_politicaCenter"="Center",  
"pos_politicaRight"="Right",
"ola"="Time",
"sexoMale"="Male (ref.=Female)",            
"edad_c"="Age",              
"I(edad_c^2)"="Age2"
)   

# knitreg(c(micro_h2,micro_h,micro_v2,micro_v),       # file = "output/table000.html",
#         custom.coef.map = coef_names,
#        groups =
#          list("Education (ref.=No formal schooling)"=3:4,
#               "Political position (ref.=Undefined)"=5:7
#               )
#        )

htmlreg(c(micro_h2,micro_h,micro_v2,micro_v),single.row = F,digits = 3,caption = NULL,
       # file = "output/table000.html",
        custom.coef.map = coef_names,
       groups = 
         list("Education (ref.=Secondary)"=3:4,
              "Political position (ref.=Undefined)"=5:7
              ),
       custom.header = list("Horizontal"=1:2,"Vertical"=3:4),
       custom.gof.rows = list("Controls"=c(rep("Yes",4))),include.loglik = FALSE,include.aic = FALSE,
       custom.gof.names = c(NA,NA,"Num. Country-wave","Num. Country","Var: Country-wave (Intercept)","Var: Country (Intercept)","Var: Residual")
)
```

The models in Table XX present the estimates of the multilevel models examining the association between individual characteristics and social cohesion.
For horizontal social cohesion, Model 1 indicates that a higher position in the relative income distribution is associated with greater social cohesion ($\beta = 0.027$, $p < .001$). This contrasts with differences between educational groups, where, compared to the group with secondary education, individuals with primary education ($\beta = 0.202$, $p < .001$) and those with tertiary education ($\beta = 0.099$, $p < .001$) exhibit higher horizontal social cohesion. Model 2 incorporates political position into the estimation, showing that, compared to the ideologically undefined group, both centrists ($\beta = -0.052$, $p < .01$) and leftists ($\beta = -0.162$, $p < .001$) report lower levels of horizontal cohesion. In contrast, right-leaning individuals display higher levels of social cohesion ($\beta = 0.041$, $p < .05$).

Similar to the results for horizontal cohesion, Model 3 shows that individuals with higher incomes exhibit higher vertical cohesion, though with a smaller coefficient and a more moderate level of significance ($\beta = 0.004$, $p < .05$). Differences between educational groups are more attenuated compared to the horizontal dimension. Relative to the group with secondary education, those with primary education report higher levels of vertical cohesion ($\beta = 0.132$, $p < .001$), whereas those with tertiary education show no significant differences ($\beta = 0.003$, $p > .05$). When political position is incorporated into Model 4, differences from Model 3 emerge. Income loses strength and statistical significance ($\beta = 0.002$, $p > .05$), while the relationship with educational level remains robust. Regarding political groups, individuals who declare a political position generally exhibit higher levels of vertical cohesion. Compared to those who are undecided, people on the right show the highest levels of vertical cohesion ($\beta = -0.052$, $p < .01$), followed by centrists ($\beta = -0.052$, $p < .01$) and leftists ($\beta = -0.052$, $p < .01$).

For the time variable in Models 2 and 4, results indicate a decline in both horizontal ($\beta = -0.048$, $p < .001$) and vertical ($\beta = -0.098$, $p < .001$) cohesion during the analyzed period. The decrease in the vertical dimension is nearly double that observed in the horizontal dimension. Additionally, a quadratic term was included to assess whether the decline accelerated in recent periods; however, no significant differences were found when incorporating the quadratic term of time (see supplementary material).


```{r modelo-cohesion-full}
#| cache: true
#| results: asis
load("input/proc/datos-fit.rdata")
library(lme4)
library(texreg)
library(dplyr)
library(correlation)

isced_labels <- c(
  "Early education/none",
  "Primary",
  "Lower secondary",
  "Upper secondary",
  "Postsecondary non-terciary",
  "Terciary (short-cycle)",
  "Universitary"
)

datos_fit$isced11 <- car::recode(datos_fit$escolaridad, 
"0 = 0;1:6 = 1;7:9 = 2;10:12 = 3;13:14 = 4;15:16 = 5;17:18 = 6")

datos_fit$isced11 <- factor(
  datos_fit$isced11,
  levels = 0:6,
  labels = isced_labels
)

datos_fit <- 
datos_fit %>% 
  select(cohesion_general_ind, cohesion_vertical_ind, cohesion_horizontal_ind,
         nivel_educ, sexo, edad_c, ola_s, pos_politica,ola,
         income_decile,
         pib_we, gini_we, dem_we, wgi_we, mig_we,fho_we,
         pib_be, gini_be, dem_be, wgi_be, mig_be,fho_be, 
         country_wave, pais, wt) %>% na.omit() %>% 
  filter(!pais %in% c("Canada","United States"))

datos_fit$ola <- as.numeric(haven::as_factor(datos_fit$ola))
datos_fit$nivel_educ <- relevel(datos_fit$nivel_educ,ref = "Secondary")

coef_names <- list(
  ola = "Time",
  gini_be = "Gini (BE)",
  gini_we = "Gini (WE)",
  pib_be = "GDP (BE)",
  pib_we = "GDP (WE)",
  dem_be = "Democracy (BE)",
  dem_we = "Democracy (WE)",
  wgi_be = "Governace (BE)",
  wgi_we = "Governace (WE)",
  mig_be = "Migration (BE)",
  mig_we = "Migration (WE)"
)

micro <- lmer(cohesion_horizontal_ind ~ 1 + income_decile + nivel_educ + sexo + edad_c + I(edad_c^2) + pos_politica + ola + (1 | country_wave) + (1 | pais), data= datos_fit, weights= wt)
macro_econ <- update(micro,. ~ . + gini_be+gini_we+pib_be+pib_we)
macro_econ_polit <- update(macro_econ,. ~ . + gini_be+gini_we+pib_be+pib_we+dem_be+dem_we+wgi_be+wgi_we)
macro_econ_polit_dem <- update(micro,. ~ . + gini_be+gini_we+pib_be+pib_we+dem_be+dem_we+wgi_be+wgi_we+mig_be+mig_we)

h_demo <- list(macro_econ,macro_econ_polit,macro_econ_polit_dem)

micro <- lmer(cohesion_vertical_ind ~ 1 + income_decile+ nivel_educ + sexo + edad_c + I(edad_c^2) + pos_politica + ola + (1 | country_wave) + (1 | pais), data= datos_fit, weights= wt)
macro_econ <- update(micro,. ~ . + gini_be+gini_we+pib_be+pib_we)
macro_econ_polit <- update(macro_econ,. ~ . + gini_be+gini_we+pib_be+pib_we+dem_be+dem_we+wgi_be+wgi_we)
macro_econ_polit_dem <- update(micro,. ~ . + gini_be+gini_we+pib_be+pib_we+dem_be+dem_we+wgi_be+wgi_we+mig_be+mig_we)

v_demo <- list(macro_econ,macro_econ_polit,macro_econ_polit_dem)

hv_demo<- c(h_demo,v_demo)
# screenreg(hv_demo,digits=3,custom.coef.map = coef_names)
```

In line with our hypotheses, Table XX presents the estimates of the hybrid multilevel models that show the between- and within-country differences in social cohesion.

*Horizontal Cohesion*

The results display the associations between (BE) and within (WE) for inequality (Gini) and economic prosperity (GDP). Regarding inequality, across all specifications (Models 1 to 3), differences between countries in levels of economic inequality are not associated with social cohesion. However, an increase in inequality within countries is associated with lower social cohesion. Similarly, the results show that neither between-country differences nor increases in economic prosperity appear to affect horizontal cohesion.
Regarding political variables, we observe that both levels of electoral democracy (Democracy) and governance affect social cohesion in different ways. First, differences between countries in levels of democracy are associated with lower levels of horizontal cohesion. However, this relationship is not observed within countries. Second, differences between countries in governance levels indicate that governance is associated with higher levels of horizontal cohesion. Nevertheless, changes in governance within countries do not appear to be associated with horizontal cohesion.
Finally, the results in Model 3 show that differences between countries in the percentage of the migrant population are not associated with levels of horizontal cohesion. However, an increase in the migrant population within countries is negatively associated with horizontal cohesion.

*Vertical Cohesion*

Similar to the results for horizontal cohesion, we observe distinct patterns for vertical cohesion. Differences between countries in levels of economic inequality indicate that countries with higher inequality exhibit lower vertical cohesion. Additionally, rising economic inequality within countries is negatively related to levels of vertical cohesion. Furthermore, both the between-country and within-country associations for economic prosperity are weak, showing a positive association for the within-country effect only when controlling for political characteristics and migration.

For political variables, we observe noteworthy results. First, differences between countries in levels of democracy do not show a robust association with vertical cohesion; this effect loses statistical significance when controlling for the percentage of the migrant population in the country. However, changes within countries reduce vertical cohesion. In other words, countries that increase their levels of electoral democracy also experience declines in vertical cohesion. Second, the results for governance are robust. Both differences between countries and changes within countries show a positive and significant association with social cohesion.

Finally, differences between countries and changes within countries in the percentage of the migrant population do not show an association with levels of vertical cohesion.


```{r}
#| label: tbl-table004
#| results: asis
#| cache: false
#| tbl-cap: Multilevel regression for country level factors and social cohesion
 
knitreg(hv_demo, digits=3,custom.coef.map = coef_names,caption = NULL,
        custom.header = list("Horizontal"=1:3,"Vertical"=4:6)
        )
```

# Interactions 

```{r modelo-cohesion-int}
#| cache: true
#| results: asis
#| eval: false

#Please run this code independently - it takes around 1 hour 
source("proc/proc_interactions.R")
# the output saves two objects "hz_ola.RData" and "vt_ola.RData"
```

```{r coefplot}
#| cache: true
#| results: asis
#| eval: true
#| fig-width: 10
#| fig-height: 8 
#| fig-cap: fig-coefplot
library(ggplot2)
library(broom.mixed)
library(tidyr)
library(dplyr)
library(ggtext)

load(file = "output/hz_ola.RData") # horizontal cohesion
load(file = "output/vt_ola.RData") # vertical cohesion

hz_gini<- broom.mixed::tidy(hz_ola[[1]],conf.int = T)# gini
hz_gdp <- broom.mixed::tidy(hz_ola[[2]],conf.int = T)# gdp 
hz_demo<- broom.mixed::tidy(hz_ola[[3]],conf.int = T)# democracy
hz_gove<- broom.mixed::tidy(hz_ola[[4]],conf.int = T)# governance
hz_migr<- broom.mixed::tidy(hz_ola[[5]],conf.int = T)# migration

data_hz_plot <- 
bind_rows(
hz_gini %>%filter(term %in%c("ola:gini_be","ola:gini_we"))%>%
  tidyr::extract(term,into = c("ola", "macro", "effect"),regex = "^([^:]+):([^_]+)_([^_]+)$",remove = FALSE),
hz_gdp  %>%filter(term%in%c("ola:pib_be","ola:pib_we")) %>% 
  tidyr::extract(term,into = c("ola", "macro", "effect"),regex = "^([^:]+):([^_]+)_([^_]+)$",remove = FALSE),
hz_demo %>%filter(term%in%c("ola:dem_be","ola:dem_we")) %>%
  tidyr::extract(term,into = c("ola", "macro", "effect"),regex = "^([^:]+):([^_]+)_([^_]+)$",remove = FALSE),
hz_gove %>%filter(term%in%c("ola:wgi_be","ola:wgi_we")) %>% 
  tidyr::extract(term,into = c("ola", "macro", "effect"),regex = "^([^:]+):([^_]+)_([^_]+)$",remove = FALSE),
hz_migr %>%filter(term%in%c("ola:mig_be","ola:mig_we")) %>% 
  tidyr::extract(term,into = c("ola", "macro", "effect"),regex = "^([^:]+):([^_]+)_([^_]+)$",remove = FALSE)
)

data_hz_plot$cohesion <-"Horizontal" 

vt_gini<- broom.mixed::tidy(vt_ola[[1]],conf.int = T)# gini
vt_gdp <- broom.mixed::tidy(vt_ola[[2]],conf.int = T)# gdp
vt_demo<- broom.mixed::tidy(vt_ola[[3]],conf.int = T)# democracy
vt_gove<- broom.mixed::tidy(vt_ola[[4]],conf.int = T)# governance
vt_migr<- broom.mixed::tidy(vt_ola[[5]],conf.int = T)# migration

data_vt_plot <-
bind_rows(
vt_gini %>%filter(term%in%c("ola:gini_be","ola:gini_we"))%>%
  tidyr::extract(term,into = c("ola", "macro", "effect"),regex = "^([^:]+):([^_]+)_([^_]+)$",remove = FALSE),
vt_gdp  %>%filter(term%in%c("ola:pib_be","ola:pib_we")) %>%
  tidyr::extract(term,into = c("ola", "macro", "effect"),regex = "^([^:]+):([^_]+)_([^_]+)$",remove = FALSE),
vt_demo %>%filter(term%in%c("ola:dem_be","ola:dem_we")) %>%
  tidyr::extract(term,into = c("ola", "macro", "effect"),regex = "^([^:]+):([^_]+)_([^_]+)$",remove = FALSE),
vt_gove %>%filter(term%in%c("ola:wgi_be","ola:wgi_we")) %>%
  tidyr::extract(term,into = c("ola", "macro", "effect"),regex = "^([^:]+):([^_]+)_([^_]+)$",remove = FALSE),
vt_migr %>%filter(term%in%c("ola:mig_be","ola:mig_we")) %>%
  tidyr::extract(term,into = c("ola", "macro", "effect"),regex = "^([^:]+):([^_]+)_([^_]+)$",remove = FALSE)
)
data_vt_plot$cohesion <-"Vertical" 

data_coes_plot <- bind_rows(data_vt_plot,data_hz_plot)
data_coes_plot$macro<- factor(data_coes_plot$macro,levels = rev(c("gini","pib","dem","wgi","mig")),ordered = T) 

data_coes_plot %>% 
  ggplot( aes(
  x = estimate,
  y = effect,
  shape = macro,
  group = macro
)) + geom_vline(xintercept = 0,
                color = "red",
                size = 1) + geom_errorbarh(
                  aes(xmin = conf.low, xmax = conf.high),
                  height = 0.2,
                  color = "black",
                  size = 0.5,
                  position = position_dodge(width = 0.5)
                ) + geom_point(size = 2, position = position_dodge(width = 0.5)) + labs(
                  # title = "Interaction of country-level factors with wave on horiztontal social cohesion",
                  # subtitle = "lower cohesion ←         → higher cohesion",
                  x = "Coefficient",
                  caption = stringr::str_wrap("*Note*: Multilevel hybrid model regression (95% CIs). Include country-level factor and wave random slopes within country. Each coefficient corresponds to an independent estimate (see supplementary material).",),
                  y = NULL
                ) + scale_x_continuous(limits = c(-1, 3)) +
                    scale_y_discrete(labels=c("BE\n×Wave","WE\n× Wave "))+
                    scale_shape_manual(labels=rev(c("Gini","GDP","Democracy","Governance","Migration")),
                                         values = c(15, 10, 17, 16, 5))+
                  facet_wrap(facets = "cohesion")+
                  theme(
                  panel.grid.minor = element_blank(),
                  plot.title = element_text(face = "bold",size = 13),
                  legend.title = element_blank(),
                  strip.text = element_text(face = "bold"),
                  axis.title = element_text(face = "bold"),
                  axis.title.x = element_text(margin = margin(t = 10), hjust = 0),
                  axis.title.y = element_text(margin = margin(r = 10), hjust = 1),
                  plot.subtitle = element_text(hjust = 0.5),
                  legend.position = "bottom",
                  axis.text.y = element_markdown(hjust = 1, size = 16),
                  plot.caption = element_textbox_simple(hjust = 0,size = 13)
                )

```

Figure @fig-coefplot shows the coefficients for the between- and within-country effects for the country-level characteristics and the time trend (wave).
When examining the between-country effects (BE × wave), the results indicate no significant differences for any of the socioeconomic, political, or migration variables.

In contrast, the within-country effects (WE × wave) reveal nuances in their relationship with social cohesion. For economic inequality, an increase in within-country inequality is associated with a decline in social cohesion in both the horizontal and vertical dimensions as time progresses.

Additionally, the effect of economic prosperity within countries becomes increasingly positive for horizontal cohesion over time. However, this pattern is not observed for vertical cohesion.

Regarding political variables, changes in levels of democracy do not show differences over time for either dimension of social cohesion. In contrast, the results for governance indicate that, as time passes, increases in governance become more positively associated with social cohesion.

Finally, for migration, the results show no significant changes in the within-country effect or its interaction with time for either dimension of social cohesion.








<!-- Así...

* todas las iteraciones la mismo tiempo y ver que pasa
* si alguna de las interacciones no es ninguna de las dos cohesiones 
  - para las interaccines que son son significativas dejarlas, las otras no  -->



Table 6...

```{r}
#| label: tbl-table006
#| results: asis
#| cache: false
#| eval: false
#| tbl-cap: Multilevel regression for macro factors and general social cohesion
 
micro <- lmer(cohesion_general_ind ~ 1 + income_decile +isced11 + sexo + edad_c + I(edad_c^2) + pos_politica + ola + (1 | country_wave) + (1 | pais), data= datos_fit, weights= wt)
macro_econ <- update(micro,. ~ . + gini_be+gini_we+pib_be+pib_we)
macro_econ_polit <- update(macro_econ,. ~ . + gini_be+gini_we+pib_be+pib_we+dem_be+dem_we+wgi_be+wgi_we)
# macro_dem <- update(micro,. ~ . + mig_be+mig_we)
# macro_econ_dem <- update(micro,. ~ . + gini_be+gini_we+pib_be+pib_we+mig_be+mig_we)
macro_econ_polit_dem <- update(micro,. ~ . + gini_be+gini_we+pib_be+pib_we+dem_be+dem_we+wgi_be+wgi_we+mig_be+mig_we)

g_demo <- list(macro_econ,macro_econ_polit,macro_econ_polit_dem) 
# screenreg(g_demo,digits=3,custom.coef.map = coef_names)
htmlreg(g_demo, digits=3,custom.coef.map = coef_names,caption = NULL,
        # file = "output/table006.html"
        )
```

```{r}
#| label: tbl-modelos-cohesion
#| results: asis
#| echo: false
#| eval: false
#| cache: true
load("input/proc/datos-fit.rdata")
library(lme4)
library(texreg)
library(dplyr)

# datos_fit$ola<- factor(datos_fit$ola)
datos_fit_la <- datos_fit %>% filter(!pais %in% c("Canada","United States"))
# Socioeconomic dimensions------------------------------------------------------
micro <- lmer(cohesion_horizontal_ind ~ 1 + isced11 + sexo + edad_c + I(edad_c^2) + pos_politica + ola + (1 | country_wave) + (1 | pais), data= datos_fit, weights= wt)
macro_gini <- update(micro,. ~ . + gini_be + gini_we)
macro_gdp <- update(micro,. ~ . + pib_be + pib_we)
macro_econ <- update(micro,. ~ . + gini_be+gini_we+pib_be+pib_we)
# macro_econ_la_h <- update(macro_econ,data=datos_fit_la) #using only LATAM
h_econ <- list(macro_gini,macro_gdp,macro_econ)

micro <- lmer(cohesion_vertical_ind ~ 1 + isced11 + sexo + edad_c + I(edad_c^2) + pos_politica + ola + (1 | country_wave) + (1 | pais), data= datos_fit, weights= wt)
macro_gini <- update(micro,. ~ . + gini_be + gini_we)
macro_gdp <- update(micro,. ~ . + pib_be + pib_we)
macro_econ <- update(micro,. ~ . + gini_be+gini_we+pib_be+pib_we)
# macro_econ_la_v <- update(macro_econ,data=datos_fit_la) #using only LATAM
v_econ <- list(macro_gini,macro_gdp,macro_econ)

# screenreg(c(h_econ,v_econ))

htmlreg(c(h_econ,v_econ),single.row = F,digits = 3,
       # file = "output/table001.html",
        caption.above = T,
        caption = "Multilevel regression for socioeconomic macro factors and social cohesion", 
          custom.coef.map = 
            list(
              gini_be ="Gini (BE)",
              gini_we ="Gini (WE)",
              pib_be = "GDP (BE)", 
              pib_we = "GDP (WE)",
              # ola2006 = "Time (ref.= 2004) 2006",
              # ola2008 = "2008",
              # ola2010 = "2010",
              # ola2012 = "2012",
              # ola2014 = "2014",
              # ola2016 = "2016",
              # ola2018 = "2018",
              # ola2023 = "2023"   
              ola = "Time"              
            ),custom.header = list("Horizontal"=1:3,"Vertical"=4:6),
          custom.gof.rows = 
            list(Controls=c("Yes","Yes","Yes","Yes","Yes","Yes"))
          )

# Political dimensions------------------------------------------------------
micro <- lmer(cohesion_horizontal_ind ~ 1 + nivel_educ + sexo + edad_c + I(edad_c^2) + pos_politica + ola + (1 | country_wave) + (1 | pais), data= datos_fit, weights= wt)
macro_dem <- update(micro,. ~ . + dem_be + dem_we)
macro_wgi <- update(micro,. ~ . + wgi_be + wgi_we)
macro_pol <- update(micro,. ~ . + dem_be+dem_we+wgi_be + wgi_we)
# macro_pol_la_v <- update(macro_pol,data=datos_fit_la) #using only LATAM
h_pol <- list(macro_dem,macro_wgi,macro_pol)

micro <- lmer(cohesion_vertical_ind ~ 1 + nivel_educ + sexo + edad_c + I(edad_c^2) + pos_politica + ola + (1 | country_wave) + (1 | pais), data= datos_fit, weights= wt)
macro_dem  <- update(micro,. ~ . + dem_be + dem_we)
macro_wgi <- update(micro,. ~ . + wgi_be + wgi_we)
macro_pol  <- update(micro,. ~ . + dem_be+dem_we+wgi_be + wgi_we)
# macro_pol_la_h <- update(macro_pol,data=datos_fit_la) #using only LATAM

v_pol <- list(macro_dem,macro_wgi,macro_pol)

#screenreg(c(h_pol,v_pol))
htmlreg(c(h_pol,v_pol),single.row = F,digits = 3,
        # file = "output/table002.html",
        caption.above = T,
        caption = "Multilevel regression for institutional macro factors and social cohesion", 
          custom.coef.map = 
            list(
              dem_be ="Democracy (BE)",
              dem_we ="Democracy (WE)",
              wgi_be = "Governace (BE)", 
              wgi_we = "Governace (WE)",
              # ola2006 = "Time (ref.= 2004) 2006",
              # ola2008 = "2008",
              # ola2010 = "2010",
              # ola2012 = "2012",
              # ola2014 = "2014",
              # ola2016 = "2016",
              # ola2018 = "2018",
              # ola2023 = "2023"
              ola = "Time"
            ),custom.header = list("Horizontal"=1:3,"Vertical"=4:6),
          custom.gof.rows = 
            list(Controls=c("Yes","Yes","Yes","Yes","Yes","Yes"))          
          )

# Demographic ------------------------------------------------------------------
micro <- lmer(cohesion_horizontal_ind ~ 1 + nivel_educ + sexo + edad_c + I(edad_c^2) + pos_politica + ola + (1 | country_wave) + (1 | pais), data= datos_fit, weights= wt)
macro_mig <- update(micro,. ~ . + mig_be + mig_we)
# macro_mig_time <- update(micro,. ~ . + mig_be*ola + mig_we*ola)
h_demo <- list(macro_mig)

micro <- lmer(cohesion_vertical_ind ~ 1 + nivel_educ + sexo + edad_c + I(edad_c^2) + pos_politica + ola + (1 | country_wave) + (1 | pais), data= datos_fit, weights= wt)
macro_mig <- update(micro,. ~ . + mig_be + mig_we)
# macro_mig_time <- update(micro,. ~ . + mig_be*ola + mig_we*ola)
v_demo <- list(macro_mig)

#screenreg(c(h_demo,v_demo))
htmlreg(c(h_demo,v_demo),single.row = F,digits = 3,
        # file = "output/table003.html",
        caption.above = T,
        caption = "Multilevel regression for demographic macro factors and social cohesion", 
          custom.coef.map = 
            list(mig_be ="Migration (BE)",
                 mig_we = "Migration (WE)",
              # ola2006 = "Time (ref.= 2004) 2006",
              # ola2008 = "2008",
              # ola2010 = "2010",
              # ola2012 = "2012",
              # ola2014 = "2014",
              # ola2016 = "2016",
              # ola2018 = "2018",
              # ola2023 = "2023"
              ola = "Time"
              ),
          ,custom.header = list("Horizontal"=1,"Vertical"=2),
          custom.gof.rows = 
            list(Controls=c("Yes","Yes"))          
          )
```

```{r}
#| eval: false
set1 <-  RColorBrewer::brewer.pal(n = 8, name = "Set1")
options(ggplot2.discrete.fill = set1)
options(ggplot2.discrete.colour = set1)
ggplot2::theme_set(ggplot2::theme_bw())
ggplot2::theme_update(text=ggplot2::element_text(size=15,  family="serif"))    
options(scipen=999)
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,ggplot2,haven,ggrepel,gridExtra,grid)  
rm(list=ls())

load("input/proc/micro-macro-merge.rdata")

datos_merge <- datos_merge |>
  mutate(across(where(haven::is.labelled), ~ vctrs::vec_data(.)),
         pais= as.factor(pais))

datos_merge$country_wave = do.call(paste, c(datos_merge[c("pais", "ola")], sep = "_"))

wid_data <- haven::read_dta(file = "input/proc/wid_data.dta")
wid_data <- wid_data %>% mutate(yr2=substr(year, 3, 4)) %>% rename(iso2c=country)
datos_merge$iso2c<- countrycode::countrycode(sourcevar = datos_merge$pais,origin = "country.name",destination = "iso2c")
wid_data$iso2c <- as.character(wid_data$iso2c)
datos_merge$yr2<- substr(datos_merge$ola, 3, 4)

frhouse <- read.csv("input/orig/freedom-score-fh.csv")
frhouse<- 
frhouse %>% select(country=Entity,iso3c=Code,year=Year,frhouse=Total.democracy.score) %>% 
  mutate(iso2c =countrycode::countrycode(sourcevar = iso3c,origin = "iso3c",destination = "iso2c")) %>% 
  mutate(yr2 = substr(year, 3, 4)) %>% 
  filter(iso2c %in% datos_merge$iso2c)
  
datos_merge<- 
left_join(x = datos_merge,y = wid_data[,c("iso2c","yr2","wid_gini_disp")],
          by =c("iso2c","yr2"))

datos_merge<- 
left_join(x = datos_merge,y = frhouse[,c("iso2c","yr2","frhouse")],
          by =c("iso2c","yr2"))

datos_macro <- datos_merge %>%
  mutate(
   cohesion_horizontal,
      cohesion_vertical,
      cohesion_general,
      gini_index,
      wid_gini_disp,  
      pib_per_capita_ppa,
      log_pib_per_capita_ppa,
      percent_pob_migrante,
      indice_v_dem,
      regulatory_quality,
      voice_and_accountability,
      wgi,
     frhouse, 
    edad_c = scale(edad) %>% as.numeric(),
    ola_s = as.numeric(scale(ola, center = TRUE, scale = TRUE)),
   income_decile,
    ola,
    nivel_educ   = forcats::fct_drop(factor(nivel_educ)),
    pos_politica = forcats::fct_drop(factor(pos_politica)),
    sexo         = forcats::fct_drop(factor(sexo)),
    pais         = forcats::fct_drop(factor(pais)),
    country_wave = forcats::fct_drop(factor(country_wave))
  ) %>% 
    select(cohesion_horizontal,
      cohesion_vertical,
      cohesion_general,
      gini_index,wid_gini_disp,
      pib_per_capita_ppa,
      log_pib_per_capita_ppa,
      percent_pob_migrante,
      indice_v_dem,
      regulatory_quality,
      voice_and_accountability,wgi,frhouse,
      income_decile,escolaridad,
         nivel_educ, sexo, edad_c, ola_s,ola, pos_politica,iso2c,
         country_wave, pais, wt)

# dim(datos_macro);dim(na.omit(datos_macro))
datos_macro$yr2<- substr(datos_macro$ola, 3, 4)

df_sum <- datos_macro %>%
  group_by(iso2c, yr2) %>%
  summarise(across(
    c(cohesion_horizontal,
      cohesion_vertical,
      cohesion_general,
      gini_index,wid_gini_disp,
      pib_per_capita_ppa,
      log_pib_per_capita_ppa,
      percent_pob_migrante,
      indice_v_dem,frhouse,
      wgi),
    mean,
    na.rm = TRUE
  )) %>%
  ungroup() 
df_sum <- 
 df_sum %>% 
  group_by(iso2c) %>%
  mutate(across(
    c(cohesion_horizontal,
      cohesion_vertical,
      cohesion_general,
      gini_index,wid_gini_disp,
      pib_per_capita_ppa,
      log_pib_per_capita_ppa,
      percent_pob_migrante,
      indice_v_dem,frhouse,
      wgi),
    mean,
    na.rm = TRUE,
    .names = "mid_{.col}"
  )) %>%
  ungroup()

df_sum$ctyear <- paste0(df_sum$iso2c,df_sum$yr2)


ggplot() +
  geom_smooth(data = df_sum, method = lm, se = FALSE,
              aes(y = scale(mid_cohesion_vertical), x = scale(mid_cohesion_horizontal)),
              color = "red",size=0.5,fullrange=T) +
  geom_label(data = df_sum, aes(y = scale(mid_cohesion_vertical), x = scale(mid_cohesion_horizontal), label = iso2c),size=2.5) +
  geom_hline(yintercept = 0,color="black",linetype="dashed")+
  geom_vline(xintercept = 0,color="black",linetype="dashed")+
  scale_y_continuous(limits = c(-3,3))+
  scale_x_continuous(limits = c(-3,3)) +
  labs(x = "Horizontal Cohesion (z-score)", y = "Vertical Cohesion (z-score)") +
  annotate("label",
           x = Inf, y = -Inf,               
           hjust = 1.08, vjust = -1,      
           label = paste0("r = ", round(cor(df_sum$mid_cohesion_horizontal,df_sum$mid_cohesion_vertical,use = "complete.obs"), 2)),
           fill = "white",                 
           color = "red",                
           label.size = 0.25,family = "serif",
           size = 3.5)
```


