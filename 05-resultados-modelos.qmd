---
output: html_document
editor_options: 
  chunk_output_type: console
---

<!-- Please run the following chunks before running the models  -->

```{r}
#| echo: false
## cargar base
library(tidyverse)
load("input/proc/micro-macro-merge.rdata")

datos_merge <- datos_merge |>
  mutate(across(where(haven::is.labelled), ~ vctrs::vec_data(.)),
         pais= as.factor(pais))

datos_merge$country_wave = do.call(paste, c(datos_merge[c("pais", "ola")], sep = "_"))
```

```{r data-model-fit}
#| label: preparacion-datos
#| eval: false

# Separar los efectos
datos_merge <- datos_merge |>
  group_by(pais) |>
 mutate(pib_be = mean(log_pib_per_capita_ppa, na.rm=T),
         # gini_be = mean(gini_index, na.rm=T),
         gini_be = mean(wid_gini_disp, na.rm=T),
         mig_be = mean(percent_pob_migrante, na.rm=T),
         dem_be = mean(indice_v_dem, na.rm=T),
         wgi_be = mean(wgi, na.rm=T),
         fho_be = mean(frhouse, na.rm=T),
         # edu_be = mean(edu_terciaria, na.rm=T)
        ) |>
  ungroup() |>
  mutate(pib_we = log_pib_per_capita_ppa - pib_be,
          # gini_we = gini_index - gini_be,
          gini_we = wid_gini_disp - gini_be,
          mig_we = percent_pob_migrante - mig_be,
          dem_we = indice_v_dem - dem_be,
          wgi_we = wgi- wgi_be,
          fho_we = frhouse- fho_be,
          # edu_we = edu_terciaria-edu_be
         )

# Centrado y limpieza

z <- function(x) as.numeric(scale(x))

datos_fit <- datos_merge %>%
  filter(!pais %in% c("Canada","United States","Trinidad & Tobago")) %>% 
  mutate(
    # pib_we  = z(pib_we),   gini_we = z(gini_we), wgi_we = z(wgi_we), dem_we = z(dem_we),
    # mig_we  = z(mig_we),   edu_we = z(edu_we),
    # pib_be  = z(pib_be),   gini_be = z(gini_be), wgi_be = z(wgi_be), dem_be = z(dem_be),
    # mig_be  = z(mig_be),   edu_be = z(edu_be),
    edad_c = scale(edad) %>% as.numeric(),
    ola_s = as.numeric(scale(ola, center = TRUE, scale = TRUE)),
    ola,
    nivel_educ   = forcats::fct_drop(factor(nivel_educ)),
    pos_politica = forcats::fct_drop(factor(pos_politica)),
    sexo         = forcats::fct_drop(factor(sexo)),
    pais         = forcats::fct_drop(factor(pais)),
    country_wave = forcats::fct_drop(factor(country_wave)),

    # --- cambiar categoría de referencia ---
    nivel_educ   = forcats::fct_relevel(nivel_educ, "Primary"),   # ejemplo
    pos_politica = forcats::fct_relevel(pos_politica, "Not declared")         # ejemplo
  ) |>
  select(cohesion_general_ind, cohesion_vertical_ind, cohesion_horizontal_ind,
         nivel_educ, sexo, edad_c, ola_s, pos_politica,ola,
         income_decile,escolaridad,
         pib_we, gini_we, dem_we, wgi_we, mig_we,fho_we,
         pib_be, gini_be, dem_be, wgi_be, mig_be,fho_be, 
         country_wave, pais, wt) 

save(datos_fit, file="input/proc/datos-fit.rdata")
```

## Differences and changes in country level factors and social cohesión

```{r}
#| eval: false
load("input/proc/datos-fit.rdata")
m0_ch = lmer(cohesion_horizontal_ind ~ 1 + (1 | country_wave) + (1 |pais), data=datos_fit, weights=wt)
icc(m0_ch, by_group=TRUE) # 2.3% y 5.6%
m0_cv = lmer(cohesion_vertical_ind ~ 1 + (1 | country_wave) + (1 |pais), data=datos_fit, weights=wt)
icc(m0_cv, by_group=TRUE) # 6.3% y 6.3%
m0_cs = lmer(cohesion_general_ind ~ 1 + (1 | country_wave) + (1 |pais), data=datos_fit, weights=wt)
icc(m0_cs, by_group=TRUE) # 4.9% y 7.5%
save(m0_ch, file="output/modelo_nulo_horizontal.rdata")
save(m0_cv, file="output/modelo_nulo_vertical.rdata")
save(m0_cs, file= "output/modelo_nulo_completo.rdata")
```

```{r tbl-modelos-cohesion-micro}
#| label: tbl-modelos-cohesion-micro
#| results: asis
#| cache: true
#| tbl-cap: Multilevel regression for individual level factors and social cohesion
load("input/proc/datos-fit.rdata")
library(lme4)
library(texreg)
library(dplyr)

isced_labels <- c(
  "Early education/none",
  "Primary",
  "Lower secondary",
  "Upper secondary",
  "Postsecondary non-terciary",
  "Terciary (short-cycle)",
  "Universitary"
)

datos_fit$isced11 <- car::recode(datos_fit$escolaridad, 
"0 = 0;1:6 = 1;7:9 = 2;10:12 = 3;13:14 = 4;15:16 = 5;17:18 = 6")

datos_fit$isced11 <- factor(
  datos_fit$isced11,
  levels = 0:6,
  labels = isced_labels
)


datos_fit <- 
datos_fit %>% 
  select(cohesion_general_ind, cohesion_vertical_ind, cohesion_horizontal_ind,
         nivel_educ, sexo, edad_c, ola_s, pos_politica,ola,
         income_decile,isced11,escolaridad,
         pib_we, gini_we, dem_we, wgi_we, mig_we,fho_we,
         pib_be, gini_be, dem_be, wgi_be, mig_be,fho_be, 
         country_wave, pais, wt) %>% na.omit() %>% 
  filter(!pais %in% c("Canada","United States"))


micro_h2 <- lmer(cohesion_horizontal_ind ~ 1 + income_decile + isced11 + sexo + edad_c + I(edad_c^2) +  ola +  (1 | country_wave) + (1 | pais), data= datos_fit, weights= wt)
micro_h <- lmer(cohesion_horizontal_ind ~ 1 + income_decile + isced11 + sexo + edad_c + I(edad_c^2) + pos_politica + ola +  (1 | country_wave) + (1 | pais), data= datos_fit, weights= wt)

micro_v2 <- lmer(cohesion_vertical_ind ~ 1 + income_decile + isced11 + sexo + edad_c + I(edad_c^2) +  ola +  (1 | country_wave) + (1 | pais), data= datos_fit, weights= wt)
micro_v <- lmer(cohesion_vertical_ind ~ 1 + income_decile + isced11 + sexo + edad_c + I(edad_c^2) + pos_politica + ola +  (1 | country_wave) + (1 | pais), data= datos_fit, weights= wt)

coef_names<- list("(Intercept)"="(Intercept)",
"income_decile" ="Income decile",                  
# "nivel_educSecondary" = "Secondary", 
# "nivel_educTertiary" = "Tertiary",  
"isced11Primary"="Primary",                        
"isced11Lower secondary"="Lower secondary",                
"isced11Upper secondary"="Upper secondary",
"isced11Postsecondary non-terciary"="Postsecondary non-terciary",     
"isced11Terciary (short-cycle)"="Terciary (short-cycle)",         
"isced11Universitary"="Universitary",                   
"pos_politicaLeft"="Left",    
"pos_politicaCenter"="Center",  
"pos_politicaRight"="Right",
# ola2006 = "2006",
# ola2008 = "2008",
# ola2010 = "2010",
# ola2012 = "2012",
# ola2014 = "2014",
# ola2016 = "2016",
# ola2018 = "2018",
# ola2023 = "2023"
"ola"="Time",
"sexoMale"="Male (ref.=Female)",            
"edad_c"="Age",              
"I(edad_c^2)"="Age2"
)   

# knitreg(c(micro_h2,micro_h,micro_v2,micro_v),       # file = "output/table000.html",
#         custom.coef.map = coef_names,
#        groups = 
#          list("Education (ref.=No formal schooling)"=3:8,
#               "Political position (ref.=Undefined)"=9:11
#               # "Time trend (ref.=2004)"=10:17
#               ))

htmlreg(c(micro_h2,micro_h,micro_v2,micro_v),single.row = F,digits = 3,caption = NULL,
       # file = "output/table000.html",
        custom.coef.map = coef_names,
       groups = 
         list("Education (ref.=No formal schooling)"=3:8,
              "Political position (ref.=Undefined)"=9:11
              # "Time trend (ref.=2004)"=10:17
              ),
       custom.header = list("Horizontal"=2,"Vertical"=4),
       custom.gof.rows = list("Controls"=c(rep("Yes",4))),include.loglik = FALSE,include.aic = FALSE,
       custom.gof.names = c(NA,NA,"Num. Country-wave","Num. Country","Var: Country-wave (Intercept)","Var: Country (Intercept)","Var: Residual")
)
```

```{r}
#| fig-width: 10
#| fig-height: 5
#| eval: true
library(marginaleffects)
library(ggplot2)
p1 <- plot_predictions(model = micro_h,condition = "isced11") + 
  xlab("Education")+ylab("Horizontal Cohesion")

# p2 <- plot_predictions(model = micro_h2,condition = "escolaridad") + 
#   xlab("Year of Education")+ylab("Horizontal Cohesion")+
#   scale_y_continuous(limits = c(5,6))

p3 <- plot_predictions(model = micro_v,condition = "isced11") +
  xlab("Education")+ylab("Vertical Cohesion")

# p4 <- plot_predictions(model = micro_v,condition = "isced11") + 
#   xlab("Year of Education")+ylab("Vertical Cohesion")

grid.arrange(p1,p3)
```


```{r modelo-cohesion-full}
#| cache: true
#| results: asis
load("input/proc/datos-fit.rdata")
library(lme4)
library(texreg)
library(dplyr)
library(correlation)

isced_labels <- c(
  "Early education/none",
  "Primary",
  "Lower secondary",
  "Upper secondary",
  "Postsecondary non-terciary",
  "Terciary (short-cycle)",
  "Universitary"
)

datos_fit$isced11 <- car::recode(datos_fit$escolaridad, 
"0 = 0;1:6 = 1;7:9 = 2;10:12 = 3;13:14 = 4;15:16 = 5;17:18 = 6")

datos_fit$isced11 <- factor(
  datos_fit$isced11,
  levels = 0:6,
  labels = isced_labels
)


datos_fit <- 
datos_fit %>% 
  select(cohesion_general_ind, cohesion_vertical_ind, cohesion_horizontal_ind,
         nivel_educ, sexo, edad_c, ola_s, pos_politica,ola,
         income_decile,isced11,escolaridad,
         pib_we, gini_we, dem_we, wgi_we, mig_we,fho_we,
         pib_be, gini_be, dem_be, wgi_be, mig_be,fho_be, 
         country_wave, pais, wt) %>% na.omit() %>% 
  filter(!pais %in% c("Canada","United States"))


datos_fit$ola <- as.numeric(datos_fit$ola)
# datos_fit$dem_be <- datos_fit$fho_be
# datos_fit$dem_we <- datos_fit$fho_we

coef_names <- list(
  ola = "Time",
  gini_be = "Gini (BE)",
  gini_we = "Gini (WE)",
  pib_be = "GDP (BE)",
  pib_we = "GDP (WE)",
  dem_be = "Democracy (BE)",
  dem_we = "Democracy (WE)",
  wgi_be = "Governace (BE)",
  wgi_we = "Governace (WE)",
  mig_be = "Migration (BE)",
  mig_we = "Migration (WE)"
)

# corr_macro <- 
#   correlation::correlation(
#     dplyr::select(datos_fit,gini_be,gini_we,pib_be,pib_we,dem_be,dem_we,wgi_be,wgi_we,mig_be,mig_we)) 
# 
# display(summary(corr_macro),digits = 3,format = "markdown")

micro <- lmer(cohesion_horizontal_ind ~ 1 + income_decile + isced11 + sexo + edad_c + I(edad_c^2) + pos_politica + ola + (1 | country_wave) + (1 | pais), data= datos_fit, weights= wt)
macro_econ <- update(micro,. ~ . + gini_be+gini_we+pib_be+pib_we)
macro_econ_polit <- update(macro_econ,. ~ . + gini_be+gini_we+pib_be+pib_we+dem_be+dem_we+wgi_be+wgi_we)
# macro_dem <- update(micro,. ~ . + mig_be+mig_we)
# macro_econ_dem <- update(micro,. ~ . + gini_be+gini_we+pib_be+pib_we+mig_be+mig_we)
macro_econ_polit_dem <- update(micro,. ~ . + gini_be+gini_we+pib_be+pib_we+dem_be+dem_we+wgi_be+wgi_we+mig_be+mig_we)

h_demo <- list(macro_econ,macro_econ_polit,macro_econ_polit_dem)
# screenreg(h_demo,digits=3,custom.coef.map = coef_names)

micro <- lmer(cohesion_vertical_ind ~ 1 + income_decile+ isced11 + sexo + edad_c + I(edad_c^2) + pos_politica + ola + (1 | country_wave) + (1 | pais), data= datos_fit, weights= wt)
macro_econ <- update(micro,. ~ . + gini_be+gini_we+pib_be+pib_we)
macro_econ_polit <- update(macro_econ,. ~ . + gini_be+gini_we+pib_be+pib_we+dem_be+dem_we+wgi_be+wgi_we)
# macro_dem <- update(micro,. ~ . + mig_be+mig_we)
# macro_econ_dem <- update(micro,. ~ . + gini_be+gini_we+pib_be+pib_we+mig_be+mig_we)
macro_econ_polit_dem <- update(micro,. ~ . + gini_be+gini_we+pib_be+pib_we+dem_be+dem_we+wgi_be+wgi_we+mig_be+mig_we)

v_demo <- list(macro_econ,macro_econ_polit,macro_econ_polit_dem)

# screenreg(v_demo,digits=3,custom.coef.map = coef_names)

micro <- lmer(cohesion_general_ind ~ 1 + income_decile +isced11 + sexo + edad_c + I(edad_c^2) + pos_politica + ola + (1 | country_wave) + (1 | pais), data= datos_fit, weights= wt)
macro_econ <- update(micro,. ~ . + gini_be+gini_we+pib_be+pib_we)
macro_econ_polit <- update(macro_econ,. ~ . + gini_be+gini_we+pib_be+pib_we+dem_be+dem_we+wgi_be+wgi_we)
# macro_dem <- update(micro,. ~ . + mig_be+mig_we)
# macro_econ_dem <- update(micro,. ~ . + gini_be+gini_we+pib_be+pib_we+mig_be+mig_we)
macro_econ_polit_dem <- update(micro,. ~ . + gini_be+gini_we+pib_be+pib_we+dem_be+dem_we+wgi_be+wgi_we+mig_be+mig_we)

g_demo <- list(macro_econ,macro_econ_polit,macro_econ_polit_dem) 
# screenreg(g_demo,digits=3,custom.coef.map = coef_names)
```

Table 4...

```{r}
#| label: tbl-table004
#| results: asis
#| cache: false
#| tbl-cap: Multilevel regression for macro factors and horizontal social cohesion
 
htmlreg(h_demo, digits=3,custom.coef.map = coef_names,caption = NULL,
        # file = "output/table004.html"
        )
```


Table 5...

```{r}
#| label: tbl-table005
#| results: asis
#| cache: false
#| tbl-cap: Multilevel regression for macro factors and vertical social cohesion

 
htmlreg(v_demo, digits=3,custom.coef.map = coef_names,caption = NULL,
        # file = "output/table005.html"
        )
```

Table 6...

```{r}
#| label: tbl-table006
#| results: asis
#| cache: false
#| tbl-cap: Multilevel regression for macro factors and general social cohesion
 
htmlreg(g_demo, digits=3,custom.coef.map = coef_names,caption = NULL,
        # file = "output/table006.html"
        )
```

# Interactions Interaciones de wave*macro_variable

```{r modelo-cohesion-int}
#| cache: true
#| results: asis
#| eval: true
load("input/proc/datos-fit.rdata")
library(lme4)
library(texreg)
library(dplyr)
library(correlation)
isced_labels <- c(
  "Early education/none",
  "Primary",
  "Lower secondary",
  "Upper secondary",
  "Postsecondary non-terciary",
  "Terciary (short-cycle)",
  "Universitary"
)

datos_fit$isced11 <- car::recode(datos_fit$escolaridad, 
"0 = 0;1:6 = 1;7:9 = 2;10:12 = 3;13:14 = 4;15:16 = 5;17:18 = 6")

datos_fit$isced11 <- factor(
  datos_fit$isced11,
  levels = 0:6,
  labels = isced_labels
)
datos_fit <- 
datos_fit %>% 
  select(cohesion_general_ind, cohesion_vertical_ind, cohesion_horizontal_ind,
         nivel_educ, sexo, edad_c, ola_s, pos_politica,ola,
         income_decile,isced11,escolaridad,
         pib_we, gini_we, dem_we, wgi_we, mig_we,fho_we,
         pib_be, gini_be, dem_be, wgi_be, mig_be,fho_be, 
         country_wave, pais, wt) %>% na.omit() %>% 
  filter(!pais %in% c("Canada","United States"))

# datos_fit$dem_be <- datos_fit$fho_be
# datos_fit$dem_we <- datos_fit$fho_we

coef_names <- list(
  ola = "Time",
  gini_be = "Gini (BE)",
  gini_we = "Gini (WE)",
  pib_be = "GDP (BE)",
  pib_we = "GDP (WE)",
  dem_be = "Democracy (BE)",
  dem_we = "Democracy (WE)",
  wgi_be = "Governace (BE)",
  wgi_we = "Governace (WE)",
  mig_be = "Migration (BE)",
  mig_we = "Migration (WE)"
)

hz_1 <- lmer(cohesion_horizontal_ind ~ 1 + income_decile + isced11 + sexo + edad_c + I(edad_c^2) + pos_politica + ola +  gini_be*ola+gini_we*ola+pib_be+pib_we+dem_be+dem_we+wgi_be+wgi_we+mig_be+mig_we+(1 | country_wave) + (ola| pais), data= datos_fit, weights= wt)
hz_2 <- lmer(cohesion_horizontal_ind ~ 1 + income_decile + isced11 + sexo + edad_c + I(edad_c^2) + pos_politica + ola +  gini_be+gini_we+pib_be+pib_we+dem_be*ola+dem_we*ola+wgi_be+wgi_we +mig_be+mig_we+(1 | country_wave) + (ola| pais), data= datos_fit, weights= wt)
hz_3 <- lmer(cohesion_horizontal_ind ~ 1 + income_decile + isced11 + sexo + edad_c + I(edad_c^2) + pos_politica + ola +  gini_be+gini_we+pib_be+pib_we+dem_be+dem_we+wgi_be*ola+wgi_we*ola+mig_be+mig_we+(1 | country_wave) + (ola| pais), data= datos_fit, weights= wt)
hz_4 <- lmer(cohesion_horizontal_ind ~ 1 + income_decile + isced11 + sexo + edad_c + I(edad_c^2) + pos_politica + ola +  gini_be+gini_we+pib_be+pib_we+dem_be+dem_we+wgi_be+wgi_we+mig_be*ola+mig_we*ola+(1 | country_wave) + (ola| pais), data= datos_fit, weights= wt)

hz_ola <- list(hz_1,hz_2,hz_3,hz_4)
# screenreg(hz_ola,digits=3)
htmlreg(hz_ola,digits=3)
vt_1 <- update(hz_1,cohesion_vertical_ind ~ . )
vt_2 <- update(hz_2,cohesion_vertical_ind ~ . )  
vt_3 <- update(hz_3,cohesion_vertical_ind ~ . ) #ola:wgi_we =  -0.144 *
vt_4 <- update(hz_4,cohesion_vertical_ind ~ . )

vt_ola <- list(vt_1,vt_2,vt_3,vt_4)
# screenreg(vt_ola,digits=3)
htmlreg(vt_ola,digits=3)

cg_1 <- update(hz_1,cohesion_general_ind ~ . )
cg_2 <- update(hz_2,cohesion_general_ind ~ . )  
cg_3 <- update(hz_3,cohesion_general_ind ~ . ) # #ola:wgi_we =  -0.100 *
cg_4 <- update(hz_4,cohesion_general_ind ~ . )

cg_ola <- list(cg_1,cg_2,cg_3,cg_4)
# screenreg(cg_ola,digits=3)
htmlreg(cg_ola,digits=3)
```


Así...

* Cohesion H y V 
* Intermedio educación como ref
* TT ? qué hacer
* cambiar años a numerico 1,2,3,4
* todas las iteraciones la mismo tiempo y ver que pasa
* si alguna de las interacciones no es ninguna de las dos cohesiones 
  - para las interaccines que son son significativas dejarlas, las otras no 
* Plot: 


```{r}
#| label: tbl-modelos-cohesion
#| results: asis
#| echo: false
#| eval: false
#| cache: true
load("input/proc/datos-fit.rdata")
library(lme4)
library(texreg)
library(dplyr)

# datos_fit$ola<- factor(datos_fit$ola)
datos_fit_la <- datos_fit %>% filter(!pais %in% c("Canada","United States"))
# Socioeconomic dimensions------------------------------------------------------
micro <- lmer(cohesion_horizontal_ind ~ 1 + isced11 + sexo + edad_c + I(edad_c^2) + pos_politica + ola + (1 | country_wave) + (1 | pais), data= datos_fit, weights= wt)
macro_gini <- update(micro,. ~ . + gini_be + gini_we)
macro_gdp <- update(micro,. ~ . + pib_be + pib_we)
macro_econ <- update(micro,. ~ . + gini_be+gini_we+pib_be+pib_we)
# macro_econ_la_h <- update(macro_econ,data=datos_fit_la) #using only LATAM
h_econ <- list(macro_gini,macro_gdp,macro_econ)

micro <- lmer(cohesion_vertical_ind ~ 1 + isced11 + sexo + edad_c + I(edad_c^2) + pos_politica + ola + (1 | country_wave) + (1 | pais), data= datos_fit, weights= wt)
macro_gini <- update(micro,. ~ . + gini_be + gini_we)
macro_gdp <- update(micro,. ~ . + pib_be + pib_we)
macro_econ <- update(micro,. ~ . + gini_be+gini_we+pib_be+pib_we)
# macro_econ_la_v <- update(macro_econ,data=datos_fit_la) #using only LATAM
v_econ <- list(macro_gini,macro_gdp,macro_econ)

# screenreg(c(h_econ,v_econ))

htmlreg(c(h_econ,v_econ),single.row = F,digits = 3,
       # file = "output/table001.html",
        caption.above = T,
        caption = "Multilevel regression for socioeconomic macro factors and social cohesion", 
          custom.coef.map = 
            list(
              gini_be ="Gini (BE)",
              gini_we ="Gini (WE)",
              pib_be = "GDP (BE)", 
              pib_we = "GDP (WE)",
              # ola2006 = "Time (ref.= 2004) 2006",
              # ola2008 = "2008",
              # ola2010 = "2010",
              # ola2012 = "2012",
              # ola2014 = "2014",
              # ola2016 = "2016",
              # ola2018 = "2018",
              # ola2023 = "2023"   
              ola = "Time"              
            ),custom.header = list("Horizontal"=1:3,"Vertical"=4:6),
          custom.gof.rows = 
            list(Controls=c("Yes","Yes","Yes","Yes","Yes","Yes"))
          )

# Political dimensions------------------------------------------------------
micro <- lmer(cohesion_horizontal_ind ~ 1 + nivel_educ + sexo + edad_c + I(edad_c^2) + pos_politica + ola + (1 | country_wave) + (1 | pais), data= datos_fit, weights= wt)
macro_dem <- update(micro,. ~ . + dem_be + dem_we)
macro_wgi <- update(micro,. ~ . + wgi_be + wgi_we)
macro_pol <- update(micro,. ~ . + dem_be+dem_we+wgi_be + wgi_we)
# macro_pol_la_v <- update(macro_pol,data=datos_fit_la) #using only LATAM
h_pol <- list(macro_dem,macro_wgi,macro_pol)

micro <- lmer(cohesion_vertical_ind ~ 1 + nivel_educ + sexo + edad_c + I(edad_c^2) + pos_politica + ola + (1 | country_wave) + (1 | pais), data= datos_fit, weights= wt)
macro_dem  <- update(micro,. ~ . + dem_be + dem_we)
macro_wgi <- update(micro,. ~ . + wgi_be + wgi_we)
macro_pol  <- update(micro,. ~ . + dem_be+dem_we+wgi_be + wgi_we)
# macro_pol_la_h <- update(macro_pol,data=datos_fit_la) #using only LATAM

v_pol <- list(macro_dem,macro_wgi,macro_pol)

#screenreg(c(h_pol,v_pol))
htmlreg(c(h_pol,v_pol),single.row = F,digits = 3,
        # file = "output/table002.html",
        caption.above = T,
        caption = "Multilevel regression for institutional macro factors and social cohesion", 
          custom.coef.map = 
            list(
              dem_be ="Democracy (BE)",
              dem_we ="Democracy (WE)",
              wgi_be = "Governace (BE)", 
              wgi_we = "Governace (WE)",
              # ola2006 = "Time (ref.= 2004) 2006",
              # ola2008 = "2008",
              # ola2010 = "2010",
              # ola2012 = "2012",
              # ola2014 = "2014",
              # ola2016 = "2016",
              # ola2018 = "2018",
              # ola2023 = "2023"
              ola = "Time"
            ),custom.header = list("Horizontal"=1:3,"Vertical"=4:6),
          custom.gof.rows = 
            list(Controls=c("Yes","Yes","Yes","Yes","Yes","Yes"))          
          )

# Demographic ------------------------------------------------------------------
micro <- lmer(cohesion_horizontal_ind ~ 1 + nivel_educ + sexo + edad_c + I(edad_c^2) + pos_politica + ola + (1 | country_wave) + (1 | pais), data= datos_fit, weights= wt)
macro_mig <- update(micro,. ~ . + mig_be + mig_we)
# macro_mig_time <- update(micro,. ~ . + mig_be*ola + mig_we*ola)
h_demo <- list(macro_mig)

micro <- lmer(cohesion_vertical_ind ~ 1 + nivel_educ + sexo + edad_c + I(edad_c^2) + pos_politica + ola + (1 | country_wave) + (1 | pais), data= datos_fit, weights= wt)
macro_mig <- update(micro,. ~ . + mig_be + mig_we)
# macro_mig_time <- update(micro,. ~ . + mig_be*ola + mig_we*ola)
v_demo <- list(macro_mig)

#screenreg(c(h_demo,v_demo))
htmlreg(c(h_demo,v_demo),single.row = F,digits = 3,
        # file = "output/table003.html",
        caption.above = T,
        caption = "Multilevel regression for demographic macro factors and social cohesion", 
          custom.coef.map = 
            list(mig_be ="Migration (BE)",
                 mig_we = "Migration (WE)",
              # ola2006 = "Time (ref.= 2004) 2006",
              # ola2008 = "2008",
              # ola2010 = "2010",
              # ola2012 = "2012",
              # ola2014 = "2014",
              # ola2016 = "2016",
              # ola2018 = "2018",
              # ola2023 = "2023"
              ola = "Time"
              ),
          ,custom.header = list("Horizontal"=1,"Vertical"=2),
          custom.gof.rows = 
            list(Controls=c("Yes","Yes"))          
          )
```


