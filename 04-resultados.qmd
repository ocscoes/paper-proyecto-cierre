---
output: html_document
editor_options: 
  chunk_output_type: console
---

<!-- Please run the following chunks before running the models  -->

```{r}
#| echo: false
## cargar base
library(tidyverse)
load("input/proc/micro-macro-merge.rdata")

datos_merge <- datos_merge |>
  mutate(across(where(haven::is.labelled), ~ vctrs::vec_data(.)),
         pais= as.factor(pais))

datos_merge$country_wave = do.call(paste, c(datos_merge[c("pais", "ola")], sep = "_"))
```

```{r data-fig-macro}
set1 <-  RColorBrewer::brewer.pal(n = 8, name = "Set1")
options(ggplot2.discrete.fill = set1)
options(ggplot2.discrete.colour = set1)
ggplot2::theme_set(ggplot2::theme_bw())
ggplot2::theme_update(text=ggplot2::element_text(size=15,  family="serif"))    
options(scipen=999)
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,ggplot2,haven,ggrepel,gridExtra,grid)  
rm(list=ls())

load("input/proc/micro-macro-merge.rdata")

datos_merge <- datos_merge |>
  mutate(across(where(haven::is.labelled), ~ vctrs::vec_data(.)),
         pais= as.factor(pais))

datos_merge$country_wave = do.call(paste, c(datos_merge[c("pais", "ola")], sep = "_"))

wid_data <- haven::read_dta(file = "input/proc/wid_data.dta")
wid_data <- wid_data %>% mutate(yr2=substr(year, 3, 4)) %>% rename(iso2c=country)
datos_merge$iso2c<- countrycode::countrycode(sourcevar = datos_merge$pais,origin = "country.name",destination = "iso2c")
wid_data$iso2c <- as.character(wid_data$iso2c)
datos_merge$yr2<- substr(datos_merge$ola, 3, 4)
datos_merge<- 
left_join(x = datos_merge,y = wid_data[,c("iso2c","yr2","wid_gini_disp")],
          by =c("iso2c","yr2"))

datos_macro <- datos_merge %>%
  mutate(
   cohesion_horizontal,
      cohesion_vertical,
      cohesion_general,
      gini_index,
      wid_gini_disp,  
      pib_per_capita_ppa,
      log_pib_per_capita_ppa,
      percent_pob_migrante,
      indice_v_dem,
      regulatory_quality,
      voice_and_accountability,
      wgi,
    edad_c = scale(edad) %>% as.numeric(),
    ola_s = as.numeric(scale(ola, center = TRUE, scale = TRUE)),
   income_decile,
    ola,
    nivel_educ   = forcats::fct_drop(factor(nivel_educ)),
    pos_politica = forcats::fct_drop(factor(pos_politica)),
    sexo         = forcats::fct_drop(factor(sexo)),
    pais         = forcats::fct_drop(factor(pais)),
    country_wave = forcats::fct_drop(factor(country_wave))
  ) %>% 
    select(cohesion_horizontal,
      cohesion_vertical,
      cohesion_general,
      gini_index,wid_gini_disp,
      pib_per_capita_ppa,
      log_pib_per_capita_ppa,
      percent_pob_migrante,
      indice_v_dem,
      regulatory_quality,
      voice_and_accountability,wgi,
      income_decile,
         nivel_educ, sexo, edad_c, ola_s,ola, pos_politica,iso2c,
         country_wave, pais, wt)

# dim(datos_macro);dim(na.omit(datos_macro))
datos_macro$yr2<- substr(datos_macro$ola, 3, 4)

df_sum <- datos_macro %>%
  group_by(iso2c, yr2) %>%
  summarise(across(
    c(cohesion_horizontal,
      cohesion_vertical,
      cohesion_general,
      gini_index,wid_gini_disp,
      pib_per_capita_ppa,
      log_pib_per_capita_ppa,
      percent_pob_migrante,
      indice_v_dem,
      wgi),
    mean,
    na.rm = TRUE
  )) %>%
  ungroup() 
df_sum <- 
 df_sum %>% 
  group_by(iso2c) %>%
  mutate(across(
    c(cohesion_horizontal,
      cohesion_vertical,
      cohesion_general,
      gini_index,wid_gini_disp,
      pib_per_capita_ppa,
      log_pib_per_capita_ppa,
      percent_pob_migrante,
      indice_v_dem,
      wgi),
    mean,
    na.rm = TRUE,
    .names = "mid_{.col}"
  )) %>%
  ungroup()

df_sum$ctyear <- paste0(df_sum$iso2c,df_sum$yr2)
```

```{r data-model-fit}
#| label: preparacion-datos
#| eval: false

# Separar los efectos
datos_merge <- datos_merge |>
  group_by(pais) |>
 mutate(pib_be = mean(log_pib_per_capita_ppa, na.rm=T),
         # gini_be = mean(gini_index, na.rm=T),
         gini_be = mean(wid_gini_disp, na.rm=T),
         mig_be = mean(percent_pob_migrante, na.rm=T),
         dem_be = mean(indice_v_dem, na.rm=T),
         wgi_be = mean(wgi, na.rm=T),
         # edu_be = mean(edu_terciaria, na.rm=T)
        ) |>
  ungroup() |>
  mutate(pib_we = log_pib_per_capita_ppa - pib_be,
          # gini_we = gini_index - gini_be,
          gini_we = wid_gini_disp - gini_be,
          mig_we = percent_pob_migrante - mig_be,
          dem_we = indice_v_dem - dem_be,
          wgi_we = wgi- wgi_be,
          # edu_we = edu_terciaria-edu_be
         )

# Centrado y limpieza

z <- function(x) as.numeric(scale(x))

datos_fit <- datos_merge %>%
  mutate(
    # pib_we  = z(pib_we),   gini_we = z(gini_we), wgi_we = z(wgi_we), dem_we = z(dem_we),
    # mig_we  = z(mig_we),   edu_we = z(edu_we),
    # pib_be  = z(pib_be),   gini_be = z(gini_be), wgi_be = z(wgi_be), dem_be = z(dem_be),
    # mig_be  = z(mig_be),   edu_be = z(edu_be),
    edad_c = scale(edad) %>% as.numeric(),
    ola_s = as.numeric(scale(ola, center = TRUE, scale = TRUE)),
    ola,
    nivel_educ   = forcats::fct_drop(factor(nivel_educ)),
    pos_politica = forcats::fct_drop(factor(pos_politica)),
    sexo         = forcats::fct_drop(factor(sexo)),
    pais         = forcats::fct_drop(factor(pais)),
    country_wave = forcats::fct_drop(factor(country_wave)),

    # --- cambiar categoría de referencia ---
    nivel_educ   = forcats::fct_relevel(nivel_educ, "Primary"),   # ejemplo
    pos_politica = forcats::fct_relevel(pos_politica, "Not declared")         # ejemplo
  ) |>
  select(cohesion_general_ind, cohesion_vertical_ind, cohesion_horizontal_ind,
         nivel_educ, sexo, edad_c, ola_s, pos_politica,ola,
         income_decile,
         pib_we, gini_we, dem_we, wgi_we, mig_we, 
         pib_be, gini_be, dem_be, wgi_be, mig_be, 
         country_wave, pais, wt) %>% 
  na.omit()


save(datos_fit, file="input/proc/datos-fit.rdata")
```

# Resultados

## Análisis Factorial Confirmatorio

```{r fit-cfa}
#| eval: false
library(lavaan)

# confianza_it_ind     = row_mean_if_complete(cur_data(), c("it1"), 1L),
# seguridad_ind        = row_mean_if_complete(cur_data(), c("aoj11","vic1ext"), 2L),
# confianza_inst_ind   = row_mean_if_complete(cur_data(), c("b13","b21","b31"), 2L),  
# democracia_ind       = row_mean_if_complete(cur_data(), c("ing4","pn4"), 2L)        
load("input/proc/micro-macro-merge.rdata")

m1 <- '
seguridad_ind =~ aoj11+vic1ext
# confianza_it_ind =~ it1
confianza_inst_ind =~ b13+b21+b31
democracia_ind =~ ing4+pn4

ch =~ seguridad_ind + it1
cv =~ confianza_inst_ind + democracia_ind
'
m1_cfa <- cfa(m1, data = datos_merge[,c("aoj11","vic1ext","it1","b13","b21","b31","ing4","pn4","pais")],cluster = "pais")
screenreg(m1_cfa)
semPlot::semPaths(m1_cfa,what = "std")
fitmeasures(m1_cfa, fit.measures = c("rmsea", "cfi", "chisq", "pvalue", "df"))
# save(m1_cfa, file="output/cfa.rdata")
```

```{r}
#| label: fig-afc
#| fig-width: 10
#| fig-height: 5
#| fig-cap: Análisis Factorial Confirmatorio Modelo de Medición de Cohesión Social
set1 <-  RColorBrewer::brewer.pal(n = 8, name = "Set1")
options(ggplot2.discrete.fill = set1)
options(ggplot2.discrete.colour = set1)
ggplot2::theme_set(ggplot2::theme_bw())
ggplot2::theme_update(text=ggplot2::element_text(size=15,  family="serif"))  

library(semPlot)
library(tidySEM)
library(lavaan)

m1 <- '
  ch =~ seguridad_ind + confianza_it_ind
  cv =~ confianza_inst_ind + democracia_ind
'
m1_cfa <- cfa(m1, data = datos_merge)
# summary(m1_cfa, standardized = TRUE, fit.measures = TRUE)


fit <- fitmeasures(m1_cfa, fit.measures = c("rmsea", "cfi", "chisq", "pvalue", "df"))

# ?graph_sem(m1_cfa)

fit_edges<- get_edges(m1_cfa)
fit_edges$label <- fit_edges$est_sig_std

fit_nodes<- get_nodes(m1_cfa)
fit_nodes$label <- c("Horizontal","Vertical",
                     "Security","Interpersonal\nTrust",
                     "Institutional\nTrust","Democracy")

fit_layout<- get_layout("","ch","",  "","cv"," ",
                  "confianza_it_ind","","seguridad_ind",
                  "democracia_ind","","confianza_inst_ind", rows = 2)


fit_layout<- get_layout("confianza_it_ind","","", "democracia_ind",
                        "","ch","cv","",
                        "seguridad_ind" ,"","", "confianza_inst_ind", rows = 3)

fit_nodes$label_size = 4
fit_nodes$label_family = "serif"
graph_sem(m1_cfa,edges = fit_edges,layout=fit_layout,nodes=fit_nodes) + 
  labs(caption = paste0(
  "Note: RMSEA = ", round(fit["rmsea"], 3),
  ", CFI = ", round(fit["cfi"], 3),
  ", Chi-square = ", round(fit["chisq"], 2),
  ", df = ", fit["df"],
  ", p-value = ", round(fit["pvalue"], 4), "."
))
```

En @fig-afc se presentan los resultados del análisis factorial confirmatorio hecho a partir del modelo de medición propuesto. En primer lugar, se observa que los indicadores presentan cargas factoriales moderadas, las cuales van del 0.45 al 0.6 dependiendo del caso, lo que sugiere que los indicadores reflejan parcialmente las dimensiones latentes. Los índices de ajuste son de buena calidad, apuntando a una fiabilidad del constructo. Ahora, dado que el modelo cuenta con un solo grado de libertad, las medidas de ajuste global deben interpretarse con precaución. En suma, el modelo ofrece un ajuste aceptable a nivel identificacional, pero la validez de los factores son limitadas, lo que podría solucionarse aumentando el número o la calidad de los indicadores en futuras mediciones.


## Descriptivos

A continuación se presentan los resultados descriptivos sobre los cambios de la cohesión social en América Latina en las últimas dos décadas.

```{r}
#| label: fig-cs
#| fig-cap: Evolución dimensiones Cohesión Social (2004-2022)
olas <- datos_merge |>
  group_by(ola) |>
  summarise(horizontal_prom = mean(`cohesion_horizontal_ind`, na.rm=T),
            vertical_prom = mean(`cohesion_vertical_ind`, na.rm=T),
            cohesion_prom = mean(`cohesion_general_ind`, na.rm=T)) |>
  pivot_longer(
    cols = c(horizontal_prom, vertical_prom, cohesion_prom),
    names_to = "indicador",
    values_to = "promedio"
  ) |>
  mutate(indicador = dplyr::recode(indicador,
                            horizontal_prom = "Horizontal Cohesion",
                            vertical_prom = "Vertical Cohesion",
                            cohesion_prom = "General Cohesion"))

olas$ola <- factor(olas$ola)
plot_cs <- olas |>
  ggplot(aes(x = ola, y = promedio, color = indicador,group = indicador)) +
  geom_line(linewidth = 1) +
  geom_point() +
  scale_y_continuous(limits = c(2,8))+
  labs(x = "Wave", y = "Social cohesion (1-10)", color = NULL) +
  theme_minimal() +
  theme(legend.position = "bottom")

plot_cs
```

En @fig-cs se visualizan los promedios de cada año para los distintos tipos de cohesión. En primer lugar, se puede observar que la cohesión horizontal mantiene un patrón ascendente entre 2004 y 2012, exceptuando la caída del año 2010. Posterior a esto, la cohesión horizontal se enfrenta a una decaída sostenida hasta el 2018, para luego volver a repuntar e incluso superando su nivel registrado en 2004. La cohesión vertical presenta un patrón de variación parecido al de la cohesión horizontal, evidenciando un alza persistente en el tiempo hasta el año 2012, donde luego sufre una caída abrupta a nivel regional. Este descenso se mantuvo hasta el 2016, donde luego se revertiría esta dinámica, notándose un aumento de la cohesión vertical hasta el último año registrado. Si bien, la última medición de la cohesión vertical muestra niveles superiores al del inicio, sus puntuaciones en general son considerablemente bajas al compararlas con la cohesión horizontal, diferenciándose en todas las olas por aproximadamente 1.5 puntos. En suma, en América Latina se denota una mayor cohesión horizontal por sobre la vertical de manera consistente desde el 2004 hasta el 2022[³]. 

[³]: Cabe mencionar que la cohesión social (recta verde) es el promedio de la cohesión vertical y horizontal, por ello no se detalla su interpretación.

```{r}
#| label: fig-ch
#| fig-cap: Evolución dimensiones Cohesión Horizontal (2004-2022)
olas <- datos_merge |>
  group_by(ola) |>
  summarise(seguridad_prom = mean(seguridad_ind, na.rm=T),
            confianza_prom = mean(confianza_it_ind, na.rm=T)) |>
  pivot_longer(
    cols = c(confianza_prom, seguridad_prom),
    names_to = "indicador",
    values_to = "promedio"
  ) |>
  mutate(indicador = dplyr::recode(indicador,
                            "confianza_prom" = "Confianza Interpersonal",
                            "seguridad_prom" = "Seguridad Pública"))
olas |>
  ggplot(aes(x = ola, y = promedio, color=indicador)) +
  geom_line(linewidth = 1) +
  geom_point() +
  labs(x = "Ola", y = "Promedio", color=NULL) +
  theme_minimal() + 
  theme(legend.position = "bottom")

```

En @fig-ch se presentan los promedios por año de las subdimensiones horizontales, seguridad pública y confianza interpersonal. En la seguridad pública se observa un patrón inestable entre los años 2004 y 2012, marcado por descensos y ascensos alternados. Posterior a 2012 se evidencia un fuerte deterioro en la subdimensión hasta 2018, viéndose un repunte después de este año, sin embargo, la recuperación no logra llegar a los niveles de seguridad que existían en un principio. La confianza interpersonal, por su parte, presenta un aumento hasta el 2010, año en el que sufre una leve caída, pero el año siguiente volviendo a ascender. Post 2012 se observa un patrón similar al de seguridad pública, con un descenso sostenido hasta el año 2018 para luego recuperarse. Una de las principales diferencias entre las dos subdimensiones es que, mientras en 2022 seguridad pública registró un promedio inferior al de la primera ola, los niveles de confianza interpersonal en 2022 fueron mayores que los de 2004. 

```{r}
#| label: fig-cv
#| fig-cap: Evolución dimensiones Cohesión Vertical (2004-2022)

olas <- datos_merge |>
  group_by(ola) |>
  summarise(confianza_prom = mean(confianza_inst_ind, na.rm=T),
            democracia_prom = mean(democracia_ind, na.rm=T)) |>
  pivot_longer(
    cols = c(confianza_prom, democracia_prom),
    names_to = "indicador",
    values_to = "promedio"
  ) |>
  mutate(indicador = dplyr::recode(indicador,
                            "confianza_prom" = "Confianza en las Instituciones",
                            "democracia_prom" = "Actitudes hacia la democracia"))
olas |>
  ggplot(aes(x = ola, y = promedio, color=indicador)) +
  geom_line(linewidth = 1) +
  geom_point() +
  labs(x = "Ola", y = "Promedio", color=NULL) +
  theme_minimal() + 
  theme(legend.position = "bottom")

```

En @fig-cv están graficados los cambios en el tiempo de las dos subdimensiones de cohesión vertical. Actitud hacia la democracia presenta un alza sostenida hasta el 2008, donde luego sufre una caída paulatina, destacándose un descenso abrupto entre 2014 y 2016. Posterior a esto, las afecciones hacia la democracia evidencian nuevamente un ascenso en sus niveles regionales, sin embargo, no logra alcanzar sus niveles iniciales. En confianza en instituciones se observan niveles ascendentes desde 2004 hasta 2012, a excepción de la baja del 2008. Los años siguientes se evidencia un decrecimiento en la confianza institucional hasta el 2016, para luego demostrar un repunte hasta el último año registrado, llegando a superar los niveles de confianza en instituciones del 2004. 

## Relationship between and within country level factors with social cohesión

```{r fig-macro}
#| fig-width: 12
#| fig-height: 22
#| fig-cap: "Country-level association of macro-level factors and social cohesion. Red line represents the association including Canada and United States."
library(ggrepel)

df_sum_la <-  df_sum %>% filter(!iso2c %in% c("US","CA"))

fig_gini_h <-
  ggplot() +
  geom_smooth(data = df_sum, method = lm, se = FALSE,
              aes(mid_wid_gini_disp, y = mid_cohesion_horizontal),
              color = "red") +
  geom_smooth(data = df_sum_la, method = lm, se = FALSE,
              aes(mid_wid_gini_disp, y = mid_cohesion_horizontal),
              color = "pink") +
  geom_smooth(data = df_sum,
              aes(x = wid_gini_disp, y = cohesion_horizontal, color = iso2c, shape = iso2c),
              method = "lm", se = FALSE, color = "black") +
  geom_point(data = df_sum, aes(x = mid_wid_gini_disp, y = mid_cohesion_horizontal)) +
  geom_label(data = df_sum, aes(x = mid_wid_gini_disp, y = mid_cohesion_horizontal, label = iso2c),
            color = "black") +
  scale_y_continuous(limits = c(2,8))+  
  labs(x = "Economic Inequality", y = " ", title = "Horizontal Cohesion") +
  annotate("label",
           x = Inf, y = Inf,               
           hjust = 1.08, vjust = 1.7,      
           label = paste0("r = ", round(cor(df_sum$mid_wid_gini_disp,df_sum$mid_cohesion_horizontal,use = "complete.obs"), 2)),
           fill = "white",                 
           color = "black",                
           label.size = 0.25,family = "serif",
           size = 3.5)                     

fig_gdp_h <-
  ggplot() +
  geom_smooth(data = df_sum, method = lm, se = FALSE, aes(mid_pib_per_capita_ppa, y = mid_cohesion_horizontal), color = "red") +
  geom_smooth(data = df_sum_la, method = lm, se = FALSE, aes(mid_pib_per_capita_ppa, y = mid_cohesion_horizontal), color = "pink") +
  geom_smooth(data = df_sum, aes(x = pib_per_capita_ppa, y = cohesion_horizontal, color = iso2c, shape = iso2c), method = "lm", se = FALSE,color = "black") +
  geom_point(data = df_sum, aes(x = mid_pib_per_capita_ppa, y = mid_cohesion_horizontal)) +
  geom_label(data = df_sum, aes(x = mid_pib_per_capita_ppa, y = mid_cohesion_horizontal, label = iso2c), color = "black") +
  scale_y_continuous(limits = c(2,8))+
  labs(x = "GDP per Capita (PPP)", y = " ", title = " ") + 
    annotate("label",
           x = Inf, y = Inf,               
           hjust = 1.08, vjust = 1.7,      
           label = paste0("r = ", round(cor(df_sum$mid_pib_per_capita_ppa, df_sum$mid_cohesion_horizontal, use = "complete.obs"), 2)),
           fill = "white",                 
           color = "black",                
           label.size = 0.25,family = "serif",
           size = 3.5)   

fig_mig_h <-
  ggplot() +
  geom_smooth(data = df_sum, method = lm, se = FALSE, aes(mid_percent_pob_migrante, y = mid_cohesion_horizontal), color = "red") +
  geom_smooth(data = df_sum_la, method = lm, se = FALSE, aes(mid_percent_pob_migrante, y = mid_cohesion_horizontal), color = "pink") +
  geom_smooth(data = df_sum, aes(x = percent_pob_migrante, y = cohesion_horizontal, color = iso2c, shape = iso2c), method = "lm", se = FALSE,color = "black") +
  geom_point(data = df_sum, aes(x = mid_percent_pob_migrante, y = mid_cohesion_horizontal)) +
  geom_label(data = df_sum, aes(x = mid_percent_pob_migrante, y = mid_cohesion_horizontal, label = iso2c), color = "black") +
  scale_y_continuous(limits = c(2,8))+  
  labs(x = "Migrant Population (%)", y = " ", title = " ") +
      annotate("label",
           x = Inf, y = Inf,               
           hjust = 1.08, vjust = 1.7,      
           label = paste0("r = ", round(cor(df_sum$mid_percent_pob_migrante, df_sum$mid_cohesion_horizontal, use = "complete.obs"), 2)),
           fill = "white",                 
           color = "black",                
           label.size = 0.25,family = "serif",
           size = 3.5) 

fig_vdem_h <-
  ggplot() +
  geom_smooth(data = df_sum, method = lm, se = FALSE, aes(mid_indice_v_dem, y = mid_cohesion_horizontal), color = "red") +
  geom_smooth(data = df_sum_la, method = lm, se = FALSE, aes(mid_indice_v_dem, y = mid_cohesion_horizontal), color = "pink") +
  geom_smooth(data = df_sum, aes(x = indice_v_dem, y = cohesion_horizontal, color = iso2c, shape = iso2c), method = "lm", se = FALSE,color = "black") +
  geom_point(data = df_sum, aes(x = mid_indice_v_dem, y = mid_cohesion_horizontal)) +
  geom_label(data = df_sum, aes(x = mid_indice_v_dem, y = mid_cohesion_horizontal, label = iso2c), color = "black") +
  scale_y_continuous(limits = c(2,8))+  
  labs(x = "Democracy", y = " ", title = " ")+
        annotate("label",
           x = Inf, y = Inf,               
           hjust = 1.08, vjust = 1.7,      
           label = paste0("r = ", round(cor(df_sum$mid_indice_v_dem, df_sum$mid_cohesion_horizontal, use = "complete.obs"), 2)),
           fill = "white",                 
           color = "black",                
           label.size = 0.25,family = "serif",
           size = 3.5) 

fig_wdi_h <-
  ggplot() +
  geom_smooth(data = df_sum, method = lm, se = FALSE, aes(mid_wgi, y = mid_cohesion_horizontal), color = "red") +
  geom_smooth(data = df_sum_la, method = lm, se = FALSE, aes(mid_wgi, y = mid_cohesion_horizontal), color = "pink") +
  geom_smooth(data = df_sum, aes(x = wgi, y = cohesion_horizontal, color = iso2c, shape = iso2c), method = "lm", se = FALSE,color = "black") +
  geom_point(data = df_sum, aes(x = mid_wgi, y = mid_cohesion_horizontal)) +
  geom_label(data = df_sum, aes(x = mid_wgi, y = mid_cohesion_horizontal, label = iso2c), color = "black") +
  scale_y_continuous(limits = c(2,8))+  
  labs(x = "Governance", y = " ", title = " ") +
        annotate("label",
           x = Inf, y = Inf,               
           hjust = 1.08, vjust = 1.7,      
           label = paste0("r = ", round(cor(df_sum$mid_wgi, df_sum$mid_cohesion_horizontal, use = "complete.obs"), 2)),
           fill = "white",                 
           color = "black",                
           label.size = 0.25,family = "serif",
           size = 3.5) 
  

fig_gini_v <-
  ggplot() +
  geom_smooth(data = df_sum, method = lm, se = FALSE, aes(mid_wid_gini_disp, y = mid_cohesion_vertical), color = "red") +
  geom_smooth(data = df_sum_la, method = lm, se = FALSE, aes(mid_wid_gini_disp, y = mid_cohesion_vertical), color = "pink") +
  geom_smooth(data = df_sum, aes(x = wid_gini_disp, y = cohesion_vertical, color = iso2c, shape = iso2c), method = "lm", se = FALSE, color = "black") +
  geom_point(data = df_sum, aes(x = mid_wid_gini_disp, y = mid_cohesion_vertical)) +
  geom_label(data = df_sum, aes(x = mid_wid_gini_disp, y = mid_cohesion_vertical, label = iso2c), color = "black") +
  scale_y_continuous(limits = c(2,8))+  
  labs(x = "Economic Inequality", y = " ",title = "Vertical Cohesion") +
          annotate("label",
           x = Inf, y = Inf,               
           hjust = 1.08, vjust = 1.7,      
           label = paste0("r = ", round(cor(df_sum$mid_wid_gini_disp, df_sum$mid_cohesion_vertical, use = "complete.obs"), 2)),
           fill = "white",                 
           color = "black",                
           label.size = 0.25,family = "serif",
           size = 3.5) 

fig_gdp_v <-
  ggplot() +
  geom_smooth(data = df_sum, method = lm, se = FALSE, aes(mid_pib_per_capita_ppa, y = mid_cohesion_vertical), color = "red") +
  geom_smooth(data = df_sum_la, method = lm, se = FALSE, aes(mid_pib_per_capita_ppa, y = mid_cohesion_vertical), color = "pink") +
  geom_smooth(data = df_sum, aes(x = pib_per_capita_ppa, y = cohesion_vertical, color = iso2c, shape = iso2c), method = "lm", se = FALSE, color = "black") +
  geom_point(data = df_sum, aes(x = mid_pib_per_capita_ppa, y = mid_cohesion_vertical)) +
  geom_label(data = df_sum, aes(x = mid_pib_per_capita_ppa, y = mid_cohesion_vertical, label = iso2c), color = "black") +
  scale_y_continuous(limits = c(2,8))+  
  labs(x = "GDP per Capita (PPP)", y = " ",title = " ") +
            annotate("label",
           x = Inf, y = Inf,               
           hjust = 1.08, vjust = 1.7,      
           label = paste0("r = ", round(cor(df_sum$mid_pib_per_capita_ppa, df_sum$mid_cohesion_vertical, use = "complete.obs"), 2)),
           fill = "white",                 
           color = "black",                
           label.size = 0.25,family = "serif",
           size = 3.5) 

fig_mig_v <-
  ggplot() +
  geom_smooth(data = df_sum, method = lm, se = FALSE, aes(mid_percent_pob_migrante, y = mid_cohesion_vertical), color = "red") +
  geom_smooth(data = df_sum_la, method = lm, se = FALSE, aes(mid_percent_pob_migrante, y = mid_cohesion_vertical), color = "pink") +
  geom_smooth(data = df_sum, aes(x = percent_pob_migrante, y = cohesion_vertical, color = iso2c, shape = iso2c), method = "lm", se = FALSE, color = "black") +
  geom_point(data = df_sum, aes(x = mid_percent_pob_migrante, y = mid_cohesion_vertical)) +
  geom_label(data = df_sum, aes(x = mid_percent_pob_migrante, y = mid_cohesion_vertical, label = iso2c), color = "black") +
  labs(x = "Migrant Population (%)", y = " ", title = " ") +
  scale_y_continuous(limits = c(2,8))+  
            annotate("label",
           x = Inf, y = Inf,               
           hjust = 1.08, vjust = 1.7,      
           label = paste0("r = ", round(cor(df_sum$mid_percent_pob_migrante, df_sum$mid_cohesion_vertical, use = "complete.obs"), 2)),
           fill = "white",                 
           color = "black",                
           label.size = 0.25,family = "serif",
           size = 3.5)   

fig_vdem_v <-
  ggplot() +
  geom_smooth(data = df_sum, method = lm, se = FALSE, aes(mid_indice_v_dem, y = mid_cohesion_vertical), color = "red") +
  geom_smooth(data = df_sum_la, method = lm, se = FALSE, aes(mid_indice_v_dem, y = mid_cohesion_vertical), color = "pink") +
  geom_smooth(data = df_sum, aes(x = indice_v_dem, y = cohesion_vertical, color = iso2c, shape = iso2c), method = "lm", se = FALSE, color = "black") +
  geom_point(data = df_sum, aes(x = mid_indice_v_dem, y = mid_cohesion_vertical)) +
  geom_label(data = df_sum, aes(x = mid_indice_v_dem, y = mid_cohesion_vertical, label = iso2c), color = "black") +
  scale_y_continuous(limits = c(2,8))+  
  labs(x = "Democracy", y = " ",title = " ") +
            annotate("label",
           x = Inf, y = Inf,               
           hjust = 1.08, vjust = 1.7,      
           label = paste0("r = ", round(cor(df_sum$mid_indice_v_dem, df_sum$mid_cohesion_vertical, use = "complete.obs"), 2)),
           fill = "white",                 
           color = "black",                
           label.size = 0.25,family = "serif",
           size = 3.5)     

fig_wdi_v <-
  ggplot() +
  geom_smooth(data = df_sum, method = lm, se = FALSE, aes(mid_wgi, y = mid_cohesion_vertical), color = "red") +
  geom_smooth(data = df_sum_la, method = lm, se = FALSE, aes(mid_wgi, y = mid_cohesion_vertical), color = "pink") +
  geom_smooth(data = df_sum, aes(x = wgi, y = cohesion_vertical, color = iso2c, shape = iso2c), method = "lm", se = FALSE, color = "black") +
  geom_point(data = df_sum, aes(x = mid_wgi, y = mid_cohesion_vertical)) +
  geom_label(data = df_sum, aes(x = mid_wgi, y = mid_cohesion_vertical, label = iso2c), color = "black") +
  scale_y_continuous(limits = c(2,8))+  
  labs(x = "Governance", y = " ",title = " ") +
            annotate("label",
           x = Inf, y = Inf,               
           hjust = 1.08, vjust = 1.7,      
           label = paste0("r = ", round(cor(df_sum$mid_wgi, df_sum$mid_cohesion_vertical, use = "complete.obs"), 2)),
           fill = "white",                 
           color = "black",                
           label.size = 0.25,family = "serif",
           size = 3.5)     
  

set.seed(1234)

grid.arrange(fig_gini_h,fig_gini_v,
             fig_gdp_h,fig_gdp_v,
             fig_vdem_h,fig_vdem_v,
             fig_wdi_h,fig_wdi_v,
             fig_mig_h,fig_mig_v,
             nrow = 5, ncol=2,
 bottom =textGrob("Source: LAPOP (2004-2023); descriptive statistics; figure report country level pearson correlation; the line is the fitted values; CI at 95%",
 gp = gpar(fontface = 1, fontsize = 9),hjust = 1,x = 1
  ))
```

## Differences and changes in country level factors and social cohesión

```{r}
#| eval: false
load("input/proc/datos-fit.rdata")
m0_ch = lmer(cohesion_horizontal_ind ~ 1 + (1 | country_wave) + (1 |pais), data=datos_fit, weights=wt)
icc(m0_ch, by_group=TRUE) # 2.3% y 5.6%
m0_cv = lmer(cohesion_vertical_ind ~ 1 + (1 | country_wave) + (1 |pais), data=datos_fit, weights=wt)
icc(m0_cv, by_group=TRUE) # 6.3% y 6.3%
m0_cs = lmer(cohesion_general_ind ~ 1 + (1 | country_wave) + (1 |pais), data=datos_fit, weights=wt)
icc(m0_cs, by_group=TRUE) # 4.9% y 7.5%
save(m0_ch, file="output/modelo_nulo_horizontal.rdata")
save(m0_cv, file="output/modelo_nulo_vertical.rdata")
save(m0_cs, file= "output/modelo_nulo_completo.rdata")
```

```{r}
#| label: tbl-modelos-cohesion-micro
#| results: asis
#| cache: true
#| tbl-cap: Multilevel regression for individual level factors and social cohesion
load("input/proc/datos-fit.rdata")
library(lme4)
library(texreg)
library(dplyr)

datos_fit_la <- datos_fit %>% filter(!pais %in% c("Canada","United States"))

# datos_fit$ola<- factor(datos_fit$ola)
micro_h <- lmer(cohesion_horizontal_ind ~ 1 + income_decile + nivel_educ + sexo + edad_c + I(edad_c^2) + pos_politica + ola +  (1 | country_wave) + (1 | pais), data= datos_fit, weights= wt)
micro_v <- lmer(cohesion_vertical_ind ~ 1 + income_decile + nivel_educ + sexo + edad_c + I(edad_c^2) + pos_politica + ola +  (1 | country_wave) + (1 | pais), data= datos_fit, weights= wt)

coef_names<- list("(Intercept)"="(Intercept)",
"income_decile" ="Income decile",                  
"nivel_educSecondary" = "Secondary", 
"nivel_educTertiary" = "Tertiary",   
"sexoMale"="Male (ref.=Female)",            
"edad_c"="Age",              
"I(edad_c^2)"="Age2",         
"pos_politicaLeft"="Left",    
"pos_politicaCenter"="Center",  
"pos_politicaRight"="Right",
# ola2006 = "2006",
# ola2008 = "2008",
# ola2010 = "2010",
# ola2012 = "2012",
# ola2014 = "2014",
# ola2016 = "2016",
# ola2018 = "2018",
# ola2023 = "2023"
ola = "Time"
)   

# micro_h_la<- update(micro_h, data = datos_fit_la)
# micro_v_la<- update(micro_v, data = datos_fit_la)
            
# screenreg(c(micro_h,micro_v))
#screenreg(c(micro_h,micro_v,micro_h_la,micro_v_la))

htmlreg(c(micro_h,micro_v),single.row = F,digits = 3,caption = NULL,
       # file = "output/table000.html",
       groups = 
         list("Education (ref.=Primary)"=3:4,
              "Political position (ref.=Undefined)"=8:10
              # "Time trend (ref.=2004)"=10:17
              ),
       custom.coef.map = coef_names,
       custom.header = list("Horizontal"=1,"Vertical"=2),
       custom.gof.rows = list("Controls"=c(rep("Yes",2))),include.loglik = FALSE,include.aic = FALSE,
       custom.gof.names = c(NA,NA,"Num. Country-wave","Num. Country","Var: Country-wave (Intercept)","Var: Country (Intercept)","Var: Residual")
)

```

```{r modelo-cohesion-full}
#| cache: true
#| results: asis
load("input/proc/datos-fit.rdata")
library(lme4)
library(texreg)
library(dplyr)
library(correlation)
datos_fit_la <- datos_fit %>% filter(!pais %in% c("Canada","United States"))

coef_names <- list(
  ola = "Time",
  gini_be = "Gini (BE)",
  gini_we = "Gini (WE)",
  pib_be = "GDP (BE)",
  pib_we = "GDP (WE)",
  dem_be = "Democracy (BE)",
  dem_we = "Democracy (WE)",
  wgi_be = "Governace (BE)",
  wgi_we = "Governace (WE)",
  mig_be = "Migration (BE)",
  mig_we = "Migration (WE)"
)

# corr_macro <- 
#   correlation::correlation(
#     dplyr::select(datos_fit,gini_be,gini_we,pib_be,pib_we,dem_be,dem_we,wgi_be,wgi_we,mig_be,mig_we)) 
# 
# display(summary(corr_macro),digits = 3,format = "markdown")

micro <- lmer(cohesion_horizontal_ind ~ 1 + income_decile + nivel_educ + sexo + edad_c + I(edad_c^2) + pos_politica + ola + (1 | country_wave) + (1 | pais), data= datos_fit, weights= wt)
macro_econ <- update(micro,. ~ . + gini_be+gini_we+pib_be+pib_we)
macro_econ_polit <- update(macro_econ,. ~ . + gini_be+gini_we+pib_be+pib_we+dem_be+dem_we+wgi_be+wgi_we)
macro_dem <- update(micro,. ~ . + mig_be+mig_we)
macro_econ_dem <- update(micro,. ~ . + gini_be+gini_we+pib_be+pib_we+mig_be+mig_we)
macro_econ_polit_dem <- update(micro,. ~ . + gini_be+gini_we+pib_be+pib_we+dem_be+dem_we+wgi_be+wgi_we+mig_be+mig_we)

h_demo <- list(macro_econ,macro_econ_polit,macro_dem,macro_econ_dem,macro_econ_polit_dem)

micro <- lmer(cohesion_vertical_ind ~ 1 + income_decile+ nivel_educ + sexo + edad_c + I(edad_c^2) + pos_politica + ola + (1 | country_wave) + (1 | pais), data= datos_fit, weights= wt)
macro_econ <- update(micro,. ~ . + gini_be+gini_we+pib_be+pib_we)
macro_econ_polit <- update(macro_econ,. ~ . + gini_be+gini_we+pib_be+pib_we+dem_be+dem_we+wgi_be+wgi_we)
macro_dem <- update(micro,. ~ . + mig_be+mig_we)
macro_econ_dem <- update(micro,. ~ . + gini_be+gini_we+pib_be+pib_we+mig_be+mig_we)
macro_econ_polit_dem <- update(micro,. ~ . + gini_be+gini_we+pib_be+pib_we+dem_be+dem_we+wgi_be+wgi_we+mig_be+mig_we)

v_demo <- list(macro_econ,macro_econ_polit,macro_dem,macro_econ_dem,macro_econ_polit_dem)

# screenreg(v_demo,digits=3,digits=3,custom.coef.map = coef_names)

micro <- lmer(cohesion_general_ind ~ 1 + income_decile +nivel_educ + sexo + edad_c + I(edad_c^2) + pos_politica + ola + (1 | country_wave) + (1 | pais), data= datos_fit, weights= wt)
macro_econ <- update(micro,. ~ . + gini_be+gini_we+pib_be+pib_we)
macro_econ_polit <- update(macro_econ,. ~ . + gini_be+gini_we+pib_be+pib_we+dem_be+dem_we+wgi_be+wgi_we)
macro_dem <- update(micro,. ~ . + mig_be+mig_we)
macro_econ_dem <- update(micro,. ~ . + gini_be+gini_we+pib_be+pib_we+mig_be+mig_we)
macro_econ_polit_dem <- update(micro,. ~ . + gini_be+gini_we+pib_be+pib_we+dem_be+dem_we+wgi_be+wgi_we+mig_be+mig_we)

g_demo <- list(macro_econ,macro_econ_polit,macro_dem,macro_econ_dem,macro_econ_polit_dem)
# screenreg(g_demo,digits=3,digits=3,custom.coef.map = coef_names)
```

Table 4...

```{r}
#| label: tbl-table004
#| results: asis
#| cache: true
#| tbl-cap: Multilevel regression for macro factors and horizontal social cohesion

htmlreg(h_demo, digits=3,custom.coef.map = coef_names,caption = NULL,
        # file = "output/table004.html"
        )
```


Table 5...

```{r}
#| label: tbl-table005
#| results: asis
#| cache: true
#| tbl-cap: Multilevel regression for macro factors and vertical social cohesion


htmlreg(v_demo, digits=3,custom.coef.map = coef_names,caption = NULL,
        # file = "output/table005.html"
        )
```

Table 6...

```{r}
#| label: tbl-table006
#| results: asis
#| cache: true
#| tbl-cap: Multilevel regression for macro factors and general social cohesion

htmlreg(g_demo, digits=3,custom.coef.map = coef_names,caption = NULL,
        # file = "output/table006.html"
        )
```

Así...

```{r}
#| label: tbl-modelos-cohesion
#| results: asis
#| echo: false
#| eval: false
#| cache: true
load("input/proc/datos-fit.rdata")
library(lme4)
library(texreg)
library(dplyr)

# datos_fit$ola<- factor(datos_fit$ola)
datos_fit_la <- datos_fit %>% filter(!pais %in% c("Canada","United States"))
# Socioeconomic dimensions------------------------------------------------------
micro <- lmer(cohesion_horizontal_ind ~ 1 + nivel_educ + sexo + edad_c + I(edad_c^2) + pos_politica + ola + (1 | country_wave) + (1 | pais), data= datos_fit, weights= wt)
macro_gini <- update(micro,. ~ . + gini_be + gini_we)
macro_gdp <- update(micro,. ~ . + pib_be + pib_we)
macro_econ <- update(micro,. ~ . + gini_be+gini_we+pib_be+pib_we)
# macro_econ_la_h <- update(macro_econ,data=datos_fit_la) #using only LATAM
h_econ <- list(macro_gini,macro_gdp,macro_econ)

micro <- lmer(cohesion_vertical_ind ~ 1 + nivel_educ + sexo + edad_c + I(edad_c^2) + pos_politica + ola + (1 | country_wave) + (1 | pais), data= datos_fit, weights= wt)
macro_gini <- update(micro,. ~ . + gini_be + gini_we)
macro_gdp <- update(micro,. ~ . + pib_be + pib_we)
macro_econ <- update(micro,. ~ . + gini_be+gini_we+pib_be+pib_we)
# macro_econ_la_v <- update(macro_econ,data=datos_fit_la) #using only LATAM
v_econ <- list(macro_gini,macro_gdp,macro_econ)

# screenreg(c(h_econ,v_econ))

htmlreg(c(h_econ,v_econ),single.row = F,digits = 3,
       # file = "output/table001.html",
        caption.above = T,
        caption = "Multilevel regression for socioeconomic macro factors and social cohesion", 
          custom.coef.map = 
            list(
              gini_be ="Gini (BE)",
              gini_we ="Gini (WE)",
              pib_be = "GDP (BE)", 
              pib_we = "GDP (WE)",
              # ola2006 = "Time (ref.= 2004) 2006",
              # ola2008 = "2008",
              # ola2010 = "2010",
              # ola2012 = "2012",
              # ola2014 = "2014",
              # ola2016 = "2016",
              # ola2018 = "2018",
              # ola2023 = "2023"   
              ola = "Time"              
            ),custom.header = list("Horizontal"=1:3,"Vertical"=4:6),
          custom.gof.rows = 
            list(Controls=c("Yes","Yes","Yes","Yes","Yes","Yes"))
          )

# Political dimensions------------------------------------------------------
micro <- lmer(cohesion_horizontal_ind ~ 1 + nivel_educ + sexo + edad_c + I(edad_c^2) + pos_politica + ola + (1 | country_wave) + (1 | pais), data= datos_fit, weights= wt)
macro_dem <- update(micro,. ~ . + dem_be + dem_we)
macro_wgi <- update(micro,. ~ . + wgi_be + wgi_we)
macro_pol <- update(micro,. ~ . + dem_be+dem_we+wgi_be + wgi_we)
# macro_pol_la_v <- update(macro_pol,data=datos_fit_la) #using only LATAM
h_pol <- list(macro_dem,macro_wgi,macro_pol)

micro <- lmer(cohesion_vertical_ind ~ 1 + nivel_educ + sexo + edad_c + I(edad_c^2) + pos_politica + ola + (1 | country_wave) + (1 | pais), data= datos_fit, weights= wt)
macro_dem  <- update(micro,. ~ . + dem_be + dem_we)
macro_wgi <- update(micro,. ~ . + wgi_be + wgi_we)
macro_pol  <- update(micro,. ~ . + dem_be+dem_we+wgi_be + wgi_we)
# macro_pol_la_h <- update(macro_pol,data=datos_fit_la) #using only LATAM

v_pol <- list(macro_dem,macro_wgi,macro_pol)

#screenreg(c(h_pol,v_pol))
htmlreg(c(h_pol,v_pol),single.row = F,digits = 3,
        # file = "output/table002.html",
        caption.above = T,
        caption = "Multilevel regression for institutional macro factors and social cohesion", 
          custom.coef.map = 
            list(
              dem_be ="Democracy (BE)",
              dem_we ="Democracy (WE)",
              wgi_be = "Governace (BE)", 
              wgi_we = "Governace (WE)",
              # ola2006 = "Time (ref.= 2004) 2006",
              # ola2008 = "2008",
              # ola2010 = "2010",
              # ola2012 = "2012",
              # ola2014 = "2014",
              # ola2016 = "2016",
              # ola2018 = "2018",
              # ola2023 = "2023"
              ola = "Time"
            ),custom.header = list("Horizontal"=1:3,"Vertical"=4:6),
          custom.gof.rows = 
            list(Controls=c("Yes","Yes","Yes","Yes","Yes","Yes"))          
          )

# Demographic ------------------------------------------------------------------
micro <- lmer(cohesion_horizontal_ind ~ 1 + nivel_educ + sexo + edad_c + I(edad_c^2) + pos_politica + ola + (1 | country_wave) + (1 | pais), data= datos_fit, weights= wt)
macro_mig <- update(micro,. ~ . + mig_be + mig_we)
# macro_mig_time <- update(micro,. ~ . + mig_be*ola + mig_we*ola)
h_demo <- list(macro_mig)

micro <- lmer(cohesion_vertical_ind ~ 1 + nivel_educ + sexo + edad_c + I(edad_c^2) + pos_politica + ola + (1 | country_wave) + (1 | pais), data= datos_fit, weights= wt)
macro_mig <- update(micro,. ~ . + mig_be + mig_we)
# macro_mig_time <- update(micro,. ~ . + mig_be*ola + mig_we*ola)
v_demo <- list(macro_mig)

#screenreg(c(h_demo,v_demo))
htmlreg(c(h_demo,v_demo),single.row = F,digits = 3,
        # file = "output/table003.html",
        caption.above = T,
        caption = "Multilevel regression for demographic macro factors and social cohesion", 
          custom.coef.map = 
            list(mig_be ="Migration (BE)",
                 mig_we = "Migration (WE)",
              # ola2006 = "Time (ref.= 2004) 2006",
              # ola2008 = "2008",
              # ola2010 = "2010",
              # ola2012 = "2012",
              # ola2014 = "2014",
              # ola2016 = "2016",
              # ola2018 = "2018",
              # ola2023 = "2023"
              ola = "Time"
              ),
          ,custom.header = list("Horizontal"=1,"Vertical"=2),
          custom.gof.rows = 
            list(Controls=c("Yes","Yes"))          
          )
```
