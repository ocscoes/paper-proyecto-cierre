# Resultados

```{r}
#| echo: false

## cargar base

load("input/proc/micro-macro-merge.rdata")

datos_merge <- datos_merge |>
  mutate(across(where(haven::is.labelled), ~ vctrs::vec_data(.)),
         pais= as.factor(pais))

datos_merge$country_wave = do.call(paste, c(datos_merge[c("pais", "ola")], sep = "_"))

```

## Análisis Factorial Confirmatorio

```{r}
#| eval: false

m1 <- 'ch =~ seguridad_ind + confianza_it_ind
       cv =~ confianza_inst_ind + democracia_ind'

m1_cfa <- cfa(
  m1, data = datos_merge, std.lv = TRUE)

save(m1_cfa, file="output/cfa.rdata")
```



```{r}
#| label: fig-afc
#| fig-cap: Análisis Factorial Confirmatorio Modelo de Medición de Cohesión Social

load("output/cfa.rdata")

semPaths(m1_cfa,
         what = "std",
        label.cex = 1, edge.label.cex = 1, # tamaño flechas y caracteres
        residuals = FALSE, # no mostrar residuos
        edge.color = "black") # color flechas

fit <- fitmeasures(m1_cfa, fit.measures = c("rmsea", "cfi", "chisq", "pvalue", "df"))
```

**Nota. RMSEA = `r round(fit["rmsea"], 3)`, CFI = `r round(fit["cfi"], 3)`, Chi-cuadrado = `r round(fit["chisq"], 2)`, gl = `r fit["df"]`, p-valor = `r round(fit["pvalue"], 3)`.**

En @fig-afc se presentan los resultados del análisis factorial confirmatorio hecho a partir del modelo de medición propuesto. En primer lugar, se observa que los indicadores presentan cargas factoriales moderadas, las cuales van del 0.45 al 0.6 dependiendo del caso, lo que sugiere que los indicadores reflejan parcialmente las dimensiones latentes. Los índices de ajuste son de buena calidad, apuntando a una fiabilidad del constructo. Ahora, dado que el modelo cuenta con un solo grado de libertad, las medidas de ajuste global deben interpretarse con precaución. En suma, el modelo ofrece un ajuste aceptable a nivel identificacional, pero la validez de los factores son limitadas, lo que podría solucionarse aumentando el número o la calidad de los indicadores en futuras mediciones.


## Descriptivos

A continuación se presentan los resultados descriptivos sobre los cambios de la cohesión social en América Latina en los últimos 20 años. 

```{r}
#| label: fig-cs
#| tab-cap: Evolución dimensiones Cohesión Social (2004-2022)

olas <- datos_merge |>
  group_by(ola) |>
  summarise(horizontal_prom = mean(`cohesion_horizontal_ind`, na.rm=T),
            vertical_prom = mean(`cohesion_vertical_ind`, na.rm=T),
            cohesion_prom = mean(`cohesion_general_ind`, na.rm=T)) |>
  pivot_longer(
    cols = c(horizontal_prom, vertical_prom, cohesion_prom),
    names_to = "indicador",
    values_to = "promedio"
  ) |>
  mutate(indicador = dplyr::recode(indicador,
                            horizontal_prom = "Cohesión Horizontal",
                            vertical_prom = "Cohesión Vertical",
                            cohesion_prom = "Cohesión Social"))


plot_cs <- olas |>
  ggplot(aes(x = ola, y = promedio, color = indicador)) +
  geom_line(linewidth = 1) +
  geom_point() +
  labs(x = "Ola", y = "Promedio", color = NULL) +
  theme_minimal() +
  theme(legend.position = "bottom")

plot_cs

```

En @fig-cs se visualizan los promedios de cada año para los distintos tipos de cohesión. En primer lugar, se puede observar que la cohesión horizontal mantiene un patrón ascendente entre 2004 y 2012, exceptuando la caída del año 2010. Posterior a esto, la cohesión horizontal se enfrenta a una decaída sostenida hasta el 2018, para luego volver a repuntar e incluso superando su nivel registrado en 2004. La cohesión vertical presenta un patrón de variación parecido al de la cohesión horizontal, evidenciando un alza persistente en el tiempo hasta el año 2012, donde luego sufre una caída abrupta a nivel regional. Este descenso se mantuvo hasta el 2016, donde luego se revertiría esta dinámica, notándose un aumento de la cohesión vertical hasta el último año registrado. Si bien, la última medición de la cohesión vertical muestra niveles superiores al del inicio, sus puntuaciones en general son considerablemente bajas al compararlas con la cohesión horizontal, diferenciándose en todas las olas por aproximadamente 1.5 puntos. En suma, en América Latina se denota una mayor cohesión horizontal por sobre la vertical de manera consistente desde el 2004 hasta el 2022.

```{r}
#| label: fig-ch
#| fig-cap: Evolución dimensiones Cohesión Horizontal (2004-2022)


olas <- datos_merge |>
  group_by(ola) |>
  summarise(seguridad_prom = mean(seguridad_ind, na.rm=T),
            confianza_prom = mean(confianza_it_ind, na.rm=T)) |>
  pivot_longer(
    cols = c(confianza_prom, seguridad_prom),
    names_to = "indicador",
    values_to = "promedio"
  ) |>
  mutate(indicador = dplyr::recode(indicador,
                            "confianza_prom" = "Confianza Interpersonal",
                            "seguridad_prom" = "Seguridad Pública"))
olas |>
  ggplot(aes(x = ola, y = promedio, color=indicador)) +
  geom_line(linewidth = 1) +
  geom_point() +
  labs(x = "Ola", y = "Promedio", color=NULL) +
  theme_minimal() + 
  theme(legend.position = "bottom")

```

En @fig-ch se presentan los promedios por año de las subdimensiones horizontales, seguridad pública y confianza interpersonal. En la seguridad pública se observa un patrón inestable entre los años 2004 y 2012, marcado por descensos y ascensos alternados. Posterior a 2012 se evidencia un fuerte deterioro en la subdimensión hasta 2018, viéndose un repunte después de este año, sin embargo, la recuperación no logra llegar a los niveles de seguridad que existían en un principio. La confianza interpersonal, por su parte, presenta un aumento hasta el 2010, año en el que sufre una leve caída, pero el año siguiente volviendo a ascender. Post 2012 se observa un patrón similar al de seguridad pública, con un descenso sostenido hasta el año 2018 para luego recuperarse. Una de las principales diferencias entre las dos subdimensiones es que, mientras en 2022 seguridad pública registró un promedio inferior al de la primera ola, los niveles de confianza interpersonal en 2022 fueron mayores que los de 2004. 

```{r}
#| label: fig-cv
#| fig-cap: Evolución dimensiones Cohesión Vertical (2004-2022)

olas <- datos_merge |>
  group_by(ola) |>
  summarise(confianza_prom = mean(confianza_inst_ind, na.rm=T),
            democracia_prom = mean(democracia_ind, na.rm=T)) |>
  pivot_longer(
    cols = c(confianza_prom, democracia_prom),
    names_to = "indicador",
    values_to = "promedio"
  ) |>
  mutate(indicador = dplyr::recode(indicador,
                            "confianza_prom" = "Confianza en las Instituciones",
                            "democracia_prom" = "Actitudes hacia la democracia"))
olas |>
  ggplot(aes(x = ola, y = promedio, color=indicador)) +
  geom_line(linewidth = 1) +
  geom_point() +
  labs(x = "Ola", y = "Promedio", color=NULL) +
  theme_minimal() + 
  theme(legend.position = "bottom")

```

En @fig-cv están graficados los cambios en el tiempo de las dos subdimensiones de cohesión vertical. Actitud hacia la democracia presenta un alza sostenida hasta el 2008, donde luego sufre una caída paulatina, destacándose un descenso abrupto entre 2014 y 2016. Posterior a esto, las afecciones hacia la democracia evidencian nuevamente un ascenso en sus niveles regionales, sin embargo, no logra alcanzar sus niveles iniciales. En confianza en instituciones se observan niveles ascendentes desde 2004 hasta 2012, a excepción de la baja del 2008. Los años siguientes se evidencia un decrecimiento en la confianza institucional hasta el 2016, para luego demostrar un repunte hasta el último año registrado, llegando a superar los niveles de confianza en instituciones del 2004. 

## Modelos Multinivel

```{r}
#| label: preparacion-datos
#| eval: false


# Separar los efectos

datos_merge <- datos_merge |>
  group_by(pais) |>
 mutate(pib_be = mean(log_pib_per_capita_ppa, na.rm=T),
         gini_be = mean(gini_index, na.rm=T),
         mig_be = mean(percent_pob_migrante, na.rm=T),
         dem_be = mean(indice_v_dem, na.rm=T),
         wgi_be = mean(wgi, na.rm=T),
         edu_be = mean(edu_terciaria, na.rm=T)) |>
  ungroup() |>
  mutate(pib_we = log_pib_per_capita_ppa - pib_be,
          gini_we = gini_index - gini_be,
          mig_we = percent_pob_migrante - mig_be,
          dem_we = indice_v_dem - dem_be,
          wgi_we = wgi- wgi_be,
          edu_we = edu_terciaria-edu_be)

# Centrado y limpieza

z <- function(x) as.numeric(scale(x))

datos_fit <- datos_merge %>%
  mutate(
    pib_we  = z(pib_we),   gini_we = z(gini_we), wgi_we = z(wgi_we), dem_we = z(dem_we),
    mig_we  = z(mig_we),   edu_we = z(edu_we),
    pib_be  = z(pib_be),   gini_be = z(gini_be), wgi_be = z(wgi_be), dem_be = z(dem_be),
    mig_be  = z(mig_be),   edu_be = z(edu_be),
    edad_c = scale(edad) %>% as.numeric(),
    ola_s = as.numeric(scale(ola, center = TRUE, scale = TRUE)),
    
    nivel_educ   = forcats::fct_drop(factor(nivel_educ)),
    pos_politica = forcats::fct_drop(factor(pos_politica)),
    sexo         = forcats::fct_drop(factor(sexo)),
    pais         = forcats::fct_drop(factor(pais)),
    country_wave = forcats::fct_drop(factor(country_wave)),

    # --- cambiar categoría de referencia ---
    nivel_educ   = forcats::fct_relevel(nivel_educ, "Tertiary"),   # ejemplo
    pos_politica = forcats::fct_relevel(pos_politica, "Not declared")         # ejemplo
  ) |>
  select(cohesion_general_ind, cohesion_vertical_ind, cohesion_horizontal_ind,
         nivel_educ, sexo, edad_c, ola_s, pos_politica,
         pib_we, gini_we, dem_we, wgi_we, mig_we, edu_we,
         pib_be, gini_be, dem_be, wgi_be, mig_be, edu_be,
         country_wave, pais, wt) |>
  na.omit()

save(datos_fit, file="input/proc/datos-fit.rdata")


```

**Modelos Nulos**


```{r}
#| eval: false

load("input/proc/datos-fit.rdata")

m0_ch = lmer(cohesion_horizontal_ind ~ 1 + (1 | country_wave) + (1 |pais), data=datos_fit, weights=wt)

icc(m0_ch, by_group=TRUE) # 2.3% y 5.6%

m0_cv = lmer(cohesion_vertical_ind ~ 1 + (1 | country_wave) + (1 |pais), data=datos_fit, weights=wt)

icc(m0_cv, by_group=TRUE) # 6.3% y 6.3%

m0_cs = lmer(cohesion_general_ind ~ 1 + (1 | country_wave) + (1 |pais), data=datos_fit, weights=wt)

icc(m0_cs, by_group=TRUE) # 4.9% y 7.5%

save(m0_ch, file="output/modelo_nulo_horizontal.rdata")
save(m0_cv, file="output/modelo_nulo_vertical.rdata")
save(m0_cs, file= "output/modelo_nulo_completo.rdata")

```


```{r}
#| label: modelos-nulos

load("output/modelo_nulo_horizontal.rdata")
load("output/modelo_nulo_vertical.rdata")
load( "output/modelo_nulo_completo.rdata")
```


## Cohesión Horizontal

```{r}
#| eval: false

# Modelo 1: Nivel individual
m1_h <- lmer(cohesion_horizontal_ind ~ 1 + nivel_educ + sexo + edad_c + I(edad_c^2) + pos_politica + ola_s + (1 | country_wave) + (1 | pais), data= datos_fit, weights= wt)

# Modelo 2: Nivel Ola Pais
m2_h <- lmer(cohesion_horizontal_ind ~ 1 + nivel_educ + sexo + edad_c + I(edad_c^2) + pos_politica + ola_s + 
pib_we + gini_we + dem_we + wgi_we + mig_we + edu_we +
(1 | country_wave) + (1 | pais), data= datos_fit, weights= wt)


# Modelo 3: Nivel País
m3_h <- lmer(cohesion_horizontal_ind ~ 1 + nivel_educ + sexo + edad_c + I(edad_c^2) + pos_politica + ola_s + 
pib_we + gini_we + dem_we + wgi_we + mig_we + edu_we +
pib_be + gini_be + dem_be + wgi_be + mig_be + edu_be +
(1 | country_wave) + (1 | pais), data= datos_fit, weights= wt)

# Modelo 4: Interacciones
m4_h <- lmer(cohesion_horizontal_ind ~ 1 + ola_s + nivel_educ + sexo + edad_c + I(edad_c^2) + pos_politica + 
pib_we + gini_we + dem_we + wgi_we + mig_we + edu_we +
pib_be + gini_be + dem_be + wgi_be + mig_be + edu_be +
mig_we:wgi_be +
edu_be:gini_be +
  edu_be:gini_we + 
  (1 | country_wave) + (1 | pais), data= datos_fit, weights= wt)

save(m1_h, file="output/modelo_horizontal_1.rdata")
save(m2_h, file="output/modelo_horizontal_2.rdata")
save(m3_h, file= "output/modelo_horizontal_3.rdata")
save(m4_h, file= "output/modelo_horizontal_4.rdata")
```

```{r}
#| label: tbl-modelos-horizontal
#| tbl-cap: Modelos para cohesión horizontal 
#| results: asis

load("output/modelo_horizontal_1.rdata")
load("output/modelo_horizontal_2.rdata")
load("output/modelo_horizontal_3.rdata")
load("output/modelo_horizontal_4.rdata")

sjPlot::tab_model(m1_h, m2_h, m3_h, m4_h,
                  show.ci = FALSE,
                  dv.labels = c("m1", "m2", "m3", "m4"))

```


```{r}
#| eval: false

p_load(influence.ME)

estex.cw <- influence(m4, "country_wave")
estex.c <- influence(m4, "pais")

# Casos influyentes a nivel ola-país

cooks_cw <- cooks.distance(estex.cw, sort = T)
cut_cw <- 4/sqrt(130)

plot(estex.cw, which="cook",
     cutoff=cut_cw, sort=TRUE)

# Influyentes a nivel país

cut_c <- 4/sqrt(22)

plot(estex.c, which="cook",
     cutoff=cut_c, sort=TRUE)
```


## Cohesión Vertical

```{r}
#| eval: false

# Modelo 1: Nivel individual
m1_v <- lmer(cohesion_vertical_ind ~ 1 + nivel_educ + sexo + edad_c + I(edad_c^2) + pos_politica + ola_s + (1 | country_wave) + (1 | pais), data= datos_fit, weights= wt)

# Modelo 2: Nivel Ola Pais
m2_v <- lmer(cohesion_vertical_ind ~ 1 + nivel_educ + sexo + edad_c + I(edad_c^2) + pos_politica + ola_s + 
pib_we + gini_we + dem_we + wgi_we + mig_we + edu_we +
(1 | country_wave) + (1 | pais), data= datos_fit, weights= wt)


# Modelo 3: Nivel País
m3_v <- lmer(cohesion_vertical_ind ~ 1 + nivel_educ + sexo + edad_c + I(edad_c^2) + pos_politica + ola_s + 
pib_we + gini_we + dem_we + wgi_we + mig_we + edu_we +
pib_be + gini_be + dem_be + wgi_be + mig_be + edu_be +
(1 | country_wave) + (1 | pais), data= datos_fit, weights= wt)

# Modelo 4: Interacciones
m4_v <- lmer(cohesion_vertical_ind ~ 1 + ola_s + nivel_educ + sexo + edad_c + I(edad_c^2) + pos_politica + 
pib_we + gini_we + dem_we + wgi_we + mig_we + edu_we +
pib_be + gini_be + dem_be + wgi_be + mig_be + edu_be +
mig_we:wgi_be +
edu_be:gini_be +
  edu_be:gini_we + 
  (1 | country_wave) + (1 | pais), data= datos_fit, weights= wt)


save(m1_v, file="output/modelo_vertical_1.rdata")
save(m2_v, file="output/modelo_vertical_2.rdata")
save(m3_v, file="output/modelo_vertical_3.rdata")
save(m4_v, file="output/modelo_vertical_4.rdata")
```

```{r}
#| label: tbl-modelos-vertical
#| tbl-cap: Modelos para cohesión vertical
#| results: asis

load("output/modelo_vertical_1.rdata")
load("output/modelo_vertical_2.rdata")
load("output/modelo_vertical_3.rdata")
load("output/modelo_vertical_4.rdata")

sjPlot::tab_model(m1_v, m2_v, m3_v, m4_v,
                  show.ci = FALSE,
                  dv.labels = c("m1", "m2", "m3", "m4"))
```


```{r}
#| eval: false

estex.cw <- influence(m4, "country_wave")
estex.c <- influence(m4, "pais")

# Casos influyentes a nivel ola-país

cooks_cw <- cooks.distance(estex.cw, sort = T)
cut_cw <- 4/sqrt(130)

plot(estex.cw, which="cook",
     cutoff=cut_cw, sort=TRUE)

# Influyentes a nivel país

cut_c <- 4/sqrt(22)

plot(estex.c, which="cook",
     cutoff=cut_c, sort=TRUE)

# Uruguay y Bolivia aparecen como influyentes
```

## Cohesión General

```{r}
#| eval: false

# Modelo 1: Nivel individual
m1 <- lmer(cohesion_general_ind ~ 1 + nivel_educ + sexo + edad_c + I(edad_c^2) + pos_politica + ola_s + (1 | country_wave) + (1 | pais), data= datos_fit, weights= wt)

# Modelo 2: Nivel Ola Pais
m2 <- lmer(cohesion_general_ind ~ 1 + nivel_educ + sexo + edad_c + I(edad_c^2) + pos_politica + ola_s + 
pib_we + gini_we + dem_we + wgi_we + mig_we + edu_we +
(1 | country_wave) + (1 | pais), data= datos_fit, weights= wt)


# Modelo 3: Nivel País
m3 <- lmer(cohesion_general_ind ~ 1 + nivel_educ + sexo + edad_c + I(edad_c^2) + pos_politica + ola_s + 
pib_we + gini_we + dem_we + wgi_we + mig_we + edu_we +
pib_be + gini_be + dem_be + wgi_be + mig_be + edu_be +
(1 | country_wave) + (1 | pais), data= datos_fit, weights= wt)

# Modelo 4: Interacciones
m4 <- lmer(cohesion_general_ind ~ 1 + ola_s + nivel_educ + sexo + edad_c + I(edad_c^2) + pos_politica +  + 
pib_we + gini_we + dem_we + wgi_we + mig_we + edu_we +
pib_be + gini_be + dem_be + wgi_be + mig_be + edu_be +
mig_we:wgi_be +
edu_be:gini_be +
  edu_be:gini_we + 
  (1 | country_wave) + (1 | pais), data= datos_fit, weights= wt)



save(m1, file="output/modelo_general_1.rdata")
save(m2, file="output/modelo_general_2.rdata")
save(m3, file="output/modelo_general_3.rdata")
save(m4, file="output/modelo_general_4.rdata")


```

```{r}
#| label: tbl-modelos-general
#| tbl-cap: Modelos para cohesión social
#| results: asis

load("output/modelo_general_1.rdata")
load("output/modelo_general_2.rdata")
load("output/modelo_general_3.rdata")
load("output/modelo_general_4.rdata")

sjPlot::tab_model(m1, m2, m3, m4,
                  show.ci = FALSE,
                  dv.labels = c("m1", "m2", "m3", "m4"))

```


```{r}
#| eval: false

# estex.cw <- influence(m4, "country_wave")

# 
# # Casos influyentes a nivel ola-país
# 
# cooks_cw <- cooks.distance(estex.cw, sort = T)
# cut_cw <- 4/sqrt(130)
# 
# plot(estex.cw, which="cook",
#      cutoff=cut_cw, sort=TRUE)

# Influyentes a nivel país

estex.c <- influence.ME::influence(m5, "pais")
cooks_c <- cooks.distance(estex.c, sort = T)
cut_c <- 4/sqrt(22)

plot(estex.c, which="cook",
     cutoff=cut_c, sort=TRUE)

# De nuevo Bolivia y Uruguay
```


### Modelo finales

```{r}
p <- sjPlot::plot_models(m4_h, m4_v, m4,
                    grid  = T,
                    rm.terms = c("pib_we",
                                 "I(edad_c^2)",
                                 "gini_we",
                                 "edu_we",
                                 "pib_be",
                                 "dem_be",
                                 "mig_be",
                                 "gini_be:edu_be",
                                 "gini_we:edu_be",
                                 "ola_s:mig_be",
                                 "ola_s:wgi_we",
                                 "wgi_we",
                                 "mig_we:wgi_be"),
                     m.labels= c("Cohesión Horizontal",
                                 "Cohesión Vertical",
                                 "Cohesión Social"),
                     axis.labels =
                       c("Pob. Educ. Terciaria (between)",
                         "Pob. Migrante (within)",
                             "Gobernanza (between)",
                             "Democracia (within)",
                         "Gini (between)",
                         "Derecha (ref=Sin posición)",
                         "Centro (ref=Sin posición)",
                         "Izquierda (ref=Sin posición)",
                         "Edad",
                         "Hombre (ref=Mujer)",
                         "Educ. Secundaria (ref=Terciaria)",
                         "Educ. Primaria (ref=Terciaria)",
                         "Ola"),
                    show.p = T,
                    show.legend = F,
                    show.values = T
                    )


p <- p +
  labs(
    caption = "Nota: Se muestran solo los efectos estadísticamente significativos. \n* p < 0.05; ** p < 0.01; *** p < 0.001"
  ) +
  theme_minimal(base_size = 11) +
  theme(
    plot.caption = element_text(hjust = 0, face = "italic", size = 9),
    axis.text = element_text(size = 10))

print(p)
```

