---
output: html_document
editor_options: 
  chunk_output_type: console
---
# Resultados

```{r}
#| echo: false

## cargar base
library(tidyverse)
load("input/proc/micro-macro-merge.rdata")

datos_merge <- datos_merge |>
  mutate(across(where(haven::is.labelled), ~ vctrs::vec_data(.)),
         pais= as.factor(pais))

datos_merge$country_wave = do.call(paste, c(datos_merge[c("pais", "ola")], sep = "_"))
```

## Análisis Factorial Confirmatorio

```{r}
#| eval: false

m1 <- 'ch =~ seguridad_ind + confianza_it_ind
       cv =~ confianza_inst_ind + democracia_ind'

m1_cfa <- cfa(
  m1, data = datos_merge, std.lv = TRUE)

save(m1_cfa, file="output/cfa.rdata")
```



```{r}
#| label: fig-afc
#| fig-cap: Análisis Factorial Confirmatorio Modelo de Medición de Cohesión Social

load("output/cfa.rdata")

semPaths(m1_cfa,
         what = "std",
        label.cex = 1, edge.label.cex = 1, # tamaño flechas y caracteres
        residuals = FALSE, # no mostrar residuos
        edge.color = "black") # color flechas

fit <- fitmeasures(m1_cfa, fit.measures = c("rmsea", "cfi", "chisq", "pvalue", "df"))
```

**Nota. RMSEA = `r round(fit["rmsea"], 3)`, CFI = `r round(fit["cfi"], 3)`, Chi-cuadrado = `r round(fit["chisq"], 2)`, gl = `r fit["df"]`, p-valor = `r round(fit["pvalue"], 3)`.**

En @fig-afc se presentan los resultados del análisis factorial confirmatorio hecho a partir del modelo de medición propuesto. En primer lugar, se observa que los indicadores presentan cargas factoriales moderadas, las cuales van del 0.45 al 0.6 dependiendo del caso, lo que sugiere que los indicadores reflejan parcialmente las dimensiones latentes. Los índices de ajuste son de buena calidad, apuntando a una fiabilidad del constructo. Ahora, dado que el modelo cuenta con un solo grado de libertad, las medidas de ajuste global deben interpretarse con precaución. En suma, el modelo ofrece un ajuste aceptable a nivel identificacional, pero la validez de los factores son limitadas, lo que podría solucionarse aumentando el número o la calidad de los indicadores en futuras mediciones.


## Descriptivos

A continuación se presentan los resultados descriptivos sobre los cambios de la cohesión social en América Latina en las últimas dos décadas.

```{r}
#| label: fig-cs
#| fig-cap: Evolución dimensiones Cohesión Social (2004-2022)
olas <- datos_merge |>
  group_by(ola) |>
  summarise(horizontal_prom = mean(`cohesion_horizontal_ind`, na.rm=T),
            vertical_prom = mean(`cohesion_vertical_ind`, na.rm=T),
            cohesion_prom = mean(`cohesion_general_ind`, na.rm=T)) |>
  pivot_longer(
    cols = c(horizontal_prom, vertical_prom, cohesion_prom),
    names_to = "indicador",
    values_to = "promedio"
  ) |>
  mutate(indicador = dplyr::recode(indicador,
                            horizontal_prom = "Horizontal Cohesion",
                            vertical_prom = "Vertical Cohesion",
                            cohesion_prom = "General Cohesion"))



olas$ola <- factor(olas$ola)
plot_cs <- olas |>
  ggplot(aes(x = ola, y = promedio, color = indicador,group = indicador)) +
  geom_line(linewidth = 1) +
  geom_point() +
  scale_y_continuous(limits = c(2,8))+
  labs(x = "Wave", y = "Social cohesion (1-10)", color = NULL) +
  theme_minimal() +
  theme(legend.position = "bottom")

plot_cs
```

En @fig-cs se visualizan los promedios de cada año para los distintos tipos de cohesión. En primer lugar, se puede observar que la cohesión horizontal mantiene un patrón ascendente entre 2004 y 2012, exceptuando la caída del año 2010. Posterior a esto, la cohesión horizontal se enfrenta a una decaída sostenida hasta el 2018, para luego volver a repuntar e incluso superando su nivel registrado en 2004. La cohesión vertical presenta un patrón de variación parecido al de la cohesión horizontal, evidenciando un alza persistente en el tiempo hasta el año 2012, donde luego sufre una caída abrupta a nivel regional. Este descenso se mantuvo hasta el 2016, donde luego se revertiría esta dinámica, notándose un aumento de la cohesión vertical hasta el último año registrado. Si bien, la última medición de la cohesión vertical muestra niveles superiores al del inicio, sus puntuaciones en general son considerablemente bajas al compararlas con la cohesión horizontal, diferenciándose en todas las olas por aproximadamente 1.5 puntos. En suma, en América Latina se denota una mayor cohesión horizontal por sobre la vertical de manera consistente desde el 2004 hasta el 2022[³]. 

[³]: Cabe mencionar que la cohesión social (recta verde) es el promedio de la cohesión vertical y horizontal, por ello no se detalla su interpretación.

```{r}
#| label: fig-ch
#| fig-cap: Evolución dimensiones Cohesión Horizontal (2004-2022)
olas <- datos_merge |>
  group_by(ola) |>
  summarise(seguridad_prom = mean(seguridad_ind, na.rm=T),
            confianza_prom = mean(confianza_it_ind, na.rm=T)) |>
  pivot_longer(
    cols = c(confianza_prom, seguridad_prom),
    names_to = "indicador",
    values_to = "promedio"
  ) |>
  mutate(indicador = dplyr::recode(indicador,
                            "confianza_prom" = "Confianza Interpersonal",
                            "seguridad_prom" = "Seguridad Pública"))
olas |>
  ggplot(aes(x = ola, y = promedio, color=indicador)) +
  geom_line(linewidth = 1) +
  geom_point() +
  labs(x = "Ola", y = "Promedio", color=NULL) +
  theme_minimal() + 
  theme(legend.position = "bottom")

```

En @fig-ch se presentan los promedios por año de las subdimensiones horizontales, seguridad pública y confianza interpersonal. En la seguridad pública se observa un patrón inestable entre los años 2004 y 2012, marcado por descensos y ascensos alternados. Posterior a 2012 se evidencia un fuerte deterioro en la subdimensión hasta 2018, viéndose un repunte después de este año, sin embargo, la recuperación no logra llegar a los niveles de seguridad que existían en un principio. La confianza interpersonal, por su parte, presenta un aumento hasta el 2010, año en el que sufre una leve caída, pero el año siguiente volviendo a ascender. Post 2012 se observa un patrón similar al de seguridad pública, con un descenso sostenido hasta el año 2018 para luego recuperarse. Una de las principales diferencias entre las dos subdimensiones es que, mientras en 2022 seguridad pública registró un promedio inferior al de la primera ola, los niveles de confianza interpersonal en 2022 fueron mayores que los de 2004. 

```{r}
#| label: fig-cv
#| fig-cap: Evolución dimensiones Cohesión Vertical (2004-2022)

olas <- datos_merge |>
  group_by(ola) |>
  summarise(confianza_prom = mean(confianza_inst_ind, na.rm=T),
            democracia_prom = mean(democracia_ind, na.rm=T)) |>
  pivot_longer(
    cols = c(confianza_prom, democracia_prom),
    names_to = "indicador",
    values_to = "promedio"
  ) |>
  mutate(indicador = dplyr::recode(indicador,
                            "confianza_prom" = "Confianza en las Instituciones",
                            "democracia_prom" = "Actitudes hacia la democracia"))
olas |>
  ggplot(aes(x = ola, y = promedio, color=indicador)) +
  geom_line(linewidth = 1) +
  geom_point() +
  labs(x = "Ola", y = "Promedio", color=NULL) +
  theme_minimal() + 
  theme(legend.position = "bottom")

```

En @fig-cv están graficados los cambios en el tiempo de las dos subdimensiones de cohesión vertical. Actitud hacia la democracia presenta un alza sostenida hasta el 2008, donde luego sufre una caída paulatina, destacándose un descenso abrupto entre 2014 y 2016. Posterior a esto, las afecciones hacia la democracia evidencian nuevamente un ascenso en sus niveles regionales, sin embargo, no logra alcanzar sus niveles iniciales. En confianza en instituciones se observan niveles ascendentes desde 2004 hasta 2012, a excepción de la baja del 2008. Los años siguientes se evidencia un decrecimiento en la confianza institucional hasta el 2016, para luego demostrar un repunte hasta el último año registrado, llegando a superar los niveles de confianza en instituciones del 2004. 

## Relationship between and within country level factors with social cohesión

```{r fig-macro}
#| fig-width: 10
#| fig-height: 20
#| fig-cap: "Country-level association of macro-level factors and social cohesion"
set1 <-  RColorBrewer::brewer.pal(n = 8, name = "Set1")
options(ggplot2.discrete.fill = set1)
options(ggplot2.discrete.colour = set1)
ggplot2::theme_set(ggplot2::theme_bw())
ggplot2::theme_update(text=ggplot2::element_text(size=15,  family="serif"))    
options(scipen=999)
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,ggplot2,haven,ggrepel,gridExtra,grid)  
rm(list=ls())

load("input/proc/micro-macro-merge.rdata")

datos_merge <- datos_merge |>
  mutate(across(where(haven::is.labelled), ~ vctrs::vec_data(.)),
         pais= as.factor(pais))

datos_merge$country_wave = do.call(paste, c(datos_merge[c("pais", "ola")], sep = "_"))

wid_data <- haven::read_dta(file = "input/proc/wid_data.dta")
wid_data <- wid_data %>% mutate(yr2=substr(year, 3, 4)) %>% rename(iso2c=country)
datos_merge$iso2c<- countrycode::countrycode(sourcevar = datos_merge$pais,origin = "country.name",destination = "iso2c")
wid_data$iso2c <- as.character(wid_data$iso2c)
datos_merge$yr2<- substr(datos_merge$ola, 3, 4)
datos_merge<- 
left_join(x = datos_merge,y = wid_data[,c("iso2c","yr2","wid_gini_disp")],
          by =c("iso2c","yr2"))

datos_macro <- datos_merge %>%
  mutate(
   cohesion_horizontal,
      cohesion_vertical,
      cohesion_general,
      gini_index,
      wid_gini_disp,  
      pib_per_capita_ppa,
      log_pib_per_capita_ppa,
      percent_pob_migrante,
      indice_v_dem,
      regulatory_quality,
      voice_and_accountability,
      wgi,
    edad_c = scale(edad) %>% as.numeric(),
    ola_s = as.numeric(scale(ola, center = TRUE, scale = TRUE)),
    ola,
    nivel_educ   = forcats::fct_drop(factor(nivel_educ)),
    pos_politica = forcats::fct_drop(factor(pos_politica)),
    sexo         = forcats::fct_drop(factor(sexo)),
    pais         = forcats::fct_drop(factor(pais)),
    country_wave = forcats::fct_drop(factor(country_wave))
  ) %>% 
    select(cohesion_horizontal,
      cohesion_vertical,
      cohesion_general,
      gini_index,wid_gini_disp,
      pib_per_capita_ppa,
      log_pib_per_capita_ppa,
      percent_pob_migrante,
      indice_v_dem,
      regulatory_quality,
      voice_and_accountability,wgi,
         nivel_educ, sexo, edad_c, ola_s,ola, pos_politica,iso2c,
         country_wave, pais, wt)

# dim(datos_macro);dim(na.omit(datos_macro))
datos_macro$yr2<- substr(datos_macro$ola, 3, 4)

df_sum <- datos_macro %>%
  group_by(iso2c, yr2) %>%
  summarise(across(
    c(cohesion_horizontal,
      cohesion_vertical,
      cohesion_general,
      gini_index,wid_gini_disp,
      pib_per_capita_ppa,
      log_pib_per_capita_ppa,
      percent_pob_migrante,
      indice_v_dem,
      wgi),
    mean,
    na.rm = TRUE
  )) %>%
  ungroup() 
df_sum <- 
 df_sum %>% 
  group_by(iso2c) %>%
  mutate(across(
    c(cohesion_horizontal,
      cohesion_vertical,
      cohesion_general,
      gini_index,wid_gini_disp,
      pib_per_capita_ppa,
      log_pib_per_capita_ppa,
      percent_pob_migrante,
      indice_v_dem,
      wgi),
    mean,
    na.rm = TRUE,
    .names = "mid_{.col}"
  )) %>%
  ungroup()

df_sum$ctyear <- paste0(df_sum$iso2c,df_sum$yr2)

library(ggrepel)

fig_gini_h <- 
  ggplot() +
  geom_smooth(data = df_sum, aes(x = wid_gini_disp, y = cohesion_horizontal, color = iso2c, shape = iso2c), method = "lm", se = FALSE,color = "black") +
  geom_point(data = df_sum, aes(x = mid_wid_gini_disp, y = mid_cohesion_horizontal)) +
  geom_text(data = df_sum, aes(x = mid_wid_gini_disp, y = mid_cohesion_horizontal, label = iso2c), color = "black") +
  geom_smooth(data = df_sum, method = lm, se = FALSE, aes(mid_wid_gini_disp, y = mid_cohesion_horizontal), color = "red") +
  labs(x = "Economic Inequality", y = "Horizontal Cohesion", caption = round(cor(df_sum$mid_wid_gini_disp, df_sum$mid_cohesion_horizontal, use = "complete.obs"), 2))

fig_gdp_h <- 
  ggplot() +
  geom_smooth(data = df_sum, aes(x = pib_per_capita_ppa, y = cohesion_horizontal, color = iso2c, shape = iso2c), method = "lm", se = FALSE,color = "black") +
  geom_point(data = df_sum, aes(x = mid_pib_per_capita_ppa, y = mid_cohesion_horizontal)) +
  geom_text(data = df_sum, aes(x = mid_pib_per_capita_ppa, y = mid_cohesion_horizontal, label = iso2c), color = "black") +
  geom_smooth(data = df_sum, method = lm, se = FALSE, aes(mid_pib_per_capita_ppa, y = mid_cohesion_horizontal), color = "red") +
  labs(x = "GDP per Capita (PPP)", y = "Horizontal Cohesion", caption = round(cor(df_sum$mid_pib_per_capita_ppa, df_sum$mid_cohesion_horizontal, use = "complete.obs"), 2))

fig_mig_h <- 
  ggplot() +
  geom_smooth(data = df_sum, aes(x = percent_pob_migrante, y = cohesion_horizontal, color = iso2c, shape = iso2c), method = "lm", se = FALSE,color = "black") +
  geom_point(data = df_sum, aes(x = mid_percent_pob_migrante, y = mid_cohesion_horizontal)) +
  geom_text(data = df_sum, aes(x = mid_percent_pob_migrante, y = mid_cohesion_horizontal, label = iso2c), color = "black") +
  geom_smooth(data = df_sum, method = lm, se = FALSE, aes(mid_percent_pob_migrante, y = mid_cohesion_horizontal), color = "red") +
  labs(x = "Migrant Population (%)", y = "Horizontal Cohesion", caption = round(cor(df_sum$mid_percent_pob_migrante, df_sum$mid_cohesion_horizontal, use = "complete.obs"), 2))

fig_vdem_h <- 
  ggplot() +
  geom_smooth(data = df_sum, aes(x = indice_v_dem, y = cohesion_horizontal, color = iso2c, shape = iso2c), method = "lm", se = FALSE,color = "black") +
  geom_point(data = df_sum, aes(x = mid_indice_v_dem, y = mid_cohesion_horizontal)) +
  geom_text(data = df_sum, aes(x = mid_indice_v_dem, y = mid_cohesion_horizontal, label = iso2c), color = "black") +
  geom_smooth(data = df_sum, method = lm, se = FALSE, aes(mid_indice_v_dem, y = mid_cohesion_horizontal), color = "red") +
  labs(x = "Democracy", y = "Horizontal Cohesion", caption = round(cor(df_sum$mid_indice_v_dem, df_sum$mid_cohesion_horizontal, use = "complete.obs"), 2))

fig_wdi_h <- 
  ggplot() +
  geom_smooth(data = df_sum, aes(x = wgi, y = cohesion_horizontal, color = iso2c, shape = iso2c), method = "lm", se = FALSE,color = "black") +
  geom_point(data = df_sum, aes(x = mid_wgi, y = mid_cohesion_horizontal)) +
  geom_text(data = df_sum, aes(x = mid_wgi, y = mid_cohesion_horizontal, label = iso2c), color = "black") +
  geom_smooth(data = df_sum, method = lm, se = FALSE, aes(mid_wgi, y = mid_cohesion_horizontal), color = "red") +
  labs(x = "Governance", y = "Horizontal Cohesion", caption = round(cor(df_sum$mid_wgi, df_sum$mid_cohesion_horizontal, use = "complete.obs"), 2))


fig_gini_v <- 
  ggplot() +
  geom_smooth(data = df_sum, aes(x = wid_gini_disp, y = cohesion_vertical, color = iso2c, shape = iso2c), method = "lm", se = FALSE, color = "black") +
  geom_point(data = df_sum, aes(x = mid_wid_gini_disp, y = mid_cohesion_vertical)) +
  geom_text(data = df_sum, aes(x = mid_wid_gini_disp, y = mid_cohesion_vertical, label = iso2c), color = "black") +
  geom_smooth(data = df_sum, method = lm, se = FALSE, aes(mid_wid_gini_disp, y = mid_cohesion_vertical), color = "red") +
  labs(x = "Economic Inequality", y = "Vertical Cohesion", caption = round(cor(df_sum$mid_wid_gini_disp, df_sum$mid_cohesion_vertical, use = "complete.obs"), 2))

fig_gdp_v <- 
  ggplot() +
  geom_smooth(data = df_sum, aes(x = pib_per_capita_ppa, y = cohesion_vertical, color = iso2c, shape = iso2c), method = "lm", se = FALSE, color = "black") +
  geom_point(data = df_sum, aes(x = mid_pib_per_capita_ppa, y = mid_cohesion_vertical)) +
  geom_text(data = df_sum, aes(x = mid_pib_per_capita_ppa, y = mid_cohesion_vertical, label = iso2c), color = "black") +
  geom_smooth(data = df_sum, method = lm, se = FALSE, aes(mid_pib_per_capita_ppa, y = mid_cohesion_vertical), color = "red") +
  labs(x = "GDP per Capita (PPP)", y = "Vertical Cohesion", caption = round(cor(df_sum$mid_pib_per_capita_ppa, df_sum$mid_cohesion_vertical, use = "complete.obs"), 2))

fig_mig_v <- 
  ggplot() +
  geom_smooth(data = df_sum, aes(x = percent_pob_migrante, y = cohesion_vertical, color = iso2c, shape = iso2c), method = "lm", se = FALSE, color = "black") +
  geom_point(data = df_sum, aes(x = mid_percent_pob_migrante, y = mid_cohesion_vertical)) +
  geom_text(data = df_sum, aes(x = mid_percent_pob_migrante, y = mid_cohesion_vertical, label = iso2c), color = "black") +
  geom_smooth(data = df_sum, method = lm, se = FALSE, aes(mid_percent_pob_migrante, y = mid_cohesion_vertical), color = "red") +
  labs(x = "Migrant Population (%)", y = "Vertical Cohesion", caption = round(cor(df_sum$mid_percent_pob_migrante, df_sum$mid_cohesion_vertical, use = "complete.obs"), 2))

fig_vdem_v <- 
  ggplot() +
  geom_smooth(data = df_sum, aes(x = indice_v_dem, y = cohesion_vertical, color = iso2c, shape = iso2c), method = "lm", se = FALSE, color = "black") +
  geom_point(data = df_sum, aes(x = mid_indice_v_dem, y = mid_cohesion_vertical)) +
  geom_text(data = df_sum, aes(x = mid_indice_v_dem, y = mid_cohesion_vertical, label = iso2c), color = "black") +
  geom_smooth(data = df_sum, method = lm, se = FALSE, aes(mid_indice_v_dem, y = mid_cohesion_vertical), color = "red") +
  labs(x = "Democracy", y = "Vertical Cohesion", caption = round(cor(df_sum$mid_indice_v_dem, df_sum$mid_cohesion_vertical, use = "complete.obs"), 2))

fig_wdi_v <- 
  ggplot() +
  geom_smooth(data = df_sum, aes(x = wgi, y = cohesion_vertical, color = iso2c, shape = iso2c), method = "lm", se = FALSE, color = "black") +
  geom_point(data = df_sum, aes(x = mid_wgi, y = mid_cohesion_vertical)) +
  geom_text(data = df_sum, aes(x = mid_wgi, y = mid_cohesion_vertical, label = iso2c), color = "black") +
  geom_smooth(data = df_sum, method = lm, se = FALSE, aes(mid_wgi, y = mid_cohesion_vertical), color = "red") +
  labs(x = "Governance", y = "Vertical Cohesion", caption = round(cor(df_sum$mid_wgi, df_sum$mid_cohesion_vertical, use = "complete.obs"), 2))


set.seed(1234)

grid.arrange(fig_gini_h,fig_gini_v,
             fig_gdp_h,fig_gdp_v,
             fig_vdem_h,fig_vdem_v,
             fig_wdi_h,fig_wdi_v,
             fig_mig_h,fig_mig_v,
             nrow = 5, ncol=2,
 bottom =textGrob("Source: LAPOP (2004-2023); descriptive statistics; figure report country level pearson correlation; the line is the fitted values; CI at 95%",
 gp = gpar(fontface = 1, fontsize = 9),hjust = 1,x = 1
  ))
```

## Differences and changes in country level factors and social cohesión

```{r}
#| label: preparacion-datos
#| eval: false
datos_merge %>% group_by(pais,ola) %>% summarise(fe_etfra=mean(fe_etfra,na.rm=T))

# Separar los efectos
datos_merge <- datos_merge |>
  group_by(pais) |>
 mutate(pib_be = mean(log_pib_per_capita_ppa, na.rm=T),
         # gini_be = mean(gini_index, na.rm=T),
         gini_be = mean(wid_gini_disp, na.rm=T),
         mig_be = mean(percent_pob_migrante, na.rm=T),
         dem_be = mean(indice_v_dem, na.rm=T),
         wgi_be = mean(wgi, na.rm=T),
         edu_be = mean(edu_terciaria, na.rm=T)) |>
  ungroup() |>
  mutate(pib_we = log_pib_per_capita_ppa - pib_be,
          # gini_we = gini_index - gini_be,
          gini_we = wid_gini_disp - gini_be,
          mig_we = percent_pob_migrante - mig_be,
          dem_we = indice_v_dem - dem_be,
          wgi_we = wgi- wgi_be,
          edu_we = edu_terciaria-edu_be)

# Centrado y limpieza

z <- function(x) as.numeric(scale(x))

datos_fit <- datos_merge %>%
  mutate(
    # pib_we  = z(pib_we),   gini_we = z(gini_we), wgi_we = z(wgi_we), dem_we = z(dem_we),
    # mig_we  = z(mig_we),   edu_we = z(edu_we),
    # pib_be  = z(pib_be),   gini_be = z(gini_be), wgi_be = z(wgi_be), dem_be = z(dem_be),
    # mig_be  = z(mig_be),   edu_be = z(edu_be),
    edad_c = scale(edad) %>% as.numeric(),
    ola_s = as.numeric(scale(ola, center = TRUE, scale = TRUE)),
    ola,
    nivel_educ   = forcats::fct_drop(factor(nivel_educ)),
    pos_politica = forcats::fct_drop(factor(pos_politica)),
    sexo         = forcats::fct_drop(factor(sexo)),
    pais         = forcats::fct_drop(factor(pais)),
    country_wave = forcats::fct_drop(factor(country_wave)),

    # --- cambiar categoría de referencia ---
    nivel_educ   = forcats::fct_relevel(nivel_educ, "Tertiary"),   # ejemplo
    pos_politica = forcats::fct_relevel(pos_politica, "Not declared")         # ejemplo
  ) |>
  select(cohesion_general_ind, cohesion_vertical_ind, cohesion_horizontal_ind,
         nivel_educ, sexo, edad_c, ola_s, pos_politica,ola,
         pib_we, gini_we, dem_we, wgi_we, mig_we, edu_we,
         pib_be, gini_be, dem_be, wgi_be, mig_be, edu_be,
         country_wave, pais, wt) |>
  na.omit()

save(datos_fit, file="input/proc/datos-fit.rdata")
```

```{r}
#| eval: false

load("input/proc/datos-fit.rdata")

m0_ch = lmer(cohesion_horizontal_ind ~ 1 + (1 | country_wave) + (1 |pais), data=datos_fit, weights=wt)

icc(m0_ch, by_group=TRUE) # 2.3% y 5.6%

m0_cv = lmer(cohesion_vertical_ind ~ 1 + (1 | country_wave) + (1 |pais), data=datos_fit, weights=wt)

icc(m0_cv, by_group=TRUE) # 6.3% y 6.3%

m0_cs = lmer(cohesion_general_ind ~ 1 + (1 | country_wave) + (1 |pais), data=datos_fit, weights=wt)

icc(m0_cs, by_group=TRUE) # 4.9% y 7.5%

save(m0_ch, file="output/modelo_nulo_horizontal.rdata")
save(m0_cv, file="output/modelo_nulo_vertical.rdata")
save(m0_cs, file= "output/modelo_nulo_completo.rdata")

```


```{r}
#| label: modelos-nulos

load("output/modelo_nulo_horizontal.rdata")
load("output/modelo_nulo_vertical.rdata")
load( "output/modelo_nulo_completo.rdata")
```

```{r}
#| label: tbl-modelos-cohesion-micro
#| results: asis
#| cache: true
load("input/proc/datos-fit.rdata")
library(lme4)
library(texreg)

datos_fit$ola<- factor(datos_fit$ola)
micro_h <- lmer(cohesion_horizontal_ind ~ 1 + nivel_educ + sexo + edad_c + I(edad_c^2) + pos_politica + ola + (1 | country_wave) + (1 | pais), data= datos_fit, weights= wt)
micro_v <- lmer(cohesion_vertical_ind ~ 1 + nivel_educ + sexo + edad_c + I(edad_c^2) + pos_politica + ola + (1 | country_wave) + (1 | pais), data= datos_fit, weights= wt)

coef_names<- list("(Intercept)"="(Intercept)",        
"nivel_educPrimary" = "Primary",   
"nivel_educSecondary" = "Secondary", 
"sexoMale"="Male (ref.=Female)",            
"edad_c"="Age",              
"I(edad_c^2)"="Age2",         
"pos_politicaLeft"="Left",    
"pos_politicaCenter"="Center",  
"pos_politicaRight"="Right",
ola2006 = "2006",
ola2008 = "2008",
ola2010 = "2010",
ola2012 = "2012",
ola2014 = "2014",
ola2016 = "2016",
ola2018 = "2018",
ola2023 = "2023"
)   
            
# screenreg(c(micro_h,micro_v))
htmlreg(c(micro_h,micro_v),single.row = F,digits = 3,
       # file = "output/table000.html",
       groups = 
         list("Education (ref.=No education)"=2:3,
              "Political position (ref.=Undefined)"=7:9,
              "Time trend (ref.=2004)"=10:17),
        caption.above = T,
        caption = "Multilevel regression for individual level factors and social cohesion",
       custom.coef.map = coef_names,
       custom.header = list("Horizontal"=1,"Vertical"=2),
       custom.gof.rows = list("Controls"=c(rep("Yes",2))),include.loglik = FALSE,include.aic = FALSE,
       custom.gof.names = c(NA,NA,"Num. Country-wave","Num. Country","Var: Country-wave (Intercept)","Var: Country (Intercept)","Var: Residual")
)
```


```{r}
#| label: tbl-modelos-cohesion
#| results: asis
#| cache: true
load("input/proc/datos-fit.rdata")
library(lme4)
library(texreg)
library(dplyr)

datos_fit$ola<- factor(datos_fit$ola)
# Socioeconomic dimensions------------------------------------------------------
micro <- lmer(cohesion_horizontal_ind ~ 1 + nivel_educ + sexo + edad_c + I(edad_c^2) + pos_politica + ola + (1 | country_wave) + (1 | pais), data= datos_fit, weights= wt)
macro_gini <- update(micro,. ~ . + gini_be + gini_we)
macro_gdp <- update(micro,. ~ . + pib_be + pib_we)
macro_econ <- update(micro,. ~ . + gini_be+gini_we+pib_be+pib_we)
h_econ <- list(macro_gini,macro_gdp,macro_econ)

micro <- lmer(cohesion_vertical_ind ~ 1 + nivel_educ + sexo + edad_c + I(edad_c^2) + pos_politica + ola + (1 | country_wave) + (1 | pais), data= datos_fit, weights= wt)
macro_gini <- update(micro,. ~ . + gini_be + gini_we)
macro_gdp <- update(micro,. ~ . + pib_be + pib_we)
macro_econ <- update(micro,. ~ . + gini_be+gini_we+pib_be+pib_we)
v_econ <- list(macro_gini,macro_gdp,macro_econ)

#screenreg(c(h_econ,v_econ))

htmlreg(c(h_econ,v_econ),single.row = F,digits = 3,
#        file = "output/table001.html",
        caption.above = T,
        caption = "Multilevel regression for socioeconomic macro factors and social cohesion", 
          custom.coef.map = 
            list(
              gini_be ="Gini (BE)",
              gini_we ="Gini (WE)",
              pib_be = "GDP (BE)", 
              pib_we = "GDP (WE)",
              ola2006 = "Time (ref.= 2004) 2006",
              ola2008 = "2008",
              ola2010 = "2010",
              ola2012 = "2012",
              ola2014 = "2014",
              ola2016 = "2016",
              ola2018 = "2018",
              ola2023 = "2023"              
            ),custom.header = list("Horizontal"=1:3,"Vertical"=4:6),
          custom.gof.rows = 
            list(Controls=c("Yes","Yes","Yes","Yes","Yes","Yes"))
          )

# Political dimensions------------------------------------------------------
micro <- lmer(cohesion_horizontal_ind ~ 1 + nivel_educ + sexo + edad_c + I(edad_c^2) + pos_politica + ola + (1 | country_wave) + (1 | pais), data= datos_fit, weights= wt)
macro_dem <- update(micro,. ~ . + dem_be + dem_we)
macro_wgi <- update(micro,. ~ . + wgi_be + wgi_we)
macro_pol <- update(micro,. ~ . + dem_be+dem_we+wgi_be + wgi_we)
h_pol <- list(macro_dem,macro_wgi,macro_pol)

micro <- lmer(cohesion_vertical_ind ~ 1 + nivel_educ + sexo + edad_c + I(edad_c^2) + pos_politica + ola + (1 | country_wave) + (1 | pais), data= datos_fit, weights= wt)
macro_dem  <- update(micro,. ~ . + dem_be + dem_we)
macro_wgi <- update(micro,. ~ . + wgi_be + wgi_we)
macro_pol  <- update(micro,. ~ . + dem_be+dem_we+wgi_be + wgi_we)
v_pol <- list(macro_dem,macro_wgi,macro_pol)

# screenreg(c(h_pol,v_pol))
htmlreg(c(h_pol,v_pol),single.row = F,digits = 3,
        # file = "output/table002.html",
        caption.above = T,
        caption = "Multilevel regression for institutional macro factors and social cohesion", 
          custom.coef.map = 
            list(
              dem_be ="Democracy (BE)",
              dem_we ="Democracy (WE)",
              wgi_be = "Governace (BE)", 
              wgi_we = "Governace (WE)",
              ola2006 = "Time (ref.= 2004) 2006",
              ola2008 = "2008",
              ola2010 = "2010",
              ola2012 = "2012",
              ola2014 = "2014",
              ola2016 = "2016",
              ola2018 = "2018",
              ola2023 = "2023"                
            ),custom.header = list("Horizontal"=1:3,"Vertical"=4:6),
          custom.gof.rows = 
            list(Controls=c("Yes","Yes","Yes","Yes","Yes","Yes"))          
          )

# Demographic ------------------------------------------------------------------
micro <- lmer(cohesion_horizontal_ind ~ 1 + nivel_educ + sexo + edad_c + I(edad_c^2) + pos_politica + ola + (1 | country_wave) + (1 | pais), data= datos_fit, weights= wt)
macro_mig <- update(micro,. ~ . + mig_be + mig_we)
# macro_fra <- update(micro,. ~ . + fra_be + fra_we)
# macro_demo <- update(micro,. ~ . + mig_be+mig_we+fra_be + fra_we)
h_demo <- list(macro_mig)

micro <- lmer(cohesion_vertical_ind ~ 1 + nivel_educ + sexo + edad_c + I(edad_c^2) + pos_politica + ola + (1 | country_wave) + (1 | pais), data= datos_fit, weights= wt)
macro_mig <- update(micro,. ~ . + mig_be + mig_we)
# macro_fra <- update(micro,. ~ . + fra_be + fra_we)
# macro_demo <- update(micro,. ~ . + mig_be+mig_we+fra_be + fra_we)
v_demo <- list(macro_mig)

# screenreg(c(h_demo,v_demo))
htmlreg(c(h_demo,v_demo),single.row = F,digits = 3,
        # file = "output/table003.html",
        caption.above = T,
        caption = "Multilevel regression for demographic macro factors and social cohesion", 
          custom.coef.map = 
            list(mig_be ="Migration (BE)",
                 mig_we = "Migration (WE)",
              ola2006 = "Time (ref.= 2004) 2006",
              ola2008 = "2008",
              ola2010 = "2010",
              ola2012 = "2012",
              ola2014 = "2014",
              ola2016 = "2016",
              ola2018 = "2018",
              ola2023 = "2023"),
          ,custom.header = list("Horizontal"=1,"Vertical"=2),
          custom.gof.rows = 
            list(Controls=c("Yes","Yes"))          
          )
```

```{r}
# Full-------------------------------------------------------------------------
library(correlation)
corr_macro <- 
  correlation::correlation(
    dplyr::select(datos_fit,gini_be,gini_we,pib_be,pib_we,dem_be,dem_we,wgi_be,wgi_we,mig_be,mig_we)) 

display(summary(corr_macro),digits = 3,format = "markdown")

micro <- lmer(cohesion_horizontal_ind ~ 1 + nivel_educ + sexo + edad_c + I(edad_c^2) + pos_politica + ola + (1 | country_wave) + (1 | pais), data= datos_fit, weights= wt)
macro_econ <- update(micro,. ~ . + gini_be+gini_we+pib_be+pib_we)
macro_econ_polit <- update(macro_econ,. ~ . + gini_be+gini_we+pib_be+pib_we+dem_be+dem_we+wgi_be+wgi_we)
macro_econ_polit_dem <- update(macro_econ_polit,. ~ . + gini_be+gini_we+pib_be+pib_we+dem_be+dem_we+wgi_be+wgi_we+mig_be+mig_we)
macro_econ_polit_dem_time <- update(macro_econ_polit,. ~ . + gini_be+gini_we+pib_be+pib_we+dem_be+dem_we+wgi_be+wgi_we+mig_be+mig_we+as.numeric(ola)-ola)
macro_econ_polit_dem_re <- update(macro_econ_polit,. ~ . + gini_be+gini_we+pib_be+pib_we+dem_be+dem_we+wgi_be+wgi_we+mig_be+mig_we-ola + (1 | ola))

h_demo <- list(macro_econ,macro_econ_polit,macro_econ_polit_dem,macro_econ_polit_dem_time)
htmlreg(h_demo, file = "output/table004.html")

micro <- lmer(cohesion_vertical_ind ~ 1 + nivel_educ + sexo + edad_c + I(edad_c^2) + pos_politica + ola + (1 | country_wave) + (1 | pais), data= datos_fit, weights= wt)
macro_econ <- update(micro,. ~ . + gini_be+gini_we+pib_be+pib_we)
macro_econ_polit <- update(macro_econ,. ~ . + gini_be+gini_we+pib_be+pib_we+dem_be+dem_we+wgi_be+wgi_we)
macro_econ_polit_dem <- update(macro_econ_polit,. ~ . + gini_be+gini_we+pib_be+pib_we+dem_be+dem_we+wgi_be+wgi_we+mig_be+mig_we)
macro_econ_polit_dem_time <- update(macro_econ_polit,. ~ . + gini_be+gini_we+pib_be+pib_we+dem_be+dem_we+wgi_be+wgi_we+mig_be+mig_we+as.numeric(ola)-ola)
macro_econ_polit_dem_re <- update(macro_econ_polit,. ~ . + gini_be+gini_we+pib_be+pib_we+dem_be+dem_we+wgi_be+wgi_we+mig_be+mig_we-ola + (1 | ola))

v_demo <- list(macro_econ,macro_econ_polit,macro_econ_polit_dem,macro_econ_polit_dem_time)
htmlreg(v_demo, file = "output/table005.html")


micro <- lmer(cohesion_general_ind ~ 1 + nivel_educ + sexo + edad_c + I(edad_c^2) + pos_politica + ola + (1 | country_wave) + (1 | pais), data= datos_fit, weights= wt)
macro_econ <- update(micro,. ~ . + gini_be+gini_we+pib_be+pib_we)
macro_econ_polit <- update(macro_econ,. ~ . + gini_be+gini_we+pib_be+pib_we+dem_be+dem_we+wgi_be+wgi_we)
macro_econ_polit_dem <- update(macro_econ_polit,. ~ . + gini_be+gini_we+pib_be+pib_we+dem_be+dem_we+wgi_be+wgi_we+mig_be+mig_we)
macro_econ_polit_dem_time <- update(macro_econ_polit,. ~ . + gini_be+gini_we+pib_be+pib_we+dem_be+dem_we+wgi_be+wgi_we+mig_be+mig_we+as.numeric(ola)-ola)
macro_econ_polit_dem_re <- update(macro_econ_polit,. ~ . + gini_be+gini_we+pib_be+pib_we+dem_be+dem_we+wgi_be+wgi_we+mig_be+mig_we-ola + (1 | ola))

g_demo <- list(macro_econ,macro_econ_polit,macro_econ_polit_dem,macro_econ_polit_dem_time)
htmlreg(g_demo, file = "output/table006.html")
```

